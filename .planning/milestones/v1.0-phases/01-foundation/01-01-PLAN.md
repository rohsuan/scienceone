---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - .env.example
  - .env
  - .gitignore
  - prisma/schema.prisma
  - prisma/prisma.config.ts
  - prisma/seed.ts
  - src/generated/prisma/
  - src/lib/prisma.ts
  - src/lib/auth.ts
  - src/lib/auth-client.ts
  - src/lib/validations/auth.ts
  - src/app/api/auth/[...all]/route.ts
  - src/emails/verification.tsx
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
user_setup:
  - service: postgresql
    why: "Database for users, sessions, books, and all domain data"
    env_vars:
      - name: DATABASE_URL
        source: "Local Docker: docker run --name scienceone-db -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=scienceone -p 5432:5432 -d postgres:16 then use postgresql://postgres:postgres@localhost:5432/scienceone — OR use Neon free tier: https://neon.tech"
  - service: resend
    why: "Transactional email for verification and password reset"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (https://resend.com/api-keys) -> Create API Key"
  - service: google-oauth
    why: "Google sign-in alongside email+password (per user decision)"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Same location as GOOGLE_CLIENT_ID"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "OAuth 2.0 Client ID settings"

must_haves:
  truths:
    - "Next.js 16 app starts with `npm run dev` without errors"
    - "Prisma schema contains User, Session, Account, Verification, Book, Chapter, BookPrice, Purchase, Category, Download, and ReadingProgress models"
    - "Database migration runs successfully against PostgreSQL"
    - "Seed script populates test users, sample books, and chapters"
    - "Better Auth server config is initialized with email+password, Google OAuth, and email verification"
    - "Auth API route handler responds at /api/auth/*"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Full database schema (auth + domain tables)"
      contains: "model User"
    - path: "src/lib/auth.ts"
      provides: "Better Auth server configuration"
      contains: "betterAuth"
    - path: "src/lib/auth-client.ts"
      provides: "Better Auth client hooks"
      contains: "createAuthClient"
    - path: "src/lib/prisma.ts"
      provides: "Prisma singleton with Driver Adapter"
      contains: "PrismaPg"
    - path: "src/app/api/auth/[...all]/route.ts"
      provides: "Auth API catch-all route"
      exports: ["GET", "POST"]
    - path: "prisma/seed.ts"
      provides: "Database seed with test data"
      contains: "prisma"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/prisma.ts"
      via: "prismaAdapter import"
      pattern: "prismaAdapter.*prisma"
    - from: "src/app/api/auth/[...all]/route.ts"
      to: "src/lib/auth.ts"
      via: "toNextJsHandler(auth)"
      pattern: "toNextJsHandler"
    - from: "src/lib/prisma.ts"
      to: "prisma/schema.prisma"
      via: "PrismaClient from generated output path"
      pattern: "from.*generated/prisma"
---

<objective>
Set up the Next.js 16 project scaffold with Prisma 7 database schema, Better Auth configuration, and all backend infrastructure needed by subsequent plans.

Purpose: Every plan in Phase 1 (and every subsequent phase) depends on the project existing, the database schema being in place, and the auth server being configured. This plan creates that foundation.

Output: A running Next.js 16 app with full Prisma schema (auth + domain tables), Better Auth server/client config, auth API route, email templates, validation schemas, and a seed script with test data.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 16 project with all dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    .env.example
    .env
    .gitignore
  </files>
  <action>
    1. Create the Next.js 16 project:
       ```
       npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --yes
       ```
       NOTE: Run from the project root. If the directory is not empty, the CLI may prompt — use `--yes` to accept defaults. If it refuses because files exist, create in a temp dir and move files.

    2. Install production dependencies:
       ```
       npm install better-auth @prisma/client @prisma/adapter-pg pg dotenv resend @react-email/components react-hook-form @hookform/resolvers zod
       ```

    3. Install dev dependencies:
       ```
       npm install --save-dev prisma tsx @types/pg
       ```

    4. Create `.env.example` with all required environment variables (no real values):
       ```
       DATABASE_URL=postgresql://postgres:postgres@localhost:5432/scienceone
       BETTER_AUTH_SECRET=your-secret-here-generate-with-openssl-rand-base64-32
       BETTER_AUTH_URL=http://localhost:3000
       NEXT_PUBLIC_BETTER_AUTH_URL=http://localhost:3000
       RESEND_API_KEY=re_xxxxxxxxxxxx
       GOOGLE_CLIENT_ID=your-google-client-id
       GOOGLE_CLIENT_SECRET=your-google-client-secret
       ```

    5. Create `.env` as a copy of `.env.example` with the DATABASE_URL filled in for local development (postgresql://postgres:postgres@localhost:5432/scienceone). Generate a real BETTER_AUTH_SECRET using `openssl rand -base64 32`. Leave RESEND_API_KEY, GOOGLE_CLIENT_ID, and GOOGLE_CLIENT_SECRET as placeholders — these require user setup.

    6. Ensure `.gitignore` includes `.env` (not `.env.example`) and `src/generated/`.

    7. Verify the app starts: `npm run dev` should compile without errors. Kill after confirming.
  </action>
  <verify>
    - `npm run dev` starts without errors (check terminal output, then kill process)
    - `package.json` contains all listed dependencies
    - `.env.example` exists with all env var names
    - `.env` exists with DATABASE_URL and BETTER_AUTH_SECRET filled in
  </verify>
  <done>
    Next.js 16 app created with all dependencies installed, environment variables templated, and dev server starts cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Prisma 7, full schema, Better Auth, and seed script</name>
  <files>
    prisma/schema.prisma
    prisma/prisma.config.ts
    prisma/seed.ts
    src/generated/prisma/
    src/lib/prisma.ts
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/validations/auth.ts
    src/app/api/auth/[...all]/route.ts
    src/emails/verification.tsx
    package.json
  </files>
  <action>
    1. Initialize Prisma: `npx prisma init` — this creates `prisma/schema.prisma` and updates `.env`.

    2. Create `prisma/prisma.config.ts` (Prisma 7 config file):
       ```typescript
       import "dotenv/config";
       import { defineConfig, env } from "prisma/config";

       export default defineConfig({
         schema: "prisma/schema.prisma",
         migrations: { path: "prisma/migrations" },
         datasource: { url: env("DATABASE_URL") },
       });
       ```

    3. Write `prisma/schema.prisma` with the FULL schema from RESEARCH.md:
       - Generator: `provider = "prisma-client"`, `output = "../src/generated/prisma"`
       - Datasource: `provider = "postgresql"` (NO url field — Prisma 7 uses config file)
       - Better Auth tables: User (with `role` field, `@@map("users")`), Session (`@@map("sessions")`), Account (`@@map("accounts")`), Verification (`@@map("verifications")`)
       - Domain tables: Book, BookPrice, Chapter, Category, BookCategory, Purchase, Download, ReadingProgress — all exactly as documented in RESEARCH.md
       - All relations, indexes, and constraints as specified

    4. Create `src/lib/prisma.ts` — Prisma 7 singleton with PrismaPg Driver Adapter:
       ```typescript
       import { PrismaClient } from "@/generated/prisma";
       import { PrismaPg } from "@prisma/adapter-pg";

       const globalForPrisma = global as unknown as { prisma: PrismaClient };

       function createPrismaClient() {
         const adapter = new PrismaPg({ connectionString: process.env.DATABASE_URL! });
         return new PrismaClient({ adapter });
       }

       export const prisma = globalForPrisma.prisma ?? createPrismaClient();

       if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;

       export default prisma;
       ```

    5. Create `src/lib/auth.ts` — Better Auth server config:
       - Use `betterAuth` with `prismaAdapter(prisma, { provider: "postgresql" })`
       - Enable `emailAndPassword` with `requireEmailVerification: true`
       - Configure `emailVerification.sendVerificationEmail` to use Resend (fire-and-forget with `void`)
       - Configure `socialProviders.google` with env vars
       - Set `baseURL` from `process.env.BETTER_AUTH_URL`
       - Friendly error messages per user decision

    6. Create `src/lib/auth-client.ts` — Better Auth client hooks:
       ```typescript
       import { createAuthClient } from "better-auth/react";

       export const authClient = createAuthClient({
         baseURL: process.env.NEXT_PUBLIC_BETTER_AUTH_URL,
       });

       export const { signIn, signUp, signOut, useSession } = authClient;
       ```

    7. Create `src/lib/validations/auth.ts` — Zod schemas:
       - `signUpSchema`: name (min 2 chars), email (valid email), password (min 8 chars, at least 1 uppercase, 1 number)
       - `signInSchema`: email (valid email), password (min 1 char)
       - Export inferred types: `SignUpValues`, `SignInValues`

    8. Create `src/app/api/auth/[...all]/route.ts` — Better Auth API handler:
       ```typescript
       import { auth } from "@/lib/auth";
       import { toNextJsHandler } from "better-auth/next-js";

       export const { GET, POST } = toNextJsHandler(auth);
       ```

    9. Create `src/emails/verification.tsx` — React Email verification template:
       - Clean, academic-styled email with "Verify your ScienceOne account" heading
       - Greet user by name, explain what happens after verification
       - CTA button linking to the verification URL
       - Footer with "ScienceOne" branding

    10. Generate Prisma client: `npx prisma generate`

    11. Run migration (requires running PostgreSQL): `npx prisma migrate dev --name init`
        NOTE: If PostgreSQL is not running, the migration command will fail. The executor should note this clearly — the user may need to start Docker or set up Neon first per user_setup.

    12. Create `prisma/seed.ts`:
        - Create admin user: name "Admin", email "admin@scienceone.com", role "admin"
        - Create test user: name "Jane Reader", email "jane@example.com", role "user"
        - Create 3 sample books with categories:
          - "Introduction to Quantum Mechanics" (Physics, published, pay-per-book $29.99)
          - "Linear Algebra: Theory and Applications" (Mathematics, published, open access)
          - "Statistical Thermodynamics" (Physics, unpublished draft)
        - Create 2-3 chapters per book with placeholder content and one free preview chapter each
        - Create categories: "Physics", "Mathematics", "Chemistry", "Computer Science"
        NOTE: Seed script uses `prisma.$executeRawUnsafe` or `prisma.user.create` etc. — Better Auth manages password hashing via its own API, so seed users won't have passwords (they're test data for UI display, not login). Alternatively, use Better Auth's internal API to create seeded accounts if straightforward.

    13. Add seed command to `package.json`:
        ```json
        "prisma": { "seed": "tsx prisma/seed.ts" }
        ```

    14. Run seed: `npx prisma db seed`

  </action>
  <verify>
    - `npx prisma generate` succeeds without errors
    - `npx prisma migrate dev --name init` succeeds (if PostgreSQL available)
    - `npx prisma db seed` populates database with test data
    - `npm run dev` starts and `curl http://localhost:3000/api/auth/ok` returns a response (Better Auth health check)
    - `src/generated/prisma/` contains generated Prisma client
    - `src/lib/auth.ts` exports `auth` with emailAndPassword and Google provider configured
    - `src/lib/auth-client.ts` exports `signIn`, `signUp`, `signOut`, `useSession`
  </verify>
  <done>
    Prisma 7 schema with all auth and domain tables is migrated, seed data populated, Better Auth server and client configured with email+password + Google OAuth + email verification, auth API route responds, Zod validation schemas defined, and email template created.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts Next.js 16 without build errors
2. `npx prisma studio` opens and shows all models (User, Session, Account, Book, Chapter, etc.)
3. Database contains seeded users and books
4. `curl http://localhost:3000/api/auth/ok` returns a Better Auth response
5. TypeScript compiles without errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- Next.js 16 project with all dependencies runs cleanly
- Full Prisma schema covers both auth (Better Auth) and domain (books, chapters, purchases) tables
- Database is migrated and seeded with test data
- Better Auth is configured for email+password, Google OAuth, and email verification
- Auth API route handler is live at /api/auth/*
- All TypeScript types resolve correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
