---
phase: 03-catalog
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/lib/book-queries.ts
  - src/app/(main)/catalog/[slug]/page.tsx
  - src/app/(main)/catalog/[slug]/loading.tsx
  - src/app/(main)/catalog/[slug]/preview/page.tsx
  - src/components/catalog/TableOfContents.tsx
autonomous: false
requirements:
  - CAT-02
  - CAT-04
  - CAT-05

must_haves:
  truths:
    - "User can view a book detail page with cover image left, book info right (title, author+affiliation, categories, synopsis, TOC, ISBN, page count, dimensions)"
    - "Pricing is displayed subtly — small muted text for paid books, green badge for open access"
    - "Author section shows name and affiliation only — no photo, no full bio"
    - "Table of contents lists all chapters with their position numbers"
    - "User can read a free sample chapter at /catalog/[slug]/preview without authentication"
    - "Book detail page includes valid Schema.org Book JSON-LD structured data"
    - "Book detail page has proper Open Graph metadata via generateMetadata"
  artifacts:
    - path: "src/app/(main)/catalog/[slug]/page.tsx"
      provides: "Book detail page with JSON-LD and generateMetadata"
      min_lines: 60
    - path: "src/app/(main)/catalog/[slug]/preview/page.tsx"
      provides: "Public sample chapter preview page"
      min_lines: 30
    - path: "src/components/catalog/TableOfContents.tsx"
      provides: "Chapter list component for detail page"
      min_lines: 15
  key_links:
    - from: "src/app/(main)/catalog/[slug]/page.tsx"
      to: "src/lib/book-queries.ts"
      via: "getBookBySlug(slug)"
      pattern: "getBookBySlug"
    - from: "src/app/(main)/catalog/[slug]/page.tsx"
      to: "Schema.org JSON-LD"
      via: "script type=application/ld+json"
      pattern: "application/ld\\+json"
    - from: "src/app/(main)/catalog/[slug]/preview/page.tsx"
      to: "prisma chapter query"
      via: "getPreviewChapter(slug)"
      pattern: "getPreviewChapter|isFreePreview"
---

<objective>
Build book detail pages with Schema.org SEO and sample chapter preview.

Purpose: Complete the catalog experience — readers can view full book details, discover books via search engines, and read a free sample chapter to evaluate content quality.
Output: /catalog/[slug] detail page with two-column layout, JSON-LD structured data, generateMetadata, and /catalog/[slug]/preview sample chapter page.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-catalog/03-RESEARCH.md
@.planning/phases/03-catalog/03-01-SUMMARY.md

# Key existing files (created in 03-01)
@src/lib/book-queries.ts
@src/components/catalog/BookCoverImage.tsx
@src/components/catalog/CategoryBadge.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build book detail page with two-column layout, JSON-LD, and generateMetadata</name>
  <files>
    src/lib/book-queries.ts
    src/app/(main)/catalog/[slug]/page.tsx
    src/app/(main)/catalog/[slug]/loading.tsx
    src/components/catalog/TableOfContents.tsx
  </files>
  <action>
**1. Add query helpers to `src/lib/book-queries.ts`:**

- `getBookBySlug(slug: string)` — Queries `prisma.book.findUnique` with:
  - `where: { slug, isPublished: true }`
  - `include: { chapters: { orderBy: { position: 'asc' }, select: { id: true, title: true, slug: true, position: true, isFreePreview: true } }, categories: { include: { category: true } }, pricing: true }`
  - Returns book or null

- `getPreviewChapter(slug: string)` — Queries for the sample chapter:
  - First try: `prisma.chapter.findFirst` where `book.slug === slug AND book.isPublished === true AND isFreePreview === true`, ordered by `position: 'asc'`
  - Fallback: if no isFreePreview chapter found, get the chapter with `position === 1` for that book (per research recommendation)
  - Returns `{ chapter, book: { title, slug, authorName, pricing, isOpenAccess } }` or null
  - Include enough book info for the preview page header and upsell section

**2. Create `src/components/catalog/TableOfContents.tsx`:**
- Props: `chapters: { id: string; title: string; position: number; isFreePreview: boolean }[]`
- Renders a simple ordered list (`<ol>`) with chapter entries
- Each entry: position number + title as text (NOT links — Phase 4 browser reader will add chapter navigation)
- Free preview chapters get a small "Free" badge next to the title (use CategoryBadge or inline badge)
- Wrapped with a heading: "Table of Contents" in serif font
- Use shadcn Separator above the TOC section

**3. Create `src/app/(main)/catalog/[slug]/page.tsx`:**

Export `generateMetadata`:
- `params` is `Promise<{ slug: string }>` — await it
- Call `getBookBySlug(slug)` — if no book, return `{}`
- Return: `{ title: '${book.title} | ScienceOne', description: book.synopsis ?? undefined, openGraph: { title: book.title, description: book.synopsis, images: book.coverImage ? [book.coverImage] : [] } }`

Default export async server component:
- `params` is `Promise<{ slug: string }>` — await it
- Call `getBookBySlug(slug)` — if no book, call `notFound()` (NOT return notFound())
- **Layout: two-column on desktop (cover ~1/3 left, info ~2/3 right), single column on mobile (cover on top)**
  - Use `grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-8 lg:gap-12`

- **Left column (cover area):**
  - BookCoverImage component (reuse from 03-01) — larger size for detail page
  - Below cover: pricing section
    - If `isOpenAccess`: green Badge "Open Access"
    - Else if `pricing`: price in small muted text `$${pricing.amount}`
    - Below pricing: "Read Sample" link (Link to `/catalog/${book.slug}/preview`) styled as a secondary Button
    - If book has `printLink`: "Buy Print Edition" external link (small text, opens in new tab)

- **Right column (info area):**
  - Title: `<h1 className="heading-serif text-3xl md:text-4xl font-bold">`
  - Author line: `<p className="text-lg text-muted-foreground">{book.authorName}</p>` — name only per CONTEXT.md decision. If `authorBio` exists, show it as a one-liner below the name in smaller muted text (this serves as the "affiliation" line)
  - NO author photo — per CONTEXT.md locked decision
  - Category badges row using CategoryBadge component
  - Separator
  - Synopsis section: heading "About This Book" + `<p>` with synopsis text
  - Separator
  - TableOfContents component with chapters
  - Separator
  - Print metadata section (if any data exists): ISBN, page count, dimensions — displayed as a simple definition list or grid of label-value pairs in small muted text

- **JSON-LD structured data:**
  ```typescript
  const jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'Book',
    name: book.title,
    author: { '@type': 'Person', name: book.authorName },
    isbn: book.isbn ?? undefined,
    numberOfPages: book.pageCount ?? undefined,
    description: book.synopsis ?? undefined,
    publisher: { '@type': 'Organization', name: 'ScienceOne' },
    url: `${process.env.NEXT_PUBLIC_APP_URL ?? 'https://scienceone.com'}/catalog/${book.slug}`,
  }
  ```
  Render as: `<script type="application/ld+json" dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd).replace(/</g, '\\u003c') }} />`
  Place it inside the page component's return, NOT in head.

**4. Create `src/app/(main)/catalog/[slug]/loading.tsx`:**
- Skeleton matching the two-column layout: gray rectangle for cover (aspect-[2/3]) on left, 5-6 pulse bars on right for title/author/synopsis/TOC
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` completes without errors
- Book detail page renders correctly at /catalog/introduction-to-quantum-mechanics
- View page source: JSON-LD script tag present with correct Book schema
  </verify>
  <done>
- Book detail page shows cover left, info right on desktop; stacks on mobile
- Title, author name, author bio as one-liner, categories, synopsis, TOC, ISBN, page count, dimensions all displayed
- Pricing is subtle — small muted text for paid, green badge for open access
- No author photo displayed (per CONTEXT.md decision)
- JSON-LD with Schema.org Book type is present in page source
- generateMetadata provides title, description, and Open Graph tags
- "Read Sample" button links to preview page
- Loading skeleton shows during navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Build sample chapter preview page with upsell section</name>
  <files>
    src/app/(main)/catalog/[slug]/preview/page.tsx
  </files>
  <action>
**Create `src/app/(main)/catalog/[slug]/preview/page.tsx`:**

Export `generateMetadata`:
- Await `params` to get slug
- Fetch book via `getBookBySlug(slug)` (reuse the helper)
- Return: `{ title: 'Preview: ${book.title} | ScienceOne', description: 'Read a free sample chapter from ${book.title}' }`

Default export async server component:
- Await `params` to get slug
- Call `getPreviewChapter(slug)` — if null (no book or no chapters), call `notFound()`
- **Page structure:**

1. **Breadcrumb/context header:**
   - Small text above chapter: `Link to /catalog/${slug}` showing book title + "Sample Chapter" label
   - Author name in muted text

2. **Chapter content:**
   - Render `chapter.content` via `dangerouslySetInnerHTML={{ __html: chapter.content ?? '' }}`
   - Wrap in a `prose` container for typography (use Tailwind Typography if available, or manual prose styling: `max-w-none` + appropriate heading/paragraph styles)
   - Since chapter content is pre-rendered KaTeX HTML from Phase 2 ingest pipeline (trusted source), dangerouslySetInnerHTML is safe. Add a comment noting this.

3. **End-of-sample upsell section:**
   - Separator
   - A card-style block (not aggressive):
     - Heading: "Continue Reading"
     - Book title in serif
     - If `isOpenAccess`: "This book is free to read" with a link back to the book detail page (Phase 4 will add the full reader)
     - If paid: Show price subtly + "View Book Details" link to `/catalog/${slug}`
     - Style: `bg-muted/50 rounded-lg p-6 text-center` — understated, academic

4. **No auth check** — this route is publicly accessible per CAT-04 ("without an account or purchase")
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` completes without errors
- Preview page renders at /catalog/introduction-to-quantum-mechanics/preview showing "The Wave Function" chapter content
- Preview page renders at /catalog/linear-algebra-theory-and-applications/preview showing "Vector Spaces" chapter content
- No auth redirect occurs — page is fully public
  </verify>
  <done>
- Sample chapter preview renders pre-rendered HTML content from the database
- Page is publicly accessible without authentication
- Breadcrumb links back to the book detail page
- End-of-sample upsell section shows "Continue Reading" with book title and pricing
- generateMetadata provides preview-specific title and description
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify catalog, detail, and preview pages</name>
  <files>none — verification only</files>
  <action>
Human verifies the complete catalog and discovery experience built in Plans 03-01 and 03-02.

**What was built:** Catalog listing with filters/search, book detail pages with JSON-LD, and sample chapter preview.

**How to verify:**

1. **Catalog page:** Visit http://localhost:3000/catalog
   - Verify: 2 books visible (Quantum Mechanics and Linear Algebra); "Statistical Thermodynamics" is NOT shown (unpublished)
   - Verify: Book cards show cover placeholder, title, author, category badge, price/open-access indicator
   - Click "Physics" category filter — only Quantum Mechanics shows
   - Click "All" — both books return
   - Change sort to "Author A-Z" — verify order changes
   - Type "linear" in search — only Linear Algebra shows
   - Clear search — both books return
   - Check URL reflects filter/sort/search state

2. **Book detail page:** Click on "Introduction to Quantum Mechanics"
   - Verify: Cover on left, info on right (desktop) — classic two-column layout
   - Verify: Title in serif, author name, synopsis, table of contents (3 chapters), ISBN, page count, dimensions
   - Verify: Price shown subtly (small text, not dominant)
   - Verify: "Read Sample" button visible
   - View page source (Ctrl+U): search for "application/ld+json" — verify Schema.org Book data present with name, author, isbn

3. **Open access detail page:** Visit /catalog/linear-algebra-theory-and-applications
   - Verify: "Open Access" green badge instead of price
   - Verify: No price shown

4. **Sample preview:** Click "Read Sample" on either book
   - Verify: Chapter content renders (HTML from database)
   - Verify: Breadcrumb links back to book detail page
   - Verify: End-of-sample upsell section at bottom
   - Open in incognito window — verify no auth redirect (publicly accessible)

5. **Responsive:** Resize browser to mobile width
   - Catalog: single-column grid
   - Detail: cover stacks above info
  </action>
  <verify>Human confirms all 5 verification areas pass</verify>
  <done>User types "approved" — all catalog, detail, and preview pages verified working</done>
</task>

</tasks>

<verification>
1. /catalog renders published books in responsive grid with working filters, sort, and search
2. /catalog/[slug] renders book detail with cover-left/info-right layout, all metadata, and JSON-LD
3. /catalog/[slug]/preview renders sample chapter publicly without authentication
4. All pages have proper generateMetadata for SEO
5. JSON-LD passes structural validation (correct @context, @type, required fields)
6. Pricing display follows locked decision: subtle for paid, green badge for open access
7. Author section follows locked decision: name + affiliation only, no photo
</verification>

<success_criteria>
- Book detail page uses cover-left/info-right two-column layout (locked decision)
- Pricing is subtle and understated (locked decision)
- Author shows name + affiliation only, no photo (locked decision)
- Schema.org Book JSON-LD present in page source
- Sample preview accessible without authentication
- All pages have generateMetadata for SEO
- TypeScript builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-catalog/03-02-SUMMARY.md`
</output>
