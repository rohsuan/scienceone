---
phase: 03-catalog
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/book-queries.ts
  - next.config.ts
  - src/app/(main)/catalog/page.tsx
  - src/app/(main)/catalog/loading.tsx
  - src/components/catalog/BookCard.tsx
  - src/components/catalog/BookCoverImage.tsx
  - src/components/catalog/CategoryBadge.tsx
  - src/components/catalog/CatalogFilters.tsx
  - src/components/catalog/SearchInput.tsx
autonomous: true
requirements:
  - CAT-01
  - CAT-03

must_haves:
  truths:
    - "User can visit /catalog and see a grid of published books with cover images, titles, authors, categories, and pricing"
    - "User can filter books by category using pill-style category buttons; selecting a category shows only matching books"
    - "User can sort books by title, date, or author using a dropdown selector"
    - "User can type a search query and see results update live (debounced) matching title, author, or subject"
    - "Empty search results show a clear message with a link to clear the search"
  artifacts:
    - path: "src/lib/book-queries.ts"
      provides: "Prisma query helpers for catalog listing and filtering"
      exports: ["getPublishedBooks", "getCategories"]
    - path: "src/app/(main)/catalog/page.tsx"
      provides: "Server component catalog page reading searchParams"
      min_lines: 30
    - path: "src/components/catalog/BookCard.tsx"
      provides: "Book card component for catalog grid"
      min_lines: 20
    - path: "src/components/catalog/CatalogFilters.tsx"
      provides: "Client component for category filter and sort controls"
      min_lines: 20
    - path: "src/components/catalog/SearchInput.tsx"
      provides: "Client component with debounced search"
      min_lines: 15
  key_links:
    - from: "src/app/(main)/catalog/page.tsx"
      to: "src/lib/book-queries.ts"
      via: "getPublishedBooks(searchParams)"
      pattern: "getPublishedBooks"
    - from: "src/components/catalog/CatalogFilters.tsx"
      to: "URL searchParams"
      via: "router.replace() with URLSearchParams"
      pattern: "router\\.replace"
    - from: "src/components/catalog/SearchInput.tsx"
      to: "URL searchParams"
      via: "useDebouncedCallback updating URL"
      pattern: "useDebouncedCallback"
---

<objective>
Build the catalog listing page with category filtering, sorting, and live search.

Purpose: Deliver the primary book discovery experience — readers can browse, filter, and search the ScienceOne catalog from a single page.
Output: /catalog page with server-side Prisma queries driven by URL searchParams, client-side filter/sort/search components, and reusable BookCard + BookCoverImage components.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-catalog/03-RESEARCH.md

# Key existing files
@src/lib/prisma.ts
@src/app/(main)/layout.tsx
@src/components/layout/Header.tsx
@prisma/schema.prisma
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create book query helpers, install use-debounce, and configure next/image remotePatterns</name>
  <files>
    src/lib/book-queries.ts
    next.config.ts
  </files>
  <action>
**1. Install use-debounce:**
```bash
npm install use-debounce
```

**2. Create `src/lib/book-queries.ts`** with two server-side query helpers:

- `getPublishedBooks({ category?, sort?, q? })` — Queries `prisma.book.findMany` with:
  - `where: { isPublished: true }` always
  - If `category` param present: filter by `categories: { some: { category: { slug: category } } }`
  - If `q` param present: add `OR` clause searching `title`, `authorName`, and `categories.some.category.name` — all with `contains` + `mode: 'insensitive'`
  - `orderBy`: if sort is `'author'` → `{ authorName: 'asc' }`, if `'date'` → `{ createdAt: 'desc' }`, default → `{ title: 'asc' }`
  - `include: { categories: { include: { category: true } }, pricing: true }`
  - Returns the books array

- `getCategories()` — Queries `prisma.category.findMany({ orderBy: { name: 'asc' } })`. Returns all categories for the filter bar.

Import prisma from `@/lib/prisma`. Do NOT use `'use client'` — these are server-only helpers.

**3. Update `next.config.ts`** to add `images.remotePatterns` for R2 cover images:
```typescript
const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.r2.cloudflarestorage.com',
        pathname: '/**',
      },
    ],
  },
};
```

This allows `next/image` to optimize external cover images from R2 buckets.
  </action>
  <verify>
- `npm ls use-debounce` confirms installation
- `npx tsc --noEmit` passes (no TypeScript errors in book-queries.ts)
- next.config.ts has remotePatterns configured
  </verify>
  <done>
- book-queries.ts exports getPublishedBooks and getCategories with proper Prisma queries including category filter, multi-field search, and configurable sorting
- next.config.ts has R2 remotePatterns for cover images
- use-debounce is installed
  </done>
</task>

<task type="auto">
  <name>Task 2: Build catalog page with book grid, category filters, sort, search, and loading skeleton</name>
  <files>
    src/app/(main)/catalog/page.tsx
    src/app/(main)/catalog/loading.tsx
    src/components/catalog/BookCard.tsx
    src/components/catalog/BookCoverImage.tsx
    src/components/catalog/CategoryBadge.tsx
    src/components/catalog/CatalogFilters.tsx
    src/components/catalog/SearchInput.tsx
  </files>
  <action>
**1. Create `src/components/catalog/BookCoverImage.tsx`:**
- Props: `coverImage: string | null`, `title: string`, `className?: string`
- If `coverImage` is present: render `next/image` with `fill`, `object-cover`, `sizes="(max-width: 768px) 120px, 200px"`, wrapped in a relative div with `aspect-[2/3]`
- If `coverImage` is null: render a Tailwind placeholder div with a subtle gradient background (e.g., `bg-gradient-to-br from-primary/10 to-primary/20`) showing the first letter of the title centered in large serif text
- Always include proper alt text: `Cover of ${title}`

**2. Create `src/components/catalog/CategoryBadge.tsx`:**
- Props: `name: string`, `className?: string`
- Renders a shadcn `Badge` (variant="secondary") with the category name
- Small text, rounded-full style for pill appearance

**3. Create `src/components/catalog/BookCard.tsx`:**
- Props: book object (from getPublishedBooks return type — include id, slug, title, authorName, coverImage, isOpenAccess, categories, pricing)
- Renders as a shadcn `Card` wrapping a `Link` to `/catalog/${book.slug}`
- Layout: BookCoverImage at top (aspect-[2/3]), then below: title (serif, font-semibold, line-clamp-2), author name (text-sm text-muted-foreground), category badges row, and price line
- Price display: if `isOpenAccess` → green "Open Access" badge; else if `pricing` → `$XX.XX` in small muted text; else nothing
- Pricing is subtle per user decision — small text, not a prominent tag
- The entire card is clickable (Link wraps card content)

**4. Create `src/components/catalog/SearchInput.tsx`:**
- `'use client'` component
- Uses `useRouter`, `usePathname`, `useSearchParams` from next/navigation
- Uses `useDebouncedCallback` from `use-debounce` with 300ms delay
- Renders a shadcn `Input` with search icon (lucide Search) as a leading element
- `defaultValue` syncs from current `searchParams.get('q')` so value persists on page load
- On change: updates URL via `router.replace()` with `{ scroll: false }` — sets `q` param if term is non-empty, deletes it if empty
- Placeholder: "Search by title, author, or subject..."

**5. Create `src/components/catalog/CatalogFilters.tsx`:**
- `'use client'` component
- Props: `categories: { id: string; name: string; slug: string }[]`
- Uses `useRouter`, `usePathname`, `useSearchParams`
- **Category filter row:** Horizontal row of pill buttons — "All" button + one button per category. Active category gets `variant="default"`, inactive gets `variant="outline"`. Clicking a category sets `?category=slug` in URL via `router.replace()`. Clicking "All" removes the category param.
- **Sort selector:** A native `<select>` element (styled with Tailwind — `rounded-md border bg-background text-sm px-3 py-1.5`) with options: "Title A-Z" (value="title"), "Newest First" (value="date"), "Author A-Z" (value="author"). Default syncs from `searchParams.get('sort')`. On change: sets `?sort=value` in URL.
- Layout: category pills on the left, sort dropdown on the right, flex with gap between them. On mobile, stack vertically.

**6. Create `src/app/(main)/catalog/page.tsx`:**
- Async server component
- `searchParams` is `Promise<{ [key: string]: string | string[] | undefined }>` — MUST await it
- Extract `category`, `sort`, `q` from awaited searchParams (all as `string | undefined`, use `String()` coercion for safety)
- Call `getPublishedBooks({ category, sort, q })` and `getCategories()`
- Render structure:
  1. Page header: `<h1 className="heading-serif text-3xl font-bold">Catalog</h1>` (or "Browse Books")
  2. SearchInput wrapped in `<Suspense fallback={<div className="h-10" />}>` (required because useSearchParams)
  3. CatalogFilters (with categories prop) wrapped in `<Suspense>` (same reason — uses useSearchParams)
  4. Book grid: `grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6` mapping books to BookCard components
  5. Empty state: if books.length === 0, show "No books found" message with contextual help — if `q` is set, show "No books match your search" with a plain link to `/catalog` to clear. If category is set, show "No books in this category."
- Wrap content in a `max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8` container
- Add `generateMetadata` exporting: `title: 'Catalog | ScienceOne'`, `description: 'Browse our collection of STEM textbooks with mathematical formulas rendered for the web.'`

**7. Create `src/app/(main)/catalog/loading.tsx`:**
- Skeleton grid: 6 placeholder cards using `div` with `animate-pulse` — each with a gray rectangle (aspect-[2/3]) and 3 short gray bars below for title/author/price
- Same grid layout as the real catalog page
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` completes without errors (especially no "Missing Suspense boundary" errors)
- Catalog page renders at /catalog with book grid when dev server is running
  </verify>
  <done>
- /catalog shows a grid of published books (2 from seed data) with cover placeholders, titles, authors, category badges, and pricing
- Category filter pills work: clicking a category filters the grid, clicking "All" shows everything
- Sort dropdown reorders books by title, date, or author
- Search input live-filters books by title, author, or subject with 300ms debounce
- Empty state shows appropriate message when no results match
- Loading skeleton appears during navigation
- All filter/sort/search state is URL-driven (bookmarkable, shareable)
  </done>
</task>

</tasks>

<verification>
1. Visit /catalog — see grid of published books (2 books from seed: "Introduction to Quantum Mechanics" and "Linear Algebra: Theory and Applications"; book 3 "Statistical Thermodynamics" is unpublished and must NOT appear)
2. Click a category pill — grid filters to matching books only
3. Change sort to "Author A-Z" — books reorder
4. Type "quantum" in search — only quantum mechanics book shows
5. Type "nonexistent" — empty state appears with "No books match" message
6. Check URL — all state reflected in ?category=&sort=&q= params
7. Refresh page with params in URL — state restored correctly
</verification>

<success_criteria>
- Catalog page renders published books in a responsive grid (3 cols desktop, 2 tablet, 1 mobile)
- Category filtering, sorting, and search all work via URL searchParams
- Client filter components wrapped in Suspense (build passes)
- BookCard links to /catalog/[slug]
- use-debounce installed and working
- next/image remotePatterns configured for R2
</success_criteria>

<output>
After completion, create `.planning/phases/03-catalog/03-01-SUMMARY.md`
</output>
