---
phase: 08-reader-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/citation.ts
  - src/components/catalog/CitationExport.tsx
  - src/app/(main)/catalog/[slug]/page.tsx
  - src/components/admin/BookEditForm.tsx
  - src/lib/admin-actions.ts
autonomous: true
requirements: [ADM-07]

must_haves:
  truths:
    - "User can click a button on the book detail page and copy a BibTeX citation to clipboard"
    - "User can click a button on the book detail page and copy an APA citation to clipboard"
    - "BibTeX citation includes title, author, publisher, year, ISBN, and URL"
    - "APA citation is a formatted copy-pasteable string with author, year, title, publisher, and URL"
    - "Admin can set a book's publication year in the edit form"
  artifacts:
    - path: "src/lib/citation.ts"
      provides: "Pure citation formatting functions"
      exports: ["buildBibtex", "buildApa", "CitationData"]
    - path: "src/components/catalog/CitationExport.tsx"
      provides: "Client component with two copy buttons (BibTeX, APA)"
      min_lines: 25
    - path: "prisma/schema.prisma"
      provides: "publishYear Int? field on Book model"
      contains: "publishYear"
  key_links:
    - from: "src/app/(main)/catalog/[slug]/page.tsx"
      to: "src/components/catalog/CitationExport.tsx"
      via: "renders CitationExport with book data props"
      pattern: "CitationExport"
    - from: "src/components/catalog/CitationExport.tsx"
      to: "src/lib/citation.ts"
      via: "import buildBibtex, buildApa"
      pattern: "import.*buildBibtex.*buildApa.*from.*citation"
    - from: "src/lib/admin-actions.ts"
      to: "prisma.book.update"
      via: "publishYear field in updateBook data"
      pattern: "publishYear"
---

<objective>
Add academic citation export (BibTeX and APA) to the book detail page, with a publishYear schema field and admin form integration.

Purpose: Researchers visiting ScienceOne can copy properly formatted citations for their papers with a single click — the final academic polish feature.
Output: CitationExport component on book detail page, citation formatting library, publishYear schema field, admin form field for publication year.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reader-enhancements/08-RESEARCH.md
@.planning/phases/03-catalog/03-02-SUMMARY.md
@.planning/phases/07-admin-dashboard/07-02-SUMMARY.md
@prisma/schema.prisma
@src/app/(main)/catalog/[slug]/page.tsx
@src/lib/admin-actions.ts
@src/components/admin/BookEditForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, citation library, and CitationExport component on detail page</name>
  <files>
    prisma/schema.prisma
    src/lib/citation.ts
    src/components/catalog/CitationExport.tsx
    src/app/(main)/catalog/[slug]/page.tsx
  </files>
  <action>
1. Add `publishYear Int?` field to the Book model in `prisma/schema.prisma`, placing it after the `isOpenAccess` field:
   ```prisma
   publishYear  Int?       // Publication year for citation export; falls back to createdAt year
   ```
   Then create the migration with `--create-only` (DB is offline — same pattern as 01-01, 02-01, 07-01):
   ```bash
   npx prisma migrate dev --name add_publish_year --create-only
   ```
   Then regenerate the Prisma client:
   ```bash
   npx prisma generate
   ```

2. Create `src/lib/citation.ts` with:
   - `CitationData` interface: `{ title: string; authorName: string; isbn: string | null; slug: string; publishYear: number | null; createdAt: Date; }`
   - `resolveYear(data: CitationData): number` — returns `data.publishYear ?? new Date(data.createdAt).getFullYear()`
   - `buildCitationKey(authorName: string, year: number): string` — takes last word of author name, strips non-alphanumeric characters with `.replace(/[^a-zA-Z0-9]/g, "")`, appends year. Fallback to "unknown" if empty.
   - `buildBibtex(data: CitationData): string` — returns `@book{Key,\n  title = {...},\n  author = {...},\n  publisher = {ScienceOne},\n  year = {...},\n  isbn = {...},\n  url = {...}\n}`. Omit isbn line if null. URL uses `process.env.NEXT_PUBLIC_APP_URL ?? "https://scienceone.com"`.
   - `buildApa(data: CitationData): string` — returns `AuthorName. (Year). Title. ScienceOne. URL`. No ISBN in APA (APA 7th edition standard). Use author name as-is (do NOT attempt to parse into Last, First format — see research pitfall 3).
   - Export `CitationData`, `buildBibtex`, `buildApa`.

3. Create `src/components/catalog/CitationExport.tsx` as a `"use client"` component:
   - Props: `{ book: CitationData }`
   - State: `copiedFormat: "bibtex" | "apa" | null` (useState, resets to null after 2 seconds via setTimeout)
   - `copy(format)` async function: calls `buildBibtex` or `buildApa`, then `navigator.clipboard.writeText(text)`, then `toast.success("BibTeX citation copied")` or `toast.success("APA citation copied")`, then sets copiedFormat. Wrap in try/catch — on error call `toast.error("Copy failed — clipboard access denied")`.
   - Render: a `<div>` with heading "Cite This Book" (text-sm font-medium mb-2) and two `<Button variant="outline" size="sm">` buttons side by side in a `flex gap-2`. First button: ClipboardCopy icon + "Copy BibTeX" (or "Copied!" when copiedFormat === "bibtex"). Second button: same pattern for APA.
   - Import `ClipboardCopy` from `lucide-react`, `Button` from `@/components/ui/button`, `toast` from `sonner`.

4. Integrate `CitationExport` into `src/app/(main)/catalog/[slug]/page.tsx`:
   - Import `CitationExport` from `@/components/catalog/CitationExport` and `type { CitationData }` from `@/lib/citation`.
   - Place the component in the right column (info section), after the print metadata `<dl>` section (before the closing `</div>` of the right column). Add a `<Separator className="my-6" />` before it if there's content above, then render `<CitationExport book={citationData} />`.
   - Build `citationData` from the book object: `{ title: book.title, authorName: book.authorName, isbn: book.isbn, slug: book.slug, publishYear: book.publishYear, createdAt: book.createdAt }`. The `publishYear` field is available from the Prisma query (getBookBySlug already selects all Book fields).
  </action>
  <verify>
    Run `npx prisma generate` — should succeed.
    Run `npx tsc --noEmit` — should have no type errors.
    Run `npx next build` or `npx next lint` — should pass (if available).
    Verify `src/lib/citation.ts` exports buildBibtex and buildApa by inspection.
    Verify CitationExport component renders two buttons by inspection.
    Verify book detail page imports and renders CitationExport by inspection.
  </verify>
  <done>
    Book detail page at /catalog/[slug] renders a "Cite This Book" section with two buttons (Copy BibTeX, Copy APA).
    Clicking each button copies the formatted citation to clipboard and shows a sonner toast.
    BibTeX output includes @book{Key, title, author, publisher, year, isbn (when present), url}.
    APA output includes author, year, title, publisher, url.
    publishYear Int? field exists in schema with migration created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add publishYear to admin edit form and updateBook action</name>
  <files>
    src/lib/admin-actions.ts
    src/components/admin/BookEditForm.tsx
  </files>
  <action>
1. Update `bookUpdateSchema` in `src/lib/admin-actions.ts`:
   - Add `publishYear: z.number().int().positive().optional().nullable()` to the schema (same pattern as `pageCount`).

2. Update `updateBook` in `src/lib/admin-actions.ts`:
   - Add `publishYear: validated.publishYear ?? null,` to the `prisma.book.update` data object (in the same block as other book fields like `pageCount`).

3. Update `BookEditForm` in `src/components/admin/BookEditForm.tsx`:
   - Add `publishYear: book.publishYear ?? null,` to the `defaultValues` object.
   - Add a "Publication Year" number input in the Details tab, after the ISBN field and before the Page Count field. Use the same pattern as Page Count:
     ```tsx
     <div className="space-y-1.5">
       <Label htmlFor="publishYear">Publication Year</Label>
       <Input
         id="publishYear"
         type="number"
         {...register("publishYear", { valueAsNumber: true })}
         placeholder="e.g. 2024"
       />
     </div>
     ```
   This goes inside the existing `grid grid-cols-2 gap-4` grid in the Details tab.
  </action>
  <verify>
    Run `npx tsc --noEmit` — should have no type errors.
    Verify bookUpdateSchema includes publishYear field by reading admin-actions.ts.
    Verify BookEditForm renders a Publication Year input by reading BookEditForm.tsx.
    Verify updateBook passes publishYear to prisma.book.update by reading admin-actions.ts.
  </verify>
  <done>
    Admin can enter a publication year in the book edit form (Details tab).
    updateBook server action persists publishYear to the database.
    Publication year appears in the citation when set; falls back to createdAt year when null.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Prisma client regenerated: `@/generated/prisma/client` includes `publishYear` on Book type
3. Book detail page at /catalog/[slug] renders CitationExport component with Copy BibTeX and Copy APA buttons
4. Clicking Copy BibTeX copies valid @book{...} format to clipboard with title, author, publisher, year, isbn, url
5. Clicking Copy APA copies formatted "Author. (Year). Title. ScienceOne. URL" string to clipboard
6. Admin book edit form includes Publication Year number input in Details tab
7. Saving a book with publishYear persists the value and it appears in subsequent citation exports
</verification>

<success_criteria>
- Citation export buttons visible on book detail page
- BibTeX format includes all required fields (title, author, publisher, year, ISBN, URL)
- APA format is a correctly formatted, copy-pasteable string
- Copy action uses navigator.clipboard.writeText with sonner toast feedback
- publishYear field in Prisma schema with migration
- Admin edit form has Publication Year input
- All TypeScript checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-reader-enhancements/08-01-SUMMARY.md`
</output>
