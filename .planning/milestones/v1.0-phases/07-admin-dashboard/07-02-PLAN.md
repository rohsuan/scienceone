---
phase: 07-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/app/(admin)/admin/books/[bookId]/page.tsx
  - src/components/admin/BookEditForm.tsx
  - src/components/admin/CategorySelect.tsx
  - src/components/admin/ImageUploadField.tsx
  - src/lib/admin-actions.ts
  - src/lib/admin-queries.ts
  - src/app/api/admin/upload-url/route.ts
autonomous: true
requirements: [ADM-03, ADM-04]

must_haves:
  truths:
    - "Founder can navigate from book table to a book's edit page and see all metadata fields populated"
    - "Founder can edit title, slug, author name, ISBN, page count, dimensions, and print link and save changes"
    - "Founder can edit synopsis and author bio as plain text/Markdown in textarea fields and save"
    - "Founder can upload a cover image and author photo; images are stored in R2"
    - "Founder can assign categories to a book using a multi-select with inline category creation"
    - "Founder can set access model (open access vs paid) and price from the form"
    - "All changes are saved via a manual Save button (not auto-save)"
  artifacts:
    - path: "src/app/(admin)/admin/books/[bookId]/page.tsx"
      provides: "Book edit page with tabbed form"
      min_lines: 20
    - path: "src/components/admin/BookEditForm.tsx"
      provides: "React-hook-form metadata editor with tabs"
      min_lines: 80
    - path: "src/lib/admin-actions.ts"
      provides: "updateBook Server Action for all metadata fields"
      exports: ["updateBook"]
    - path: "src/app/api/admin/upload-url/route.ts"
      provides: "Presigned PUT URL endpoint for image uploads to R2"
      exports: ["POST"]
  key_links:
    - from: "src/components/admin/BookEditForm.tsx"
      to: "src/lib/admin-actions.ts"
      via: "updateBook Server Action call on Save"
      pattern: "updateBook"
    - from: "src/components/admin/ImageUploadField.tsx"
      to: "src/app/api/admin/upload-url/route.ts"
      via: "fetch POST for presigned URL, then XHR PUT to R2"
      pattern: "upload-url"
    - from: "src/app/(admin)/admin/books/[bookId]/page.tsx"
      to: "src/lib/admin-queries.ts"
      via: "getBookAdmin() server component fetch"
      pattern: "getBookAdmin"
---

<objective>
Build the complete book metadata editing form with all fields, image uploads, category management, and access model settings.

Purpose: Enable the founder to manage every aspect of a book's metadata from the browser — title, author info, synopsis, cover image, categories, pricing, and access model — with a manual save workflow. This is the core content management surface of the admin dashboard.

Output: Working /admin/books/[bookId] edit page with tabbed form, image upload via presigned R2 URLs, category multi-select, and save functionality.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-dashboard/07-RESEARCH.md
@.planning/phases/07-admin-dashboard/07-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/r2.ts
@src/lib/admin-queries.ts
@src/lib/admin-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create book edit page, admin queries, presigned URL endpoint, and image upload component</name>
  <files>
    src/app/(admin)/admin/books/[bookId]/page.tsx
    src/lib/admin-queries.ts
    src/app/api/admin/upload-url/route.ts
    src/components/admin/ImageUploadField.tsx
  </files>
  <action>
    **1. Add getBookAdmin to src/lib/admin-queries.ts:**
    ```typescript
    export async function getBookAdmin(bookId: string) {
      return prisma.book.findUnique({
        where: { id: bookId },
        include: {
          categories: { include: { category: true } },
          pricing: true,
          chapters: {
            orderBy: { position: "asc" },
            select: { id: true, title: true, slug: true, position: true },
          },
          _count: { select: { chapters: true } },
        },
      });
    }
    export type BookAdminDetail = NonNullable<Awaited<ReturnType<typeof getBookAdmin>>>;
    ```
    Also add:
    ```typescript
    export async function getAllCategories() {
      return prisma.category.findMany({ orderBy: { name: "asc" } });
    }
    ```

    **2. Create src/app/api/admin/upload-url/route.ts:**
    - POST handler that verifies admin role via auth.api.getSession
    - Accepts JSON body: `{ bookId: string, fileName: string, type: "cover" | "author" }`
    - Generates R2 key: `images/${bookId}/${type}-${Date.now()}.${extension}` (extract extension from fileName)
    - Uses `PutObjectCommand` + `getSignedUrl` from @aws-sdk/s3-request-presigner with `createR2Client()` from src/lib/r2.ts
    - Returns `{ uploadUrl: string, r2Key: string }`
    - Expiry: 3600 seconds (1 hour)
    - Import PutObjectCommand from @aws-sdk/client-s3 and getSignedUrl from @aws-sdk/s3-request-presigner

    **3. Create src/components/admin/ImageUploadField.tsx:**
    - `"use client"` component
    - Props: `{ label: string, currentUrl: string | null, onUpload: (r2Key: string) => void, bookId: string, type: "cover" | "author" }`
    - Shows current image if exists (small thumbnail), file input button
    - On file select: (1) POST to /api/admin/upload-url to get presigned URL, (2) PUT file to R2 via XHR, (3) call onUpload(r2Key) to update parent form state
    - Shows upload progress via Progress component from shadcn
    - Uses XHR (not fetch) for upload progress tracking — same pattern as research recommends
    - Accepts image types only (.jpg, .png, .webp)

    **4. Create src/app/(admin)/admin/books/[bookId]/page.tsx:**
    - Server component with admin role check (defense-in-depth)
    - Reads bookId from params (await params in Next.js 16)
    - Calls `getBookAdmin(bookId)` — if null, redirect to /admin
    - Calls `getAllCategories()` for the category selector
    - Renders page heading with book title and "Back to Books" link
    - Passes book data and categories to `<BookEditForm />`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - admin/books/[bookId]/page.tsx imports getBookAdmin and getAllCategories
    - upload-url route.ts checks admin role before generating presigned URL
    - ImageUploadField uses XHR for upload with progress tracking
  </verify>
  <done>
    Book edit page loads with data from Prisma. Presigned URL endpoint is ready for image uploads. ImageUploadField component handles the full upload-to-R2 flow with progress display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build the metadata edit form with tabs, category select, and save functionality</name>
  <files>
    src/components/admin/BookEditForm.tsx
    src/components/admin/CategorySelect.tsx
    src/lib/admin-actions.ts
  </files>
  <action>
    **1. Add updateBook and category actions to src/lib/admin-actions.ts:**
    - `updateBook(bookId: string, data: BookUpdateData)`: Updates book record with all fields (title, slug, authorName, authorBio, authorImage, synopsis, coverImage, isbn, pageCount, dimensions, printLink, isOpenAccess). Also updates pricing (upsert BookPrice with amount + currency). Also syncs categories (delete all BookCategory for this book, create new ones). Revalidates /admin, /admin/books/[bookId], /catalog, and /catalog/[slug].
    - `createCategory(name: string)`: Creates new category with auto-generated slug (kebab-case from name). Returns the new category. Revalidates /admin.
    - Define Zod schema `bookUpdateSchema` for validation covering all fields.

    **2. Create src/components/admin/CategorySelect.tsx:**
    - `"use client"` component
    - Props: `{ categories: Array<{id, name}>, selectedIds: string[], onChange: (ids: string[]) => void }`
    - Multi-select using a list of checkboxes inside a Popover/DropdownMenu, or a simpler pattern: a scrollable list of category badges with click-to-toggle
    - Inline creation: text input at bottom + "Add" button → calls createCategory server action → adds to selected
    - Use shadcn Badge for selected categories display, Button + Input for inline creation

    **3. Create src/components/admin/BookEditForm.tsx:**
    - `"use client"` component
    - Props: `{ book: BookAdminDetail, categories: Array<{id, name, slug}> }`
    - Uses react-hook-form with zodResolver for the bookUpdateSchema
    - **Tabbed layout using shadcn Tabs** (locked decision: tabbed sections):
      - **Details tab**: title (Input), slug (Input), authorName (Input), isbn (Input), pageCount (Input type=number), dimensions (Input), printLink (Input)
      - **Content tab**: coverImage (ImageUploadField), synopsis (Textarea — plain text/Markdown per locked decision), authorBio (Textarea — plain text/Markdown), authorImage (ImageUploadField)
      - **Publishing tab**: isOpenAccess (Switch — "Open Access"), price amount (Input type=number, disabled when isOpenAccess is true), CategorySelect for category assignment
    - Manual Save button at the bottom (locked decision: manual save, not auto-save)
    - On save: if images were uploaded, their R2 keys are already in form state from ImageUploadField onUpload callbacks. Call updateBook server action with all form data.
    - Use `useTransition` to show saving state on the button
    - Toast notification on success/error via sonner
    - Note: isPublished is NOT in the form — it's toggled from the table row actions or a separate button on this page. Keep it visible as a status Badge but don't make it a form field.
    - Display chapter count as read-only info (with link to ingest page for re-uploading)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - BookEditForm has Tabs with at least 3 TabsTrigger elements
    - updateBook server action validates admin role and updates book + pricing + categories
    - CategorySelect supports both selection and inline creation
    - Save button triggers updateBook with form data
  </verify>
  <done>
    Complete book metadata editing form with three tabs (Details, Content, Publishing). Cover and author images upload to R2 via presigned URLs. Categories are assignable with inline creation. Access model is toggleable. All changes saved via manual Save button with toast feedback.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/books/[bookId] — all tabs render with current book data populated
2. Edit title and save — toast confirms success, navigate back to table and see updated title
3. Upload a cover image — progress bar shows, image thumbnail updates after upload
4. Add a new category inline — category appears in the list and is selected
5. Toggle open access — price field disables when open access is on
6. Edit synopsis as Markdown text in textarea — saves correctly
7. Non-admin access to the edit page redirects to /
</verification>

<success_criteria>
- All ADM-03 metadata fields are editable: cover image, ISBN, author bio/photo, synopsis, categories/tags, table of contents (read-only display), print info, print purchase link
- ADM-04 access model (open access vs paid) is settable from the Publishing tab
- Manual save workflow works end-to-end with toast feedback
- Image uploads go to R2 via presigned URLs without passing through Next.js server body
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-dashboard/07-02-SUMMARY.md`
</output>
