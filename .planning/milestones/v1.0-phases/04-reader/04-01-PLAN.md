---
phase: 04-reader
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(reader)/layout.tsx
  - src/app/(reader)/read/[bookSlug]/layout.tsx
  - src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx
  - src/app/(reader)/read/[bookSlug]/page.tsx
  - src/lib/reader-queries.ts
  - src/components/reader/TocSidebar.tsx
  - src/components/reader/TocNavLink.tsx
  - src/components/reader/ReaderTopBar.tsx
  - src/components/reader/MobileTocDrawer.tsx
  - src/components/reader/ChapterNav.tsx
  - src/app/globals.css
  - package.json
autonomous: true
requirements: [READ-01, READ-02, READ-03]

must_haves:
  truths:
    - "User can open /read/book-slug/chapter-slug and see chapter content with correctly rendered KaTeX math — no layout shift, no client-side flash"
    - "User can navigate between chapters via a table of contents sidebar; the current chapter is visually highlighted"
    - "User can use prev/next chapter buttons at the bottom of each chapter to move between chapters"
    - "Reader layout is usable on mobile (375px) — sidebar becomes a Sheet drawer, text is readable, math overflows horizontally"
    - "Reader layout is usable on tablet (768px) — content area scales correctly, navigation is accessible"
    - "Opening /read/book-slug redirects to the first chapter of the book"
    - "Access control: open-access books are readable by anyone; paid books redirect non-purchasers to catalog detail page; free preview chapters of paid books are readable by anyone"
  artifacts:
    - path: "src/app/(reader)/layout.tsx"
      provides: "Reader route group layout — minimal chrome, no site header/footer"
    - path: "src/app/(reader)/read/[bookSlug]/layout.tsx"
      provides: "Book-level layout with ToC sidebar and top bar"
    - path: "src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx"
      provides: "Chapter content page with rendered math, access control, and chapter nav"
    - path: "src/app/(reader)/read/[bookSlug]/page.tsx"
      provides: "Book entry redirect to first chapter"
    - path: "src/lib/reader-queries.ts"
      provides: "Server-side query helpers for reader: getBookChapters, getChapter, hasPurchased"
    - path: "src/components/reader/TocSidebar.tsx"
      provides: "Chapter list with TocNavLink for active highlighting"
    - path: "src/components/reader/MobileTocDrawer.tsx"
      provides: "Sheet drawer for mobile ToC access"
    - path: "src/components/reader/ChapterNav.tsx"
      provides: "Prev/next chapter navigation buttons"
  key_links:
    - from: "src/app/(reader)/read/[bookSlug]/layout.tsx"
      to: "src/lib/reader-queries.ts"
      via: "getBookChapters(bookSlug)"
      pattern: "getBookChapters"
    - from: "src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx"
      to: "src/lib/reader-queries.ts"
      via: "getChapter(bookSlug, chapterSlug) and hasPurchased(userId, bookId)"
      pattern: "getChapter|hasPurchased"
    - from: "src/components/reader/TocNavLink.tsx"
      to: "useSelectedLayoutSegment"
      via: "Next.js hook comparing segment to chapter slug"
      pattern: "useSelectedLayoutSegment"
    - from: "src/components/reader/MobileTocDrawer.tsx"
      to: "src/components/reader/TocSidebar.tsx"
      via: "Sheet wrapping TocSidebar"
      pattern: "Sheet.*TocSidebar"
    - from: "src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx"
      to: "dangerouslySetInnerHTML"
      via: "Trusted pre-rendered chapter HTML from DB"
      pattern: "dangerouslySetInnerHTML"
---

<objective>
Build the complete browser reader experience: a dedicated reader layout at `/read/[bookSlug]/[chapterSlug]` with pre-rendered KaTeX math display, table of contents sidebar with active chapter highlighting, prev/next chapter navigation, mobile-responsive layout with Sheet drawer for ToC, and server-side access control.

Purpose: Deliver the core reading experience — users can open a book and read chapters in the browser with correctly rendered mathematical formulas, navigate between chapters, and use the reader on any device size.

Output: Functional reader at `/read/` route group with ToC sidebar, chapter rendering, mobile drawer, and access control.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reader/04-RESEARCH.md
@.planning/phases/03-catalog/03-02-SUMMARY.md
@src/lib/book-queries.ts
@src/app/layout.tsx
@src/app/(main)/layout.tsx
@src/app/(main)/dashboard/page.tsx
@prisma/schema.prisma
@src/app/globals.css
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install typography plugin, add shadcn Sheet, create reader queries and reader route group with layouts</name>
  <files>
    package.json
    src/app/globals.css
    src/lib/reader-queries.ts
    src/app/(reader)/layout.tsx
    src/app/(reader)/read/[bookSlug]/layout.tsx
    src/app/(reader)/read/[bookSlug]/page.tsx
    src/components/reader/TocSidebar.tsx
    src/components/reader/TocNavLink.tsx
    src/components/reader/ReaderTopBar.tsx
    src/components/reader/MobileTocDrawer.tsx
  </files>
  <action>
    **Step 1: Install @tailwindcss/typography and add Sheet component**

    ```bash
    npm install -D @tailwindcss/typography
    npx shadcn@canary add sheet
    ```

    Add the typography plugin to `src/app/globals.css` — insert `@plugin "@tailwindcss/typography";` after the existing `@import` statements at the top of the file (after `@import "shadcn/tailwind.css";` line).

    **Step 2: Create reader query helpers**

    Create `src/lib/reader-queries.ts` with three `React.cache`-wrapped functions:

    1. `getBookChapters(bookSlug: string)` — finds published book by slug, selects id, title, slug, isOpenAccess, and includes chapters (ordered by position asc) with id, title, slug, position, isFreePreview. Returns null if not found.

    2. `getChapter(bookSlug: string, chapterSlug: string)` — finds chapter by compound unique [bookId, slug] via a query that joins through the book slug. Must include the book relation (id, title, slug, isOpenAccess) and the chapter's content field. Use `prisma.chapter.findFirst` with `where: { slug: chapterSlug, book: { slug: bookSlug, isPublished: true } }` and include `book: { select: { id, title, slug, isOpenAccess } }`. Return the full chapter including content.

    3. `hasPurchased(userId: string, bookId: string)` — returns boolean. Use `prisma.purchase.findUnique({ where: { userId_bookId: { userId, bookId } } })` and return `!!result`.

    Import `cache` from "react", `prisma` from "@/lib/prisma".

    **Step 3: Create the (reader) route group layout**

    Create `src/app/(reader)/layout.tsx`:
    - This is a NESTED layout under the root `app/layout.tsx` — do NOT add `<html>` or `<body>` tags
    - Return a simple wrapper: `<div className="flex flex-col min-h-screen bg-white">{children}</div>`
    - This provides the reader shell without the site Header/Footer

    **Step 4: Create the book-level layout with ToC sidebar**

    Create `src/app/(reader)/read/[bookSlug]/layout.tsx`:
    - Async server component. Params is `Promise<{ bookSlug: string }>` — must await.
    - Fetch book+chapters via `getBookChapters(bookSlug)`. If null, call `notFound()`.
    - Get session via `auth.api.getSession({ headers: await headers() })` (for passing isAuthenticated to children — though layouts can't pass to pages, the layout uses it for its own rendering decisions).
    - Render the reader shell structure:

    ```tsx
    <div className="flex flex-col h-screen overflow-hidden">
      <ReaderTopBar bookTitle={book.title} bookSlug={bookSlug} chapters={book.chapters} />
      <div className="flex flex-1 overflow-hidden">
        <aside className="hidden lg:flex lg:w-64 xl:w-72 flex-col border-r border-border overflow-y-auto bg-muted/30">
          <TocSidebar chapters={book.chapters} bookSlug={bookSlug} />
        </aside>
        <main id="reader-content" className="flex-1 overflow-y-auto">
          {children}
        </main>
      </div>
    </div>
    ```

    **Step 5: Create the book entry redirect page**

    Create `src/app/(reader)/read/[bookSlug]/page.tsx`:
    - Async server component. Await params to get bookSlug.
    - Fetch book via `getBookChapters(bookSlug)`. If null or no chapters, `notFound()`.
    - Redirect to `/read/${bookSlug}/${book.chapters[0].slug}` (first chapter). Note: reading progress resume will be added in Plan 02.
    - Use `redirect()` from "next/navigation".

    **Step 6: Create TocSidebar (server component)**

    Create `src/components/reader/TocSidebar.tsx`:
    - Props: `chapters: Array<{ id, title, slug, position, isFreePreview }>`, `bookSlug: string`, `onNavigate?: () => void` (optional, for mobile drawer close)
    - Render a `<nav>` with `<ul>` listing each chapter as a `TocNavLink`:
      ```tsx
      <TocNavLink href={`/read/${bookSlug}/${chapter.slug}`} chapterSlug={chapter.slug} onNavigate={onNavigate}>
        <span className="text-xs text-muted-foreground mr-2">{chapter.position}.</span>
        {chapter.title}
      </TocNavLink>
      ```
    - Add padding: `px-3 py-4 space-y-1`

    Note: TocSidebar itself can be a server component only if onNavigate is not used. Since it's used in both server (aside) and client (MobileTocDrawer) contexts, make it a client component ("use client") to accept onNavigate callback.

    **Step 7: Create TocNavLink (client component)**

    Create `src/components/reader/TocNavLink.tsx`:
    - "use client"
    - Props: `href: string`, `chapterSlug: string`, `children: React.ReactNode`, `onNavigate?: () => void`
    - Use `useSelectedLayoutSegment()` from "next/navigation" to get the active segment
    - Compare `segment === chapterSlug` for active state
    - Render a `<Link>` with conditional classes:
      - Active: `bg-primary/10 text-primary font-medium`
      - Inactive: `text-muted-foreground hover:text-foreground hover:bg-muted`
    - Base classes: `block px-3 py-2 text-sm rounded-md transition-colors`
    - On click, if `onNavigate` provided, call it (for closing mobile drawer)

    **Step 8: Create ReaderTopBar (client component)**

    Create `src/components/reader/ReaderTopBar.tsx`:
    - "use client"
    - Props: `bookTitle: string`, `bookSlug: string`, `chapters: Array<{ id, title, slug, position, isFreePreview }>`
    - Render a top bar: `<header className="flex items-center h-12 px-4 border-b border-border bg-white flex-shrink-0">`
    - Left side: `MobileTocDrawer` (lg:hidden) + book title as `<Link href={"/catalog/" + bookSlug}>` with `font-serif text-sm truncate` classes and ArrowLeft icon from lucide-react
    - The book title link returns user to the catalog detail page

    **Step 9: Create MobileTocDrawer (client component)**

    Create `src/components/reader/MobileTocDrawer.tsx`:
    - "use client"
    - Props: `chapters`, `bookSlug`, `bookTitle` (same types as ToC)
    - Use shadcn `Sheet` component with `side="left"` and `className="w-72 p-0"`
    - `SheetTrigger` renders a hamburger `Menu` icon button with `lg:hidden`
    - `SheetContent` wraps `SheetHeader` (book title) + `TocSidebar` with `onNavigate={() => setOpen(false)}` to auto-close on chapter selection
    - State: `const [open, setOpen] = useState(false)` controlled Sheet

    **IMPORTANT implementation notes:**
    - shadcn canary CLI is required (already configured in project): `npx shadcn@canary add sheet`
    - Import Chapter type shape inline (not from Prisma client directly in client components) — define a `ChapterSummary` interface in TocSidebar or a shared types file
    - `useSelectedLayoutSegment()` MUST be called from a component rendered inside `[bookSlug]/layout.tsx` — it returns the `[chapterSlug]` value because that's one level below
    - The (reader) layout is nested under root layout — NOT a separate root layout. No `<html>/<body>` tags.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` — no type errors
    2. Run `npm run build` — build succeeds (or at minimum, no errors in the reader route files)
    3. Verify file structure: `ls -R src/app/\(reader\)/` shows layout.tsx, read/[bookSlug]/layout.tsx, read/[bookSlug]/page.tsx
    4. Verify components: `ls src/components/reader/` shows TocSidebar.tsx, TocNavLink.tsx, ReaderTopBar.tsx, MobileTocDrawer.tsx
    5. Verify typography plugin: `grep "@plugin" src/app/globals.css` shows @tailwindcss/typography
    6. Verify Sheet component: `ls src/components/ui/sheet.tsx` exists
  </verify>
  <done>
    Reader route group (reader) exists with layouts. Book-level layout renders ToC sidebar on desktop and Sheet drawer on mobile. TocNavLink highlights active chapter via useSelectedLayoutSegment. Book entry page redirects to first chapter. Reader queries file provides getBookChapters, getChapter, and hasPurchased. Typography plugin installed and configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build chapter content page with KaTeX rendering, access control, prev/next navigation, and responsive layout</name>
  <files>
    src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx
    src/components/reader/ChapterNav.tsx
  </files>
  <action>
    **Step 1: Create the chapter content page**

    Create `src/app/(reader)/read/[bookSlug]/[chapterSlug]/page.tsx`:

    - Async server component
    - Params: `Promise<{ bookSlug: string; chapterSlug: string }>` — must await
    - Import `auth` from "@/lib/auth", `headers` from "next/headers", `notFound` and `redirect` from "next/navigation"
    - Import `getChapter`, `getBookChapters`, `hasPurchased` from "@/lib/reader-queries"
    - Import `ChapterNav` from "@/components/reader/ChapterNav"

    **Access control logic (defense-in-depth):**
    ```typescript
    const session = await auth.api.getSession({ headers: await headers() });
    const chapter = await getChapter(bookSlug, chapterSlug);
    if (!chapter) notFound();

    const canRead =
      chapter.book.isOpenAccess ||
      chapter.isFreePreview ||
      (session ? await hasPurchased(session.user.id, chapter.book.id) : false);

    if (!canRead) {
      redirect(`/catalog/${chapter.book.slug}?access=required`);
    }
    ```

    **Chapter navigation data:**
    Fetch the book's chapter list via `getBookChapters(bookSlug)` (React.cache deduplicates with the layout call). Find current chapter index, derive prev/next chapter slugs for ChapterNav.

    **generateMetadata:**
    Export `generateMetadata` function that returns `{ title: "${chapter.title} — ${book.title} | ScienceOne" }`.

    **Page render:**
    ```tsx
    return (
      <div className="px-4 sm:px-6 lg:px-12 py-8 lg:py-12">
        {/* Chapter title */}
        <h1 className="font-serif text-2xl md:text-3xl font-bold mb-8 max-w-3xl mx-auto">
          {chapter.title}
        </h1>

        {/* Chapter content — pre-rendered KaTeX HTML (trusted) */}
        <article
          className="
            prose prose-slate max-w-3xl mx-auto
            [&_h1]:font-serif [&_h2]:font-serif [&_h3]:font-serif
            [&_p]:leading-relaxed
            [&_.katex-display]:overflow-x-auto
            [&_.katex-display]:overflow-y-hidden
            [&_.katex-display]:pb-2
          "
          dangerouslySetInnerHTML={{ __html: chapter.content ?? "" }}
        />

        {/* Prev/Next chapter navigation */}
        <ChapterNav
          bookSlug={bookSlug}
          chapters={book.chapters}
          currentChapterSlug={chapterSlug}
        />
      </div>
    );
    ```

    **Key implementation notes:**
    - Apply `[&_.katex-display]:overflow-x-auto` and `[&_.katex-display]:overflow-y-hidden` to prevent double-scrollbar bug (per research: apply to container, not .katex itself)
    - `prose prose-slate` from @tailwindcss/typography handles all typographic styling for the trusted HTML content
    - `max-w-3xl` (768px) content width for comfortable STEM reading with math equations
    - Do NOT use `prose-lg` — default prose size is better for math-heavy content on mobile

    **Step 2: Create ChapterNav component**

    Create `src/components/reader/ChapterNav.tsx`:
    - Server component (no "use client" needed — it's just links)
    - Props: `bookSlug: string`, `chapters: Array<{ slug, title, position }>`, `currentChapterSlug: string`
    - Find current index in chapters array
    - Derive `prevChapter` (index - 1) and `nextChapter` (index + 1), or null if at bounds
    - Render a navigation bar below the chapter content:
      ```tsx
      <nav className="max-w-3xl mx-auto mt-12 pt-6 border-t border-border flex items-center justify-between">
        {prevChapter ? (
          <Link href={`/read/${bookSlug}/${prevChapter.slug}`} className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors">
            <ChevronLeft className="h-4 w-4" />
            <div>
              <div className="text-xs text-muted-foreground">Previous</div>
              <div className="font-medium">{prevChapter.title}</div>
            </div>
          </Link>
        ) : <div />}
        {nextChapter ? (
          <Link href={`/read/${bookSlug}/${nextChapter.slug}`} className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors text-right">
            <div>
              <div className="text-xs text-muted-foreground">Next</div>
              <div className="font-medium">{nextChapter.title}</div>
            </div>
            <ChevronRight className="h-4 w-4" />
          </Link>
        ) : <div />}
      </nav>
      ```
    - Import ChevronLeft, ChevronRight from "lucide-react"
  </action>
  <verify>
    1. Run `npx tsc --noEmit` — no type errors
    2. Run `npm run build` — build succeeds
    3. Verify file exists: `ls src/app/\(reader\)/read/\[bookSlug\]/\[chapterSlug\]/page.tsx`
    4. Verify ChapterNav: `ls src/components/reader/ChapterNav.tsx`
    5. Grep for access control: `grep "canRead" src/app/\(reader\)/read/\[bookSlug\]/\[chapterSlug\]/page.tsx` returns matches
    6. Grep for KaTeX overflow fix: `grep "katex-display" src/app/\(reader\)/read/\[bookSlug\]/\[chapterSlug\]/page.tsx` returns matches
  </verify>
  <done>
    Chapter page renders pre-rendered KaTeX HTML via dangerouslySetInnerHTML with prose typography. KaTeX display math has overflow-x-auto on the container (not .katex itself). Access control enforces: open-access OR isFreePreview OR hasPurchased. Non-authorized users are redirected to catalog detail page. Prev/next chapter navigation renders below content. generateMetadata provides chapter-specific page title.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Route structure `/read/[bookSlug]/[chapterSlug]` resolves correctly (each chapter has its own URL per locked decision)
3. Reader layout does NOT include site Header/Footer — uses minimal reader chrome
4. ToC sidebar visible on desktop (lg+), Sheet drawer on mobile
5. `useSelectedLayoutSegment` highlights current chapter in ToC
6. KaTeX math renders correctly with no client-side flash (pre-rendered HTML + CSS from root layout)
7. Access control prevents unauthorized access to paid chapters
8. Typography plugin properly handles prose styling for chapter content
</verification>

<success_criteria>
- Reader route group (reader) with dedicated layout (no site header/footer)
- Chapter pages at /read/[bookSlug]/[chapterSlug] render pre-rendered KaTeX HTML correctly
- ToC sidebar shows all chapters with active chapter highlighted
- Mobile users access ToC via Sheet drawer
- Prev/next chapter navigation at bottom of each chapter
- Access control: open-access books readable by all, paid books require purchase (or free preview)
- Book entry (/read/[bookSlug]) redirects to first chapter
</success_criteria>

<output>
After completion, create `.planning/phases/04-reader/04-01-SUMMARY.md`
</output>
