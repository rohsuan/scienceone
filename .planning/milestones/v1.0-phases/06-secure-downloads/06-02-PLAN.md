---
phase: 06-secure-downloads
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/components/dashboard/LibraryBookCard.tsx
  - src/components/dashboard/MyLibrary.tsx
  - src/lib/purchase-queries.ts
  - src/app/(main)/dashboard/page.tsx
  - src/components/reader/ReaderTopBar.tsx
  - src/app/(reader)/read/[bookSlug]/layout.tsx
  - src/lib/reader-queries.ts
autonomous: false
requirements: [DL-01, DL-02]

must_haves:
  truths:
    - "My Library book cards show a download dropdown with PDF and EPUB options"
    - "Reader header shows a download dropdown with PDF and EPUB options"
    - "Download buttons in all three locations trigger the same presigned URL flow"
    - "Download buttons are hidden when no artifacts exist"
    - "End-to-end download flow works from detail page, library card, and reader header"
  artifacts:
    - path: "src/components/dashboard/LibraryBookCard.tsx"
      provides: "Library card with download dropdown"
      contains: "DownloadDropdown"
    - path: "src/components/reader/ReaderTopBar.tsx"
      provides: "Reader header with download dropdown"
      contains: "DownloadDropdown"
  key_links:
    - from: "src/components/dashboard/LibraryBookCard.tsx"
      to: "src/components/catalog/DownloadDropdown.tsx"
      via: "import and render with hasPdf/hasEpub booleans"
      pattern: "DownloadDropdown"
    - from: "src/components/reader/ReaderTopBar.tsx"
      to: "src/components/catalog/DownloadDropdown.tsx"
      via: "import and render with hasPdf/hasEpub booleans"
      pattern: "DownloadDropdown"
---

<objective>
Wire the DownloadDropdown component into My Library cards and the reader header, extending queries to provide artifact availability booleans. Verify the complete download flow end-to-end across all three placement locations.

Purpose: Completes the download button placement across all three locked-decision locations (detail page from Plan 01, library card and reader header in this plan) and verifies the entire flow works.

Output: Download buttons functional in all three locations; human-verified end-to-end flow.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-secure-downloads/06-RESEARCH.md
@.planning/phases/06-secure-downloads/06-01-SUMMARY.md
@src/components/dashboard/LibraryBookCard.tsx
@src/components/dashboard/MyLibrary.tsx
@src/components/reader/ReaderTopBar.tsx
@src/app/(reader)/read/[bookSlug]/layout.tsx
@src/lib/purchase-queries.ts
@src/lib/reader-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire download dropdown into Library cards and Reader header</name>
  <files>
    src/lib/purchase-queries.ts
    src/components/dashboard/LibraryBookCard.tsx
    src/components/dashboard/MyLibrary.tsx
    src/app/(main)/dashboard/page.tsx
    src/lib/reader-queries.ts
    src/components/reader/ReaderTopBar.tsx
    src/app/(reader)/read/[bookSlug]/layout.tsx
  </files>
  <action>
**1. Update `src/lib/purchase-queries.ts`** — Extend `getUserPurchases` to also select `pdfKey` and `epubKey` from the book relation. Add these two fields to the existing `book.select`:

```typescript
book: {
  select: {
    id: true,
    title: true,
    slug: true,
    authorName: true,
    coverImage: true,
    pdfKey: true,   // NEW — for download button visibility
    epubKey: true,  // NEW — for download button visibility
  },
},
```

**2. Update `src/components/dashboard/LibraryBookCard.tsx`** — Add DownloadDropdown to the card.

a. Update the `LibraryBookCardProps` interface to include `hasPdf` and `hasEpub` booleans:
```typescript
interface LibraryBookCardProps {
  book: {
    id: string;
    title: string;
    slug: string;
    authorName: string;
    coverImage: string | null;
  };
  purchasedAt: Date;
  hasPdf: boolean;
  hasEpub: boolean;
}
```

b. Import `DownloadDropdown` from `@/components/catalog/DownloadDropdown`.

c. The card currently wraps the entire card in a `<Link>`. Change the structure so the link wraps the cover and text, but the download dropdown is outside the link to avoid navigation when clicking download. Use a wrapper div instead:

```tsx
export default function LibraryBookCard({
  book,
  purchasedAt: _purchasedAt,
  hasPdf,
  hasEpub,
}: LibraryBookCardProps) {
  return (
    <Card className="overflow-hidden hover:shadow-md transition-shadow border border-border/50">
      <Link href={`/read/${book.slug}`} className="block group">
        <div className="relative overflow-hidden rounded-t-lg max-h-48">
          <BookCoverImage coverImage={book.coverImage} title={book.title} />
        </div>
        <CardContent className="p-4 pb-2">
          <h3 className="font-serif font-semibold text-sm line-clamp-2 text-foreground">
            {book.title}
          </h3>
          <p className="text-xs text-muted-foreground mt-1">{book.authorName}</p>
        </CardContent>
      </Link>
      {(hasPdf || hasEpub) && (
        <div className="px-4 pb-3">
          <DownloadDropdown
            bookSlug={book.slug}
            hasPdf={hasPdf}
            hasEpub={hasEpub}
            variant="ghost"
            size="sm"
          />
        </div>
      )}
    </Card>
  );
}
```

d. Keep `Link` and `Card` imports. Remove the wrapping `<Link>` from the outer level and restructure as shown above.

**3. Update `src/components/dashboard/MyLibrary.tsx`** — Pass `hasPdf` and `hasEpub` to LibraryBookCard. The purchases array now includes `book.pdfKey` and `book.epubKey` from the updated query. Pass them as booleans:

```tsx
<LibraryBookCard
  key={purchase.id}
  book={purchase.book}
  purchasedAt={purchase.createdAt}
  hasPdf={!!purchase.book.pdfKey}
  hasEpub={!!purchase.book.epubKey}
/>
```

The MyLibrary component receives purchases as a prop from the dashboard page. Since we updated `getUserPurchases` to include `pdfKey` and `epubKey`, the data flows through automatically. No other changes needed in MyLibrary besides updating the prop pass-through.

**4. Update `src/lib/reader-queries.ts`** — Extend `getBookChapters` to also select `pdfKey` and `epubKey`:

```typescript
export const getBookChapters = cache(async (bookSlug: string) => {
  const book = await prisma.book.findUnique({
    where: { slug: bookSlug, isPublished: true },
    select: {
      id: true,
      title: true,
      slug: true,
      isOpenAccess: true,
      pdfKey: true,   // NEW
      epubKey: true,  // NEW
      chapters: {
        orderBy: { position: "asc" },
        select: {
          id: true,
          title: true,
          slug: true,
          position: true,
          isFreePreview: true,
        },
      },
    },
  });
  return book ?? null;
});
```

**5. Update `src/app/(reader)/read/[bookSlug]/layout.tsx`** — Pass download availability to ReaderTopBar:

a. The layout already calls `getBookChapters(bookSlug)` which now returns `pdfKey` and `epubKey`.
b. Pass new props to `ReaderTopBar`:
```tsx
<ReaderTopBar
  bookTitle={book.title}
  bookSlug={bookSlug}
  chapters={book.chapters}
  hasPdf={!!book.pdfKey}
  hasEpub={!!book.epubKey}
/>
```

**6. Update `src/components/reader/ReaderTopBar.tsx`** — Add DownloadDropdown to the reader header.

a. Add `hasPdf` and `hasEpub` to the `ReaderTopBarProps` interface.
b. Import `DownloadDropdown` from `@/components/catalog/DownloadDropdown`.
c. Add the dropdown in the header, positioned on the right side. The current header has a single `<div className="flex items-center gap-2 flex-1 min-w-0">` for the left content. Add a right-side section:

```tsx
export default function ReaderTopBar({
  bookTitle,
  bookSlug,
  chapters,
  hasPdf,
  hasEpub,
}: ReaderTopBarProps) {
  return (
    <header className="flex items-center h-12 px-4 border-b border-border bg-white flex-shrink-0">
      <div className="flex items-center gap-2 flex-1 min-w-0">
        <MobileTocDrawer
          chapters={chapters}
          bookSlug={bookSlug}
          bookTitle={bookTitle}
        />
        <Link
          href={`/catalog/${bookSlug}`}
          className="flex items-center gap-1.5 text-muted-foreground hover:text-foreground transition-colors min-w-0"
        >
          <ArrowLeft className="h-4 w-4 flex-shrink-0" />
          <span className="font-serif text-sm truncate">{bookTitle}</span>
        </Link>
      </div>
      {(hasPdf || hasEpub) && (
        <DownloadDropdown
          bookSlug={bookSlug}
          hasPdf={hasPdf}
          hasEpub={hasEpub}
          variant="ghost"
          size="sm"
        />
      )}
    </header>
  );
}
```

The dropdown sits at the right edge of the header bar. Using `variant="ghost"` and `size="sm"` to keep it visually lightweight in the header.

**Important notes:**
- Never pass `pdfKey` or `epubKey` strings to client components — only pass booleans (`hasPdf`, `hasEpub`). The actual keys are only used server-side in the API route.
- The DownloadDropdown only renders if at least one format is available (already handles this internally with `if (!hasPdf && !hasEpub) return null`).
- The reader layout is a server component, so it can safely read `book.pdfKey`/`book.epubKey` and convert to booleans before passing to the client component.
  </action>
  <verify>
    - `npx next build` passes
    - `LibraryBookCard.tsx` imports and renders `DownloadDropdown`
    - `ReaderTopBar.tsx` imports and renders `DownloadDropdown`
    - `getUserPurchases` returns `pdfKey` and `epubKey` in book select
    - `getBookChapters` returns `pdfKey` and `epubKey`
    - No `pdfKey` or `epubKey` strings are passed to client components (only booleans)
  </verify>
  <done>
    - LibraryBookCard shows download dropdown with PDF/EPUB options when artifacts exist
    - ReaderTopBar shows download dropdown on the right side of the header
    - Queries extended to provide artifact availability data
    - Download buttons hidden when no artifacts exist
    - All three placement locations (detail page, library card, reader header) have download capability
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify download flow end-to-end</name>
  <files>none (verification only)</files>
  <action>
    Human verification of the complete download system built across Plans 01 and 02. Use Rodney to test in the browser:

    1. **Book detail page (purchased book):**
       - Navigate to a book detail page for a purchased book
       - Verify PDF and EPUB download buttons appear below the Read Now button
       - Click Download PDF — verify browser initiates a download (or shows a toast error if R2 is not configured)
       - Click Download EPUB — same verification

    2. **Book detail page (unpurchased book):**
       - Navigate to a book detail page for a book you have NOT purchased
       - Verify NO download buttons appear (only Buy button visible)

    3. **Book detail page (open-access book, logged in):**
       - Navigate to an open-access book detail page while logged in
       - Verify download buttons appear (open-access + session = download allowed)

    4. **Book detail page (unauthenticated):**
       - Log out and visit any book detail page
       - Verify NO download buttons appear

    5. **Print link location:**
       - On any book detail page with a printLink configured
       - Verify the "Buy Print Edition" link appears in the metadata section (near ISBN, Pages, Dimensions) in the right column
       - Verify it does NOT appear in the left column pricing area
       - Verify it opens in a new tab

    6. **My Library cards:**
       - Navigate to /dashboard
       - Verify each purchased book card shows a "Download" dropdown button
       - Click the dropdown — verify PDF and EPUB options appear
       - Click one — verify download initiates or toast error shows

    7. **Reader header:**
       - Open any book in the reader (/read/[bookSlug]/[chapter])
       - Verify a "Download" dropdown appears on the right side of the header bar
       - Click it — verify PDF and EPUB options appear
       - Click one — verify download initiates or toast error shows

    8. **Toast feedback:**
       - If R2 is not configured, clicking any download button should show a toast error (not a blank failure)
  </action>
  <verify>Human confirms all 8 verification items pass</verify>
  <done>All three download placement locations work correctly; print link is in metadata section; toast errors display on failure; download flow is end-to-end verified</done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds
2. Download buttons appear in all three locations: detail page, library card, reader header
3. Download buttons are hidden for unauthenticated users and unpurchased paid books
4. Print link is in the metadata section per locked decision
5. Download dropdown works correctly in compact placements
6. Toast errors display on download failure
</verification>

<success_criteria>
- All three download placement locations (detail page, library card, reader header) show download options per locked decision
- Download buttons hidden for unauthorized access attempts
- DownloadDropdown shows PDF and EPUB options in a compact menu
- Print link in metadata section, not pricing area
- Human verification confirms end-to-end flow works
</success_criteria>

<output>
After completion, create `.planning/phases/06-secure-downloads/06-02-SUMMARY.md`
</output>
