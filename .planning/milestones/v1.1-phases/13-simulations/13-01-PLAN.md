---
phase: 13-simulations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/simulation-keys.ts
  - src/lib/simulation-registry.ts
  - src/components/simulations/SimulationEmbed.tsx
  - src/app/(admin)/admin/resources/[resourceId]/page.tsx
  - src/simulations/ProjectileMotion.tsx
  - src/simulations/WaveInterference.tsx
  - src/simulations/SpringMass.tsx
autonomous: true
requirements:
  - SIM-01
  - SIM-02
  - SIM-03
  - SIM-04
  - SIM-05
  - SIM-06

must_haves:
  truths:
    - "The simulation gallery page at /simulations loads without server-side errors"
    - "Clicking a simulation card navigates to its detail page and the canvas renders without hydration or console errors"
    - "All three simulations are interactive — sliders change parameters and Play/Reset controls respond"
    - "The simulation canvas scales correctly on a 375px viewport and a 768px viewport — no hardcoded 600px"
    - "Teacher guide and parameter documentation text appears on each simulation detail page"
  artifacts:
    - path: "src/lib/simulation-keys.ts"
      provides: "Server-safe simulation key array"
      contains: "SIMULATION_KEYS"
    - path: "src/lib/simulation-registry.ts"
      provides: "Client-only simulation component registry using next/dynamic"
      contains: "next/dynamic"
    - path: "src/components/simulations/SimulationEmbed.tsx"
      provides: "Client component rendering simulation by key without Suspense wrapper"
      contains: "SIMULATION_REGISTRY"
    - path: "src/simulations/ProjectileMotion.tsx"
      provides: "Responsive projectile motion simulation"
      contains: "ResizeObserver"
    - path: "src/simulations/WaveInterference.tsx"
      provides: "Responsive wave interference simulation"
      contains: "ResizeObserver"
    - path: "src/simulations/SpringMass.tsx"
      provides: "Responsive spring-mass simulation"
      contains: "ResizeObserver"
  key_links:
    - from: "src/app/(admin)/admin/resources/[resourceId]/page.tsx"
      to: "src/lib/simulation-keys.ts"
      via: "import SIMULATION_KEYS"
      pattern: "from.*simulation-keys"
    - from: "src/components/simulations/SimulationEmbed.tsx"
      to: "src/lib/simulation-registry.ts"
      via: "import SIMULATION_REGISTRY"
      pattern: "from.*simulation-registry"
    - from: "src/lib/simulation-registry.ts"
      to: "src/simulations/ProjectileMotion.tsx"
      via: "next/dynamic import"
      pattern: "dynamic.*ProjectileMotion"
---

<objective>
Fix the React.lazy SSR bug that prevents simulation pages from loading, make all three simulation canvases responsive via ResizeObserver, and ensure simulation database records exist for end-to-end testing.

Purpose: The simulation registry uses React.lazy which causes server-side errors when the admin page imports SIMULATION_KEYS. Splitting into server-safe keys + client-only registry with next/dynamic unblocks both the admin and public simulation pages. Canvas responsiveness ensures simulations render correctly on all viewports.

Output: Working simulation gallery, detail pages, and three responsive interactive simulations.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-simulations/13-RESEARCH.md
@src/lib/simulation-registry.ts
@src/components/simulations/SimulationEmbed.tsx
@src/app/(admin)/admin/resources/[resourceId]/page.tsx
@src/simulations/ProjectileMotion.tsx
@src/simulations/WaveInterference.tsx
@src/simulations/SpringMass.tsx
@src/app/(main)/simulations/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split simulation registry into server-safe keys and client-only dynamic registry</name>
  <files>
    src/lib/simulation-keys.ts
    src/lib/simulation-registry.ts
    src/components/simulations/SimulationEmbed.tsx
    src/app/(admin)/admin/resources/[resourceId]/page.tsx
  </files>
  <action>
    **1. Create `src/lib/simulation-keys.ts`** (NEW file):
    ```typescript
    // Safe to import from Server Components — no dynamic imports
    export const SIMULATION_KEYS = [
      "projectile-motion",
      "wave-interference",
      "spring-mass",
    ] as const;
    ```

    **2. Rewrite `src/lib/simulation-registry.ts`** to use next/dynamic instead of React.lazy:
    ```typescript
    import dynamic from "next/dynamic";
    import type { ComponentType } from "react";

    // Only import this file from "use client" components
    export const SIMULATION_REGISTRY: Record<string, ComponentType> = {
      "projectile-motion": dynamic(
        () => import("@/simulations/ProjectileMotion"),
        { ssr: false, loading: () => <div className="aspect-[3/2] bg-muted animate-pulse rounded-lg" /> }
      ),
      "wave-interference": dynamic(
        () => import("@/simulations/WaveInterference"),
        { ssr: false, loading: () => <div className="aspect-[3/2] bg-muted animate-pulse rounded-lg" /> }
      ),
      "spring-mass": dynamic(
        () => import("@/simulations/SpringMass"),
        { ssr: false, loading: () => <div className="aspect-[3/2] bg-muted animate-pulse rounded-lg" /> }
      ),
    };
    ```
    Remove ALL React.lazy imports. Remove the old `SIMULATION_KEYS` export from this file.

    **3. Update `src/components/simulations/SimulationEmbed.tsx`**:
    - Remove the `Suspense` import and wrapper — next/dynamic handles its own loading state via the `loading` option
    - Keep the `"use client"` directive
    - Keep the `SIMULATION_REGISTRY` import from `@/lib/simulation-registry`
    - Render `<SimComponent />` directly without Suspense

    **4. Update `src/app/(admin)/admin/resources/[resourceId]/page.tsx`**:
    - Change import from `import { SIMULATION_KEYS } from "@/lib/simulation-registry"` to `import { SIMULATION_KEYS } from "@/lib/simulation-keys"`
    - This is the critical fix — the admin server component must not import the file with next/dynamic calls

    **Why:** React.lazy evaluates at module load time. The admin page is a Server Component that imports SIMULATION_KEYS from the same file, triggering React.lazy execution in a server context. Splitting into two files makes the admin import safe and the client-only registry uses next/dynamic with ssr: false.
  </action>
  <verify>
    Run `npx next build 2>&1 | head -80` — the build must not show errors related to simulation-registry, React.lazy, or dynamic imports. Specifically no "This module cannot be imported from a Server Component" errors.
  </verify>
  <done>
    simulation-registry.ts uses next/dynamic with ssr: false; simulation-keys.ts exports a plain string array; admin page imports from simulation-keys.ts; SimulationEmbed has no Suspense wrapper; the app builds without server-side errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make all three simulation canvases responsive via ResizeObserver</name>
  <files>
    src/simulations/ProjectileMotion.tsx
    src/simulations/WaveInterference.tsx
    src/simulations/SpringMass.tsx
  </files>
  <action>
    For each of the three simulation components, apply the ResizeObserver responsive canvas pattern:

    **Common pattern to add to each component:**

    1. Add a `containerRef = useRef<HTMLDivElement>(null)` for the wrapping div
    2. Add state: `const [canvasWidth, setCanvasWidth] = useState(600)`
    3. Compute height from width maintaining aspect ratio:
       - ProjectileMotion: `canvasHeight = Math.round(canvasWidth * (400 / 600))` (3:2 aspect)
       - WaveInterference: `canvasHeight = Math.round(canvasWidth * (400 / 600))` (3:2 aspect)
       - SpringMass: `canvasHeight = Math.round(canvasWidth * (300 / 600))` (2:1 aspect)
    4. Add ResizeObserver useEffect:
       ```typescript
       useEffect(() => {
         const container = containerRef.current;
         if (!container) return;
         const ro = new ResizeObserver((entries) => {
           const w = Math.round(entries[0].contentRect.width);
           if (w > 0) setCanvasWidth(w);
         });
         ro.observe(container);
         return () => ro.disconnect();
       }, []);
       ```
    5. Wrap the canvas in `<div ref={containerRef} className="w-full max-w-[600px]">` and set canvas `width={canvasWidth}` and `height={canvasHeight}`
    6. Remove old `const WIDTH = 600` and `const HEIGHT = ...` constants
    7. Update the `draw` function and all coordinate math to use `canvasWidth` and `canvasHeight` instead of the old constants

    **ProjectileMotion specifics:**
    - Replace `WIDTH` with `canvasWidth` in: clearRect, fillRect for ground, ground line, grid loops, grid lines
    - Replace `HEIGHT` with `canvasHeight` in: clearRect, ground fill height calculation
    - Recompute `GROUND_Y = canvasHeight - 40` inside draw or derive from canvasHeight
    - `SCALE` should scale proportionally: `const SCALE = canvasWidth / 150` (so objects scale with canvas)
    - Add `canvasWidth` and `canvasHeight` to the `draw` useCallback dependency array
    - Update `max-w-[600px]` on the slider grid to `max-w-[600px]` (keep for sliders, move from canvas to container)

    **WaveInterference specifics:**
    - Replace `WIDTH` and `HEIGHT` with `canvasWidth` and `canvasHeight` in: clearRect, fillRect, createImageData, the double for-loop bounds, cx/cy center calculations, imageData index calculation `(py * canvasWidth + px) * 4`
    - Source positions `s1x`, `s2x` are already relative to `cx = WIDTH/2`, so they will scale correctly
    - Add `canvasWidth` and `canvasHeight` to the `draw` useCallback dependency array

    **SpringMass specifics:**
    - Replace `WIDTH` with `canvasWidth` and `HEIGHT` with `canvasHeight`
    - `EQUILIBRIUM_Y = canvasHeight / 2` (was hardcoded 150, half of 300)
    - `ANCHOR_X = Math.round(canvasWidth * 50 / 600)` (scale anchor position proportionally)
    - Equilibrium position for mass: `ANCHOR_X + Math.round(canvasWidth * 200 / 600) + x`
    - Trail rendering: `const tx = canvasWidth - trail.length + i` (was `WIDTH - trail.length + i`)
    - Trail axis: `canvasWidth - MAX_TRAIL` to `canvasWidth`
    - `MAX_TRAIL` should scale: `Math.min(400, canvasWidth - 100)` so it doesn't exceed canvas width
    - Add `canvasWidth` and `canvasHeight` to draw useCallback dependency array

    **Important:** Remove `max-w-[600px]` from the canvas className itself. The container div has `max-w-[600px]` and the canvas should just be `w-full`. This ensures the canvas bitmap resolution matches its CSS display size exactly.
  </action>
  <verify>
    Start the dev server with `npm run dev`. Use Rodney to:
    1. Navigate to `/simulations` — confirm the gallery page loads
    2. Click on a simulation to verify the detail page loads with the canvas
    3. Resize the browser window to 375px width — confirm the canvas shrinks proportionally without clipping or distortion
    4. Resize to 768px width — confirm the canvas renders correctly at tablet size
    5. Check the browser console for any errors
  </verify>
  <done>
    All three simulation canvases use ResizeObserver to track container width; canvas width/height attributes are set dynamically; all coordinate math uses reactive dimensions; canvases render correctly at 375px, 768px, and desktop widths.
  </done>
</task>

<task type="auto">
  <name>Task 3: Seed simulation database records for end-to-end testing</name>
  <files>
    prisma/seed.ts
  </files>
  <action>
    Check if simulation records exist in the database. The three simulations need Resource records (type: SIMULATION, isPublished: true) with associated Simulation records (componentKey, teacherGuide, parameterDocs).

    **First, check existing data:**
    Run `npx prisma studio` or use a script to check if Resource records with type SIMULATION exist.

    **If records do NOT exist, create them via the admin UI or a seed script addition.**

    Add to the existing Prisma seed script (or create inline if no seed exists) — upsert three resources:

    1. **Projectile Motion**
       - slug: `projectile-motion-sim`
       - title: "Projectile Motion Simulator"
       - description: "Launch projectiles at different angles and velocities to explore parabolic trajectories. Adjust gravity to simulate different planetary environments."
       - type: SIMULATION
       - isPublished: true
       - Simulation: componentKey: `projectile-motion`
       - teacherGuide: "<h3>Learning Objectives</h3><ul><li>Understand the independence of horizontal and vertical motion</li><li>Explore the relationship between launch angle and range</li><li>Observe how gravity affects trajectory shape</li></ul><h3>Suggested Activities</h3><ol><li>Find the angle that maximizes range (should be 45 degrees)</li><li>Compare trajectories with the same speed but complementary angles (e.g., 30 and 60 degrees)</li><li>Set gravity to 1.6 m/s squared to simulate the Moon</li></ol>"
       - parameterDocs: "<ul><li><strong>Angle</strong> (5-85 degrees): Launch angle from horizontal</li><li><strong>Velocity</strong> (10-100 m/s): Initial launch speed</li><li><strong>Gravity</strong> (1.0-20.0 m/s squared): Gravitational acceleration</li></ul>"
       - Subject: Physics

    2. **Wave Interference**
       - slug: `wave-interference-sim`
       - title: "Wave Interference Pattern"
       - description: "Visualize constructive and destructive interference from two point sources. Adjust frequency, amplitude, and source separation."
       - type: SIMULATION
       - isPublished: true
       - Simulation: componentKey: `wave-interference`
       - teacherGuide: "<h3>Learning Objectives</h3><ul><li>Identify regions of constructive and destructive interference</li><li>Understand how wavelength and source separation affect fringe spacing</li><li>Connect the simulation to Young's double-slit experiment</li></ul><h3>Suggested Activities</h3><ol><li>Increase separation and observe how fringe spacing changes</li><li>Change frequency and note the effect on the pattern</li><li>Pause the simulation and trace nodal lines</li></ol>"
       - parameterDocs: "<ul><li><strong>Frequency</strong> (0.5-5.0 Hz): Wave oscillation rate</li><li><strong>Amplitude</strong> (10-60): Wave strength</li><li><strong>Separation</strong> (20-250 px): Distance between sources</li></ul>"
       - Subject: Physics

    3. **Spring-Mass System**
       - slug: `spring-mass-sim`
       - title: "Spring-Mass Oscillator"
       - description: "Explore simple harmonic motion with a damped spring-mass system. Observe displacement trails and adjust mass, spring constant, and damping."
       - type: SIMULATION
       - isPublished: true
       - Simulation: componentKey: `spring-mass`
       - teacherGuide: "<h3>Learning Objectives</h3><ul><li>Understand the relationship between mass, spring constant, and oscillation frequency</li><li>Observe the effect of damping on oscillation amplitude over time</li><li>Connect the displacement trail to a sinusoidal waveform</li></ul><h3>Suggested Activities</h3><ol><li>Set damping to 0 and observe perpetual motion</li><li>Double the mass and predict the new period before running</li><li>Increase damping until the system is overdamped (no oscillation)</li></ol>"
       - parameterDocs: "<ul><li><strong>Mass</strong> (0.5-5.0 kg): Mass of the block</li><li><strong>Spring k</strong> (1-50 N/m): Spring stiffness constant</li><li><strong>Damping</strong> (0.00-2.00): Damping coefficient</li></ul>"
       - Subject: Physics

    Each resource must be linked to the "Physics" subject via the ResourceSubject join table. Use `upsert` with slug as the unique key so the script is idempotent.

    **After seeding, verify:** Run the gallery page query to confirm three SIMULATION resources appear.
  </action>
  <verify>
    Run `npx tsx prisma/seed.ts` (or equivalent seed command) — no errors. Then start dev server and navigate to `/simulations` — all three simulation cards should appear. Click one and confirm the detail page shows the teacher guide and parameter docs sections.
  </verify>
  <done>
    Three simulation Resource records with associated Simulation records (componentKey, teacherGuide, parameterDocs) exist in the database, linked to the Physics subject, and appear on the /simulations gallery page.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors — no React.lazy or dynamic import server-side errors
2. `/simulations` gallery page loads and shows three simulation cards (projectile-motion, wave-interference, spring-mass)
3. Each simulation detail page loads without console errors or hydration mismatches
4. All three simulations are interactive: sliders change parameters, Play/Pause/Reset controls work
5. Canvas renders correctly at 375px, 768px, and full desktop width — no overflow, no hardcoded 600px
6. Teacher guide and parameter docs appear on each simulation detail page
7. Admin resource edit page at `/admin/resources/[id]` still loads without errors (SIMULATION_KEYS import fixed)
</verification>

<success_criteria>
- The simulation gallery page loads with subject filtering and displays all published simulations
- Clicking a simulation navigates to its detail page and the canvas renders without errors
- All three simulations have working interactive controls (sliders and Play/Reset)
- The canvas scales correctly on 375px (phone) and 768px (tablet) viewports
- Teacher guide and parameter documentation text appears on each simulation detail page
</success_criteria>

<output>
After completion, create `.planning/phases/13-simulations/13-01-SUMMARY.md`
</output>
