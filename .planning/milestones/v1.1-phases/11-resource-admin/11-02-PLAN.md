---
phase: 11-resource-admin
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/admin/ResourceTableColumns.tsx
autonomous: true
requirements: [RES-01]

must_haves:
  truths:
    - "Admin can toggle publish/unpublish on a resource from the table dropdown and sees a toast confirmation"
    - "Admin can delete a resource from the table dropdown with confirmation dialog and sees a toast confirmation"
    - "Publish toggle and delete show a pending/disabled state while the server action executes"
    - "If toggle or delete fails, a toast error is shown — no silent failures"
  artifacts:
    - path: "src/components/admin/ResourceTableColumns.tsx"
      provides: "ResourceRowActions component with useTransition + toast for publish and delete"
      contains: "useTransition"
  key_links:
    - from: "src/components/admin/ResourceTableColumns.tsx"
      to: "src/lib/resource-admin-actions.ts"
      via: "togglePublishResource and deleteResource calls wrapped in startTransition + try/catch + toast"
      pattern: "startTransition.*togglePublishResource"
---

<objective>
Extract table row actions into a proper React component with useTransition, toast feedback, and pending states so publish/unpublish and delete never fail silently.

Purpose: The current ResourceTableColumns.tsx calls `togglePublishResource` and `deleteResource` as fire-and-forget inside column cell render functions — no `await`, no `useTransition`, no `try/catch`, no toast. If the server action fails (DB error, auth error), the admin sees nothing. This violates the phase success criterion: "Admin can toggle publish/unpublish on a resource and see the status change reflected immediately in the table."

Output: ResourceTableColumns.tsx with a `ResourceRowActions` client component that wraps both publish toggle and delete in `useTransition` + `try/catch` + `toast`.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-resource-admin/11-RESEARCH.md
@src/components/admin/ResourceTableColumns.tsx
@src/lib/resource-admin-actions.ts
@src/lib/resource-admin-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract ResourceRowActions component with useTransition, toast, and pending states</name>
  <files>
    src/components/admin/ResourceTableColumns.tsx
  </files>
  <action>
    In `ResourceTableColumns.tsx`, create a new `ResourceRowActions` component ABOVE the `columns` export. This component will replace the inline actions cell render function.

    **Why a component:** The current actions cell is an inline function inside a ColumnDef `cell` property. Inline functions cannot use React hooks (`useTransition`, etc.). Extracting to a named component enables proper hook usage.

    **ResourceRowActions component:**

    ```tsx
    function ResourceRowActions({ resource }: { resource: ResourceAdminRow }) {
      const [isPending, startTransition] = useTransition();

      function handleTogglePublish() {
        startTransition(async () => {
          try {
            await togglePublishResource(resource.id, !resource.isPublished);
            toast.success(
              resource.isPublished ? "Resource unpublished" : "Resource published"
            );
          } catch {
            toast.error("Failed to update publish status");
          }
        });
      }

      function handleDelete() {
        startTransition(async () => {
          try {
            await deleteResource(resource.id);
            toast.success("Resource deleted");
          } catch {
            toast.error("Failed to delete resource");
          }
        });
      }

      return (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="sm" className="h-8 w-8 p-0" disabled={isPending}>
              <span className="sr-only">Open menu</span>
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem asChild>
              <Link href={`/admin/resources/${resource.id}`}>Edit</Link>
            </DropdownMenuItem>
            <DropdownMenuItem onClick={handleTogglePublish} disabled={isPending}>
              {resource.isPublished ? "Unpublish" : "Publish"}
            </DropdownMenuItem>
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <DropdownMenuItem
                  onSelect={(e) => e.preventDefault()}
                  className="text-destructive focus:text-destructive"
                >
                  Delete
                </DropdownMenuItem>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Delete resource?</AlertDialogTitle>
                  <AlertDialogDescription>
                    This will permanently delete &quot;{resource.title}&quot;.
                    This action cannot be undone.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancel</AlertDialogCancel>
                  <AlertDialogAction
                    onClick={handleDelete}
                    disabled={isPending}
                    className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                  >
                    {isPending ? "Deleting..." : "Delete"}
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </DropdownMenuContent>
        </DropdownMenu>
      );
    }
    ```

    **Add imports** at the top of the file:
    - `import { useTransition } from "react";`
    - `import { toast } from "sonner";`

    **Update the actions column** to use the new component:
    ```tsx
    {
      id: "actions",
      header: "",
      cell: ({ row }) => <ResourceRowActions resource={row.original} />,
    },
    ```

    This replaces the entire inline `cell` function that previously contained the fire-and-forget calls.

    **Key behaviors:**
    - `isPending` disables the dropdown trigger button (shows the admin something is happening)
    - `handleTogglePublish` shows "Resource published" / "Resource unpublished" toast on success, "Failed to update publish status" on error
    - `handleDelete` shows "Resource deleted" toast on success, "Failed to delete resource" on error
    - The AlertDialog confirmation still gates the delete action — no accidental deletes
    - The delete AlertDialogAction shows "Deleting..." text when isPending
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero errors. Verify that:
    1. `ResourceRowActions` is a named function component (not inline)
    2. It imports and uses `useTransition` from React
    3. It imports and uses `toast` from "sonner"
    4. `togglePublishResource` is called inside `startTransition` with try/catch + toast
    5. `deleteResource` is called inside `startTransition` with try/catch + toast
    6. The column `cell` property delegates to `<ResourceRowActions resource={row.original} />`
    7. `isPending` is used to disable the trigger button and delete action
  </verify>
  <done>
    Table row actions (publish toggle and delete) are wrapped in useTransition with try/catch and toast feedback. Admin sees success/error toasts, pending state disables the menu, and the AlertDialog delete confirmation still works. No silent failures.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ResourceTableColumns.tsx contains a `ResourceRowActions` component using `useTransition` and `toast`
3. Publish toggle wrapped in startTransition + try/catch + toast.success/toast.error
4. Delete wrapped in startTransition + try/catch + toast.success/toast.error
5. isPending disables the dropdown trigger and delete action button
6. No fire-and-forget server action calls remain in the file
</verification>

<success_criteria>
- Toggling publish on a resource shows a toast ("Resource published" / "Resource unpublished") and the table refreshes
- Deleting a resource shows a toast ("Resource deleted") and the row disappears from the table
- If a server action fails, the admin sees a toast error — never a silent failure
- The dropdown menu trigger and delete button show disabled state during pending actions
</success_criteria>

<output>
After completion, create `.planning/phases/11-resource-admin/11-02-SUMMARY.md`
</output>
