---
phase: 12-resource-public-purchase
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/resources/ResourceDownloadButton.tsx
  - src/app/(main)/resources/[slug]/page.tsx
  - src/lib/resource-queries.ts
autonomous: true
requirements:
  - RES-03
  - RES-04
  - RES-05
  - RES-09

must_haves:
  truths:
    - "Visitor can browse published resources and filter by subject, type, and level"
    - "Visitor can search resources by keyword and results update correctly"
    - "Clicking Download on a free resource triggers a presigned URL fetch and downloads the file"
    - "Purchased resources can be downloaded via the same download button"
    - "Buy button only appears when resource has active pricing"
  artifacts:
    - path: "src/components/resources/ResourceDownloadButton.tsx"
      provides: "Client-side download button that fetches presigned URL from API then redirects"
      min_lines: 25
    - path: "src/app/(main)/resources/[slug]/page.tsx"
      provides: "Detail page using ResourceDownloadButton instead of <a> link"
      contains: "ResourceDownloadButton"
    - path: "src/lib/resource-queries.ts"
      provides: "getResourceBySlug with isActive pricing filter"
      contains: "isActive"
  key_links:
    - from: "src/components/resources/ResourceDownloadButton.tsx"
      to: "/api/resource-download"
      via: "fetch call on click"
      pattern: "fetch.*api/resource-download"
    - from: "src/app/(main)/resources/[slug]/page.tsx"
      to: "src/components/resources/ResourceDownloadButton.tsx"
      via: "import and render in sidebar"
      pattern: "ResourceDownloadButton"
---

<objective>
Fix the resource download button to correctly fetch presigned URLs from the API (instead of navigating to raw JSON), filter pricing by isActive in the detail page query, and verify that listing, search, and filtering all work end-to-end.

Purpose: Visitors can browse, search, filter, and download resources without encountering the JSON-in-browser bug or seeing buy buttons for inactive pricing.
Output: Working ResourceDownloadButton component, corrected detail page, corrected query with isActive filter.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-resource-public-purchase/12-RESEARCH.md
@src/components/catalog/DownloadButton.tsx
@src/app/(main)/resources/[slug]/page.tsx
@src/lib/resource-queries.ts
@src/app/api/resource-download/route.ts
@src/components/resources/ResourceBuyButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResourceDownloadButton, fix detail page and pricing query</name>
  <files>
    src/components/resources/ResourceDownloadButton.tsx
    src/app/(main)/resources/[slug]/page.tsx
    src/lib/resource-queries.ts
  </files>
  <action>
    **1. Create `src/components/resources/ResourceDownloadButton.tsx`:**
    - "use client" component matching the book DownloadButton pattern in `src/components/catalog/DownloadButton.tsx`
    - Props: `{ resourceId: string; fileName?: string | null }`
    - State: `loading` boolean (useState)
    - On click: fetch `/api/resource-download?resourceId=${resourceId}`, check `res.ok`, parse `{ url }`, set `window.location.href = url`
    - Error handling: toast.error on non-ok response (show `data.error` from API) and on catch
    - Loading state: button disabled, text "Preparing download..."
    - Normal state: Download icon + "Download {fileName ?? 'File'}"
    - Use `Button` from `@/components/ui/button`, `Download` from lucide-react, `toast` from sonner
    - className="w-full" to match the sidebar layout

    **2. Update `src/app/(main)/resources/[slug]/page.tsx`:**
    - Import `ResourceDownloadButton` from `@/components/resources/ResourceDownloadButton`
    - Remove the `Button` import if no longer needed (check — it's still used for "Sign In to Purchase" link, so keep it)
    - Replace the download button block (lines 150-157):
      ```
      <Button className="w-full" asChild>
        <a href={`/api/resource-download?resourceId=${resource.id}`}>
          <Download className="h-4 w-4 mr-2" />
          Download {resource.fileName ?? "File"}
        </a>
      </Button>
      ```
      with:
      ```
      <ResourceDownloadButton
        resourceId={resource.id}
        fileName={resource.fileName}
      />
      ```
    - The `Download` lucide import can be removed from the page since ResourceDownloadButton handles its own icon. Keep it only if used elsewhere on the page (check: it's not — remove it).

    **3. Update `src/lib/resource-queries.ts` — `getResourceBySlug`:**
    - Change `pricing: true` to `pricing: { where: { isActive: true } }` in the include block
    - This ensures `resource.pricing` is null when no active pricing exists, so the buy button condition `!canAccess && resource.pricing` correctly hides the button for inactive pricing
    - Note: The listing query `getPublishedResources` also includes `pricing: true` — update it too for consistency: `pricing: { where: { isActive: true } }`

    **Why this matters:** The current `<a>` tag navigates to the API which returns JSON `{ url }` — the browser shows raw JSON instead of downloading. The client component correctly fetches the URL then redirects to it.
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors
    - `ResourceDownloadButton.tsx` exists and contains `fetch` + `window.location.href`
    - Detail page imports `ResourceDownloadButton`, no more `<a href="/api/resource-download"`
    - `resource-queries.ts` contains `isActive` in both query includes
  </verify>
  <done>
    - ResourceDownloadButton client component created with fetch-then-redirect pattern
    - Detail page uses ResourceDownloadButton instead of plain `<a>` link
    - Both resource queries filter pricing to active-only
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify resource listing, search, filtering, and download via Rodney</name>
  <files></files>
  <action>
    Use Rodney (the CLI browser testing tool) to verify the following flows on the dev server:

    **2a. Resource listing page:**
    - Navigate to `/resources`
    - Confirm the page loads without errors
    - Confirm resource cards appear in a grid (or "No resources available yet" if none exist)
    - Check that the search input and filter controls render

    **2b. Filtering:**
    - If resources exist, apply a subject filter — confirm the URL updates with `?subject=...` and results change
    - Apply a type filter — confirm URL updates with `?type=...`
    - Apply a level filter — confirm URL updates with `?level=...`
    - Remove all filters — confirm full list returns

    **2c. Search:**
    - Type a keyword in the search input — confirm URL updates with `?q=...` after debounce
    - Confirm matching resources appear (or "No resources match" empty state)
    - Clear search — confirm full list returns

    **2d. Free resource download (if a free resource exists):**
    - Navigate to a free resource detail page
    - Confirm "Free Resource" badge appears
    - Confirm download button appears (not a buy button)
    - Click the download button — confirm it shows "Preparing download..." loading state
    - Confirm the presigned URL is fetched (check network tab or that no JSON is shown in browser)

    If no test data exists (no resources in the database), note this in the verification output — the listing and empty states are still verifiable.
  </action>
  <verify>
    - Rodney confirms `/resources` loads without console errors
    - Rodney confirms filter controls render and update URL params
    - Rodney confirms search input updates URL params
    - Rodney confirms download button is a client component (not an `<a>` link)
  </verify>
  <done>
    - Resource listing page renders correctly with filters and search
    - Free resource download flow works end-to-end (no raw JSON in browser)
    - All filter combinations produce correct URL parameter updates
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `/resources` page loads with filters, search, and grid
3. Resource detail page shows ResourceDownloadButton (not `<a>` link)
4. Clicking download fetches presigned URL via client-side fetch, not browser navigation to JSON
5. Buy button only appears when `resource.pricing` is non-null (i.e., active pricing exists)
</verification>

<success_criteria>
- ResourceDownloadButton component exists and follows the book DownloadButton pattern
- Detail page no longer uses `<a href="/api/resource-download...">` — uses the client component
- Both getPublishedResources and getResourceBySlug filter pricing by isActive
- Listing page renders with working search and filter controls
</success_criteria>

<output>
After completion, create `.planning/phases/12-resource-public-purchase/12-01-SUMMARY.md`
</output>
