---
phase: 12-resource-public-purchase
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/resource-checkout-actions.ts
  - src/lib/checkout-actions.ts
  - src/app/api/webhooks/stripe/route.ts
autonomous: true
requirements:
  - RES-06
  - RES-07
  - RES-08

must_haves:
  truths:
    - "Paid resources display price and a purchase button"
    - "Clicking purchase on a paid resource redirects to Stripe Checkout"
    - "Stripe webhook routes by explicit productType metadata, not by ID presence"
    - "After payment, webhook creates a ResourcePurchase record for the user"
    - "Dead code (if !bookId inside bookId-truthy branch) is removed"
  artifacts:
    - path: "src/lib/resource-checkout-actions.ts"
      provides: "createResourceCheckoutSession with productType: 'resource' in metadata"
      contains: "productType"
    - path: "src/lib/checkout-actions.ts"
      provides: "createCheckoutSession with productType: 'book' in metadata"
      contains: "productType"
    - path: "src/app/api/webhooks/stripe/route.ts"
      provides: "Webhook handler routing by metadata.productType"
      contains: "productType"
  key_links:
    - from: "src/lib/resource-checkout-actions.ts"
      to: "stripe.checkout.sessions.create"
      via: "metadata.productType field"
      pattern: 'productType.*resource'
    - from: "src/lib/checkout-actions.ts"
      to: "stripe.checkout.sessions.create"
      via: "metadata.productType field"
      pattern: 'productType.*book'
    - from: "src/app/api/webhooks/stripe/route.ts"
      to: "prisma.resourcePurchase.upsert"
      via: "productType === 'resource' branch"
      pattern: 'productType.*===.*resource'
---

<objective>
Fix the Stripe webhook to route by explicit `productType` metadata instead of implicitly checking which ID fields are present. Add `productType` to both book and resource checkout session metadata. Remove dead code from the webhook.

Purpose: Eliminate the fragile ID-presence routing bug flagged as CRITICAL in STATE.md and ensure resource purchases are correctly recorded after Stripe payment.
Output: Explicit productType routing in webhook, consistent metadata in both checkout flows, no dead code.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-resource-public-purchase/12-RESEARCH.md
@src/lib/resource-checkout-actions.ts
@src/lib/checkout-actions.ts
@src/app/api/webhooks/stripe/route.ts
@src/components/resources/ResourceBuyButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add productType metadata and fix webhook routing</name>
  <files>
    src/lib/resource-checkout-actions.ts
    src/lib/checkout-actions.ts
    src/app/api/webhooks/stripe/route.ts
  </files>
  <action>
    **1. Update `src/lib/resource-checkout-actions.ts`:**
    - In the `stripe.checkout.sessions.create` call, add `productType: "resource"` to the `metadata` object
    - Current metadata (lines 58-62):
      ```
      metadata: {
        userId: session.user.id,
        resourceId: resource.id,
        resourceSlug: resource.slug,
        userEmail: session.user.email,
      },
      ```
    - Updated metadata:
      ```
      metadata: {
        productType: "resource",
        userId: session.user.id,
        resourceId: resource.id,
        resourceSlug: resource.slug,
        userEmail: session.user.email,
      },
      ```

    **2. Update `src/lib/checkout-actions.ts`:**
    - In the `stripe.checkout.sessions.create` call, add `productType: "book"` to the `metadata` object
    - Current metadata (lines 58-62):
      ```
      metadata: {
        userId: session.user.id,
        bookId: book.id,
        bookSlug: book.slug,
        userEmail: session.user.email,
      },
      ```
    - Updated metadata:
      ```
      metadata: {
        productType: "book",
        userId: session.user.id,
        bookId: book.id,
        bookSlug: book.slug,
        userEmail: session.user.email,
      },
      ```

    **3. Rewrite `src/app/api/webhooks/stripe/route.ts` routing logic:**
    - Replace the current routing (lines 37-130) that uses `if (resourceId && userId)` / `else if (bookId && userId)` with explicit `productType` routing:

    After extracting metadata from `session.metadata`, route like this:
    ```typescript
    const { productType, userId, bookId, bookSlug, userEmail, resourceId, resourceSlug } =
      session.metadata ?? {};

    if (productType === "resource" && resourceId && userId) {
      // ---- Resource purchase ---- (keep existing upsert + email logic, unchanged)
    } else if (productType === "book" && bookId && userId) {
      // ---- Book purchase ---- (keep existing upsert + email logic)
      // REMOVE the dead code block: `if (!bookId) { return ... }` (lines 82-86)
      // This check is inside a branch where bookId is guaranteed truthy — it's dead code
    } else {
      // Unknown or legacy productType — log warning, still return 200
      console.warn("Unrecognized productType in Stripe webhook metadata:", session.metadata);
    }
    ```

    **Key changes:**
    - Primary routing is now `productType === "resource"` / `productType === "book"` (explicit intent)
    - Secondary check still validates the required IDs exist (defensive)
    - Dead code block (`if (!bookId)` inside the bookId-truthy branch at lines 82-86) is REMOVED
    - Fallback logs a warning but returns 200 (per Stripe best practice — always acknowledge events)
    - No backward compatibility needed — no real users, clean cutover per research recommendation
  </action>
  <verify>
    - `npx tsc --noEmit` passes without errors
    - `resource-checkout-actions.ts` contains `productType: "resource"` in metadata
    - `checkout-actions.ts` contains `productType: "book"` in metadata
    - `webhooks/stripe/route.ts` contains `productType === "resource"` and `productType === "book"` routing
    - `webhooks/stripe/route.ts` does NOT contain `if (!bookId)` dead code
    - Grep for `productType` in all three files confirms presence
  </verify>
  <done>
    - Both checkout actions include productType in Stripe session metadata
    - Webhook routes by productType first, then validates required IDs
    - Dead code removed from book purchase branch
    - Unknown productType triggers console.warn but still returns 200
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify paid resource checkout flow and webhook via Rodney</name>
  <files></files>
  <action>
    Use Rodney (the CLI browser testing tool) to verify the following:

    **2a. Paid resource buy button:**
    - Navigate to a paid resource detail page (if one exists in the database)
    - Confirm the price is displayed and a "Buy" button appears
    - If the user is not logged in, confirm "Sign In to Purchase" button appears instead

    **2b. Checkout redirect:**
    - Log in as a test user
    - Navigate to a paid resource detail page
    - Click the buy button — confirm it shows "Redirecting to checkout..." and attempts to redirect to Stripe
    - Note: actual Stripe checkout cannot be completed in dev without test mode card — verify the redirect URL starts with `https://checkout.stripe.com`

    **2c. Success page:**
    - Navigate to `/purchase/resource-success` — without a valid session_id, confirm it shows 404 (correct behavior)

    **2d. Webhook code review:**
    - Confirm by reading `src/app/api/webhooks/stripe/route.ts` that:
      - Routing uses `productType === "resource"` (not `if (resourceId && userId)`)
      - Routing uses `productType === "book"` (not `else if (bookId && userId)`)
      - Dead code `if (!bookId)` block is removed
      - Fallback branch logs a warning

    If no paid test resources exist in the database, verify the buy button rendering by checking the code path logic rather than live testing.
  </action>
  <verify>
    - Rodney confirms paid resource detail page shows price and buy button
    - Rodney confirms checkout redirect initiates correctly
    - Code review confirms webhook routes by productType
    - Code review confirms dead code removed
  </verify>
  <done>
    - Paid resource purchase flow initiates correctly (price display, buy button, Stripe redirect)
    - Webhook routing uses explicit productType metadata
    - CRITICAL blocker from STATE.md ("Stripe webhook routes by ID presence") is resolved
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. Both checkout actions include `productType` in metadata
3. Webhook routes by `productType`, not by ID presence
4. Dead code (`if (!bookId)`) removed from webhook
5. Buy button appears for paid resources with active pricing
6. Checkout redirect works (initiates Stripe session)
</verification>

<success_criteria>
- `productType: "resource"` in resource checkout metadata
- `productType: "book"` in book checkout metadata
- Webhook handler uses `if (productType === "resource")` / `else if (productType === "book")` routing
- No `if (!bookId)` dead code remains
- STATE.md CRITICAL blocker about webhook routing is resolved
</success_criteria>

<output>
After completion, create `.planning/phases/12-resource-public-purchase/12-02-SUMMARY.md`
</output>
