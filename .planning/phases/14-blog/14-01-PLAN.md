---
phase: 14-blog
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/blog-admin-actions.ts
  - src/components/admin/BlogPostTableColumns.tsx
autonomous: true
requirements:
  - BLOG-01
  - BLOG-02

must_haves:
  truths:
    - "Admin can publish a blog post from the table and see a toast confirmation"
    - "Admin can unpublish a blog post from the table and see a toast confirmation"
    - "Admin can delete a blog post from the table and see a toast confirmation"
    - "Publishing a post revalidates the /blog/{slug} route so the detail page is immediately accessible"
    - "Re-publishing a previously published post preserves the original publishedAt date"
    - "The dropdown trigger is disabled while an action is in-flight"
  artifacts:
    - path: "src/lib/blog-admin-actions.ts"
      provides: "togglePublishBlogPost with slug revalidation and publishedAt clobber guard"
      contains: "revalidatePath.*blog/.*slug"
    - path: "src/components/admin/BlogPostTableColumns.tsx"
      provides: "BlogRowActions component with useTransition and toast"
      contains: "useTransition"
  key_links:
    - from: "src/components/admin/BlogPostTableColumns.tsx"
      to: "src/lib/blog-admin-actions.ts"
      via: "BlogRowActions calls togglePublishBlogPost and deleteBlogPost inside startTransition"
      pattern: "startTransition.*togglePublishBlogPost"
---

<objective>
Fix blog admin table actions and publish/unpublish server action bugs

Purpose: The blog admin table currently calls server actions directly without useTransition, providing no loading state, no disabled button, and no toast feedback. The togglePublishBlogPost action also fails to revalidate the blog detail page and clobbers the original publishedAt date on re-publish. Both bugs are blocking for admin workflow quality.

Output: BlogRowActions extracted component with useTransition/toast (matching ResourceRowActions pattern), and togglePublishBlogPost fixed with slug revalidation and publishedAt preservation.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-blog/14-RESEARCH.md

Reference pattern:
@src/components/admin/ResourceTableColumns.tsx (ResourceRowActions — the exact pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix togglePublishBlogPost server action</name>
  <files>src/lib/blog-admin-actions.ts</files>
  <action>
In `togglePublishBlogPost` function (line 94), apply two fixes:

1. **Slug revalidation**: Before the update, fetch the existing post's slug and publishedAt:
```typescript
const existing = await prisma.blogPost.findUnique({
  where: { id: postId },
  select: { slug: true, publishedAt: true },
});
```
After the update, add `revalidatePath("/blog/${existing.slug}")` (guarded by `if (existing?.slug)`).

2. **publishedAt clobber guard**: Change the publishedAt assignment from:
```typescript
publishedAt: publish ? new Date() : undefined,
```
to:
```typescript
publishedAt: publish && !existing?.publishedAt ? new Date() : undefined,
```
This only sets publishedAt on first publish. Re-publishing (where publishedAt already has a value) preserves the original date. Unpublishing leaves publishedAt untouched (undefined = no change in Prisma).

Do NOT change the other actions (createBlogPost, updateBlogPost, deleteBlogPost) — they are correct.
  </action>
  <verify>Read the modified function and confirm: (1) findUnique with select slug+publishedAt before update, (2) publishedAt conditional on `!existing?.publishedAt`, (3) revalidatePath includes `/blog/${existing.slug}`.</verify>
  <done>togglePublishBlogPost fetches slug before update, revalidates /blog/{slug}, and only sets publishedAt on first publish</done>
</task>

<task type="auto">
  <name>Task 2: Extract BlogRowActions with useTransition and toast</name>
  <files>src/components/admin/BlogPostTableColumns.tsx</files>
  <action>
Refactor BlogPostTableColumns.tsx to match the ResourceRowActions pattern from ResourceTableColumns.tsx exactly:

1. **Add imports**: Add `useTransition` from "react" and `toast` from "sonner" to the import block.

2. **Extract BlogRowActions component**: Create a named function component `BlogRowActions` that takes `{ post }: { post: BlogPostAdminRow }` and:
   - Calls `useTransition()` to get `[isPending, startTransition]`
   - Defines `handleTogglePublish()` wrapping `togglePublishBlogPost(post.id, !post.isPublished)` in `startTransition` with try/catch and `toast.success`/`toast.error`
   - Defines `handleDelete()` wrapping `deleteBlogPost(post.id)` in `startTransition` with try/catch and `toast.success`/`toast.error`
   - Returns the same DropdownMenu + AlertDialog JSX currently inline in the actions column, but with:
     - `disabled={isPending}` on the DropdownMenuTrigger Button
     - `onClick={handleTogglePublish}` and `disabled={isPending}` on the Publish/Unpublish DropdownMenuItem
     - `onClick={handleDelete}` and `disabled={isPending}` on the AlertDialogAction
     - `{isPending ? "Deleting..." : "Delete"}` as AlertDialogAction text

3. **Update the actions column**: Replace the inline cell function with:
```typescript
{
  id: "actions",
  header: "",
  cell: ({ row }) => <BlogRowActions post={row.original} />,
}
```

Toast messages:
- Publish: `toast.success("Post published")` / `toast.error("Failed to update publish status")`
- Unpublish: `toast.success("Post unpublished")`
- Delete: `toast.success("Post deleted")` / `toast.error("Failed to delete post")`

Match ResourceRowActions verbatim in structure. The only differences are entity name ("post" vs "resource"), action function names, and toast messages.
  </action>
  <verify>Read the modified file and confirm: (1) `useTransition` and `toast` are imported, (2) `BlogRowActions` function component exists above the columns export, (3) actions column cell renders `<BlogRowActions post={row.original} />`, (4) isPending disables the dropdown trigger and delete button.</verify>
  <done>BlogRowActions component extracted with useTransition, toast feedback on all actions, and disabled states during in-flight operations</done>
</task>

</tasks>

<verification>
1. `grep -n "useTransition" src/components/admin/BlogPostTableColumns.tsx` — confirms hook usage
2. `grep -n "toast" src/components/admin/BlogPostTableColumns.tsx` — confirms toast feedback
3. `grep -n "revalidatePath.*blog/" src/lib/blog-admin-actions.ts` — confirms slug revalidation
4. `grep -n "existing?.publishedAt" src/lib/blog-admin-actions.ts` — confirms clobber guard
5. `npx tsc --noEmit` — no type errors
</verification>

<success_criteria>
- BlogRowActions extracted as named component with useTransition + toast (matching ResourceRowActions)
- togglePublishBlogPost revalidates /blog/{slug} after toggle
- Re-publishing preserves original publishedAt date
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-blog/14-01-SUMMARY.md`
</output>
