---
phase: 15-polish-and-cross-linking
plan: 02
type: execute
wave: 2
depends_on:
  - "15-01"
files_modified:
  - src/lib/resource-queries.ts
  - src/lib/blog-queries.ts
  - src/app/(main)/blog/[slug]/page.tsx
  - src/app/(main)/resources/[slug]/page.tsx
  - src/app/(main)/simulations/[slug]/page.tsx
autonomous: true
requirements:
  - XLINK-01
  - XLINK-02
  - XLINK-03

must_haves:
  truths:
    - "A blog post detail page shows a Related Resources section when shared subjects exist"
    - "A resource detail page shows a Related Articles section when shared subjects exist"
    - "A simulation detail page shows Related Lab Guides when shared subjects exist"
    - "Cross-link sections do not appear when there are no related items"
    - "The current item never appears in its own related section"
  artifacts:
    - path: "src/lib/blog-queries.ts"
      provides: "getRelatedResources query function"
      exports: ["getRelatedResources"]
    - path: "src/lib/resource-queries.ts"
      provides: "getRelatedBlogPosts and getRelatedLabGuides query functions"
      exports: ["getRelatedBlogPosts", "getRelatedLabGuides"]
    - path: "src/app/(main)/blog/[slug]/page.tsx"
      provides: "Related Resources section on blog post detail"
      contains: "Related Resources"
    - path: "src/app/(main)/resources/[slug]/page.tsx"
      provides: "Related Articles section on resource detail"
      contains: "Related Articles"
    - path: "src/app/(main)/simulations/[slug]/page.tsx"
      provides: "Related Lab Guides section on simulation detail"
      contains: "Related Lab Guides"
  key_links:
    - from: "src/app/(main)/blog/[slug]/page.tsx"
      to: "src/lib/blog-queries.ts"
      via: "getRelatedResources called with post subject IDs"
      pattern: "getRelatedResources"
    - from: "src/app/(main)/resources/[slug]/page.tsx"
      to: "src/lib/resource-queries.ts"
      via: "getRelatedBlogPosts called with resource subject IDs"
      pattern: "getRelatedBlogPosts"
    - from: "src/app/(main)/simulations/[slug]/page.tsx"
      to: "src/lib/resource-queries.ts"
      via: "getRelatedLabGuides called with simulation subject IDs"
      pattern: "getRelatedLabGuides"
---

<objective>
Add subject-based cross-link sections to blog post, resource, and simulation detail pages so visitors discover related content across content types.

Purpose: Increase content discovery by surfacing resources/articles/lab guides that share subject tags with the current item.
Output: Three new query functions and cross-link UI sections on all three detail page types.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-polish-and-cross-linking/15-RESEARCH.md
@.planning/phases/15-polish-and-cross-linking/15-01-SUMMARY.md

@src/lib/resource-queries.ts
@src/lib/blog-queries.ts
@src/app/(main)/blog/[slug]/page.tsx
@src/app/(main)/resources/[slug]/page.tsx
@src/app/(main)/simulations/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-link query functions</name>
  <files>
    src/lib/blog-queries.ts
    src/lib/resource-queries.ts
  </files>
  <action>
**blog-queries.ts — add `getRelatedResources`:**

Add a new exported async function `getRelatedResources(subjectIds: string[], excludeId?: string, limit = 4)`. If `subjectIds.length === 0`, return `[]` early. Query `prisma.resource.findMany` with:
- `where`: `isPublished: true`, `type: { not: "SIMULATION" }` (exclude simulation-type resources from blog cross-links since simulations have their own pages), `subjects: { some: { subjectId: { in: subjectIds } } }`. If `excludeId` is provided, add `id: { not: excludeId }`.
- `take: limit`
- `orderBy: { viewCount: "desc" }`
- `select`: `id`, `slug`, `title`, `type`, `description`, `coverImage`, `isFree`

Note: Use `subjectId` on the join table FK directly (not `subject.id`) per research pitfall #5. The `excludeId` is optional because blog posts and resources have different models — there is no self-exclusion concern across types, but include it for future-proofing.

**resource-queries.ts — add `getRelatedBlogPosts`:**

Add a new exported async function `getRelatedBlogPosts(subjectIds: string[], limit = 4)`. If `subjectIds.length === 0`, return `[]` early. Query `prisma.blogPost.findMany` with:
- `where`: `isPublished: true`, `subjects: { some: { subjectId: { in: subjectIds } } }`
- `take: limit`
- `orderBy: { publishedAt: "desc" }`
- `select`: `id`, `slug`, `title`, `excerpt`, `coverImage`, `category`, `publishedAt`

**resource-queries.ts — add `getRelatedLabGuides`:**

Add a new exported async function `getRelatedLabGuides(subjectIds: string[], excludeResourceId?: string, limit = 4)`. If `subjectIds.length === 0`, return `[]` early. Query `prisma.resource.findMany` with:
- `where`: `isPublished: true`, `type: "LAB_GUIDE"`, `subjects: { some: { subjectId: { in: subjectIds } } }`. If `excludeResourceId` is provided, add `id: { not: excludeResourceId }`.
- `take: limit`
- `orderBy: { viewCount: "desc" }`
- `select`: `id`, `slug`, `title`, `description`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors in the query files.
  </verify>
  <done>
Three new query functions exist: `getRelatedResources` in blog-queries.ts, `getRelatedBlogPosts` and `getRelatedLabGuides` in resource-queries.ts. All filter by shared subject IDs, limit results, and exclude self where relevant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cross-link UI sections to detail pages</name>
  <files>
    src/app/(main)/blog/[slug]/page.tsx
    src/app/(main)/resources/[slug]/page.tsx
    src/app/(main)/simulations/[slug]/page.tsx
  </files>
  <action>
**blog/[slug]/page.tsx — Related Resources:**
1. Import `getRelatedResources` from `@/lib/blog-queries` and `Link` (already imported).
2. After fetching `post` (and the null/notFound check), extract subject IDs: `const subjectIds = post.subjects.map(({ subject }) => subject.id);`
3. Fetch related resources: `const relatedResources = subjectIds.length > 0 ? await getRelatedResources(subjectIds) : [];`
4. After the existing subject tags section (the last `</>` before the closing `</div>`), render a "Related Resources" section, guarded by `relatedResources.length > 0`:
   - A `<Separator className="my-8" />`
   - `<section>` with `<h2 className="font-serif text-xl font-semibold mb-4">Related Resources</h2>`
   - A `<div className="grid grid-cols-1 sm:grid-cols-2 gap-4">` containing cards for each resource.
   - Each card is a `<Link href={/resources/${r.slug}}` with a border, rounded corners, padding, and hover effect. Show the resource title as a semibold heading and description as muted text (line-clamped to 2 lines). Show a small type badge (e.g., "Lab Guide", "Problem Set") using the existing TYPE_LABELS pattern — import or inline a small map for the labels.

**resources/[slug]/page.tsx — Related Articles:**
1. Import `getRelatedBlogPosts` from `@/lib/resource-queries`.
2. After the existing content section and before the closing `</div>` of the grid, extract subject IDs: `const subjectIds = resource.subjects.map(({ subject }) => subject.id);`
3. Fetch: `const relatedPosts = subjectIds.length > 0 ? await getRelatedBlogPosts(subjectIds) : [];`
4. After the grid's main content column (after the closing `</div>` of the grid but still inside the outer container), render a "Related Articles" section guarded by `relatedPosts.length > 0`:
   - A full-width section below the 2-column grid.
   - `<Separator className="my-8" />`
   - `<h2 className="font-serif text-xl font-semibold mb-4">Related Articles</h2>`
   - A `<div className="grid grid-cols-1 sm:grid-cols-2 gap-4">` with compact article cards.
   - Each card: `<Link href={/blog/${p.slug}}` with border, rounded corners, padding, hover effect. Show title (semibold), excerpt (text-sm text-muted-foreground line-clamp-2), and formatted publishedAt date.

**simulations/[slug]/page.tsx — Related Lab Guides:**
1. Import `getRelatedLabGuides` from `@/lib/resource-queries`.
2. After fetching `resource` (and the null/notFound check), extract subject IDs: `const subjectIds = resource.subjects.map(({ subject }) => subject.id);`
3. Fetch: `const relatedLabGuides = subjectIds.length > 0 ? await getRelatedLabGuides(subjectIds, resource.id) : [];` — pass `resource.id` as `excludeResourceId` since both simulations and lab guides are in the Resource table.
4. In the sidebar column (inside `<div className="space-y-6">`), after the parameter docs section and before the view count `<div>`, render a "Related Lab Guides" section guarded by `relatedLabGuides.length > 0`:
   - `<div>` with `<h3 className="font-semibold text-sm mb-3">Related Lab Guides</h3>`
   - A `<ul className="space-y-2">` with `<li>` items, each containing a `<Link href={/resources/${lg.slug}} className="text-sm text-primary hover:underline">` showing the title.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify all three detail pages compile. Check pages with curl or Rodney to confirm they render without errors.
  </verify>
  <done>
Blog post detail pages show "Related Resources" when shared subjects exist. Resource detail pages show "Related Articles" when shared subjects exist. Simulation detail pages show "Related Lab Guides" in the sidebar. No sections appear when there are no related items.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. A blog post with subject tags shows a "Related Resources" section linking to resources with overlapping subjects
4. A resource with subject tags shows a "Related Articles" section linking to blog posts with overlapping subjects
5. A simulation shows "Related Lab Guides" in its sidebar when lab guide resources share its subject
6. Cross-link sections do not render when no related content exists
7. The current item never appears in its own related section
</verification>

<success_criteria>
- Three query functions (getRelatedResources, getRelatedBlogPosts, getRelatedLabGuides) exist and query by shared subject IDs
- Blog post, resource, and simulation detail pages all render cross-link sections when related content exists
- Sections are guarded by `.length > 0` — no empty headings
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-polish-and-cross-linking/15-02-SUMMARY.md`
</output>
