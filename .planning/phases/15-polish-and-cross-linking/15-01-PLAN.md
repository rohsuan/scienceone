---
phase: 15-polish-and-cross-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/resource-queries.ts
  - src/lib/blog-queries.ts
  - src/app/(main)/resources/page.tsx
  - src/app/(main)/blog/page.tsx
  - src/components/Pagination.tsx
  - src/components/resources/ResourceFilters.tsx
  - src/components/blog/BlogFilters.tsx
  - src/components/resources/ResourceSearchInput.tsx
autonomous: true
requirements:
  - RES-10

must_haves:
  truths:
    - "Resource listing page shows at most 12 resources per page"
    - "Blog listing page shows at most 12 posts per page"
    - "Pagination controls appear when there are more than 12 items"
    - "Clicking a page number navigates to that page of results"
    - "Changing a filter resets to page 1"
    - "Changing search text resets to page 1"
  artifacts:
    - path: "src/lib/resource-queries.ts"
      provides: "Paginated getPublishedResources returning { items, totalCount }"
      contains: "skip.*take.*PAGE_SIZE"
    - path: "src/lib/blog-queries.ts"
      provides: "Paginated getPublishedBlogPosts returning { items, totalCount }"
      contains: "skip.*take.*PAGE_SIZE"
    - path: "src/components/Pagination.tsx"
      provides: "Shared client pagination component with prev/next and page numbers"
      exports: ["default"]
    - path: "src/app/(main)/resources/page.tsx"
      provides: "Resources listing with page param extraction and Pagination"
      contains: "Pagination"
    - path: "src/app/(main)/blog/page.tsx"
      provides: "Blog listing with page param extraction and Pagination"
      contains: "Pagination"
  key_links:
    - from: "src/app/(main)/resources/page.tsx"
      to: "src/lib/resource-queries.ts"
      via: "page param passed to getPublishedResources"
      pattern: "getPublishedResources.*page"
    - from: "src/app/(main)/blog/page.tsx"
      to: "src/lib/blog-queries.ts"
      via: "page param passed to getPublishedBlogPosts"
      pattern: "getPublishedBlogPosts.*page"
    - from: "src/components/resources/ResourceFilters.tsx"
      to: "URL search params"
      via: "params.delete page on filter change"
      pattern: 'params\.delete\("page"\)'
---

<objective>
Add offset pagination to both the resource and blog listing pages, limiting each page to 12 items with working page navigation controls.

Purpose: Prevent unbounded database queries on listing pages and provide a usable browsing experience as content grows.
Output: Paginated resource and blog listing pages with a shared Pagination component, and filter/search components that reset to page 1 on change.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-polish-and-cross-linking/15-RESEARCH.md

@src/lib/resource-queries.ts
@src/lib/blog-queries.ts
@src/app/(main)/resources/page.tsx
@src/app/(main)/blog/page.tsx
@src/components/resources/ResourceFilters.tsx
@src/components/blog/BlogFilters.tsx
@src/components/resources/ResourceSearchInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination to query functions and create shared Pagination component</name>
  <files>
    src/lib/resource-queries.ts
    src/lib/blog-queries.ts
    src/components/Pagination.tsx
  </files>
  <action>
**resource-queries.ts:**
1. Add `const PAGE_SIZE = 12;` at module top and export it.
2. Add `page?: number` to `GetPublishedResourcesParams` interface.
3. Change `getPublishedResources` to accept `page = 1` (default), compute `const skip = (page - 1) * PAGE_SIZE`, and return `{ items, totalCount }` instead of the raw array. Use `Promise.all` to run `findMany({ where, orderBy, skip, take: PAGE_SIZE, include: ... })` and `prisma.resource.count({ where })` in parallel.

**blog-queries.ts:**
1. Add `const PAGE_SIZE = 12;` at module top and export it.
2. Add `page?: number` to `GetPublishedBlogPostsParams` interface.
3. Change `getPublishedBlogPosts` to accept `page = 1` (default), compute `const skip = (page - 1) * PAGE_SIZE`, and return `{ items, totalCount }` instead of the raw array. Use `Promise.all` to run `findMany({ where, orderBy, skip, take: PAGE_SIZE, include: ... })` and `prisma.blogPost.count({ where })` in parallel.

**src/components/Pagination.tsx:**
Create a `"use client"` component that receives `currentPage: number` and `totalPages: number` props. Uses `usePathname()` and `useSearchParams()` from `next/navigation`. Has a `createPageURL(pageNumber)` function that clones current search params, sets `page`, and returns `pathname?params`.

Renders a centered flex row with:
- Previous button: conditionally rendered only when `currentPage > 1`. Uses `<Button variant="outline" size="sm" asChild><Link href={createPageURL(currentPage - 1)}>Previous</Link></Button>`.
- Page indicator text: `Page {currentPage} of {totalPages}` in `text-sm text-muted-foreground`.
- Next button: conditionally rendered only when `currentPage < totalPages`. Same pattern as Previous.

Do NOT use `disabled` prop with `asChild` + `Link` (the anchor remains clickable). Instead, simply do not render the button at all when at the boundary. This avoids the pitfall documented in research.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the three files exist and export correctly.
  </verify>
  <done>
Both query functions accept a `page` parameter, return `{ items, totalCount }`, and use `skip`/`take: PAGE_SIZE`. The Pagination component exists and renders conditional prev/next navigation links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pagination into listing pages and fix filter/search page reset</name>
  <files>
    src/app/(main)/resources/page.tsx
    src/app/(main)/blog/page.tsx
    src/components/resources/ResourceFilters.tsx
    src/components/blog/BlogFilters.tsx
    src/components/resources/ResourceSearchInput.tsx
  </files>
  <action>
**resources/page.tsx:**
1. Import `Pagination` from `@/components/Pagination` and `PAGE_SIZE` from `@/lib/resource-queries`.
2. Extract `page` from `params`: `const page = params.page ? Math.max(1, parseInt(String(params.page), 10) || 1) : 1;` — the `|| 1` guards against NaN.
3. Pass `page` to `getPublishedResources({ subject, type, level, sort, q, page })`.
4. Destructure: `const [{ items: resources, totalCount }, subjects] = await Promise.all([...])`.
5. Compute `const totalPages = Math.ceil(totalCount / PAGE_SIZE);`.
6. After the grid div (inside the else branch), render: `{totalPages > 1 && <Pagination currentPage={page} totalPages={totalPages} />}`.

**blog/page.tsx:**
1. Import `Pagination` from `@/components/Pagination` and `PAGE_SIZE` from `@/lib/blog-queries`.
2. Same page extraction pattern as resources page.
3. Pass `page` to `getPublishedBlogPosts({ category, subject, sort, q, page })`.
4. Destructure: `const [{ items: posts, totalCount }, subjects] = await Promise.all([...])`.
5. Compute `const totalPages = Math.ceil(totalCount / PAGE_SIZE);`.
6. After the grid div (inside the else branch), render the same Pagination component.

**ResourceFilters.tsx:**
In the `setParam` function, add `params.delete("page");` before the `router.replace(...)` call. This resets to page 1 whenever any filter changes.

**BlogFilters.tsx:**
Same fix — add `params.delete("page");` in the `setParam` function before `router.replace(...)`.

**ResourceSearchInput.tsx:**
In the `useEffect` debounce callback, add `params.delete("page");` before `router.replace(...)`. This resets to page 1 on search text changes.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Run `npm run build` to verify the pages compile. Verify that `/resources` and `/blog` pages load correctly (use curl or Rodney if available).
  </verify>
  <done>
Resource listing shows max 12 items per page with pagination controls. Blog listing shows max 12 posts per page with pagination controls. Changing any filter or search text resets to page 1.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. `/resources` page renders at most 12 resources and shows pagination when total > 12
4. `/blog` page renders at most 12 posts and shows pagination when total > 12
5. Navigating to `/resources?page=2` shows the second page of resources
6. Changing a filter on `/resources?page=3` navigates to `/resources?subject=physics` (page reset)
7. Changing search text resets to page 1
</verification>

<success_criteria>
- Both listing pages query with `take: 12` and `skip` based on page number
- Pagination component renders Previous/Next links only when valid
- Filter and search changes reset pagination to page 1
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-polish-and-cross-linking/15-01-SUMMARY.md`
</output>
