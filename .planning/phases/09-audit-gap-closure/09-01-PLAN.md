---
phase: 09-audit-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/admin-actions.ts
  - src/app/(auth)/sign-in/page.tsx
  - src/components/auth/SignInForm.tsx
  - src/components/auth/GoogleSignInButton.tsx
  - src/app/(main)/catalog/[slug]/page.tsx
  - src/app/api/download/route.ts
autonomous: true
requirements:
  - ADM-03
  - ADM-04
gap_closure: true

must_haves:
  truths:
    - "Admin can edit pageCount from null to a number and save successfully"
    - "Admin can edit price from null to a number and save successfully"
    - "Admin can clear pageCount, publishYear, or price to empty and save (NaN becomes null)"
    - "User signing in from /sign-in?redirect=/catalog/some-slug is returned to /catalog/some-slug after login"
    - "Anonymous user can download PDF of an open access book without signing in"
    - "Anonymous user can download EPUB of an open access book without signing in"
    - "Paid book download still requires authentication and purchase"
  artifacts:
    - path: "src/lib/admin-actions.ts"
      provides: "bookUpdateSchema with NaN-to-null handling for pageCount, publishYear, price"
      contains: "z.preprocess"
    - path: "src/app/(auth)/sign-in/page.tsx"
      provides: "Server Component reading searchParams.redirect and passing to child components"
      contains: "redirectTo"
    - path: "src/components/auth/SignInForm.tsx"
      provides: "SignInForm accepting redirectTo prop"
      contains: "redirectTo"
    - path: "src/components/auth/GoogleSignInButton.tsx"
      provides: "GoogleSignInButton accepting redirectTo prop"
      contains: "redirectTo"
    - path: "src/app/(main)/catalog/[slug]/page.tsx"
      provides: "Download buttons visible for open access books without session"
      contains: "(book.isOpenAccess || purchased)"
    - path: "src/app/api/download/route.ts"
      provides: "Conditional auth — open access books downloadable without session"
      contains: "getClientIp"
  key_links:
    - from: "src/app/(auth)/sign-in/page.tsx"
      to: "src/components/auth/SignInForm.tsx"
      via: "redirectTo prop"
      pattern: "redirectTo={redirectTo}"
    - from: "src/app/(auth)/sign-in/page.tsx"
      to: "src/components/auth/GoogleSignInButton.tsx"
      via: "redirectTo prop"
      pattern: "redirectTo={redirectTo}"
    - from: "src/app/(main)/catalog/[slug]/page.tsx"
      to: "src/app/api/download/route.ts"
      via: "DownloadButton fetch call"
      pattern: "isOpenAccess"
---

<objective>
Fix four v1 audit gaps: (1) admin form numeric fields (pageCount, publishYear, price) fail validation when cleared because NaN is rejected by Zod 4, (2) sign-in page ignores ?redirect= query parameter, (3) open access download buttons hidden from anonymous users, (4) download API rejects anonymous requests for open access books.

Purpose: Close all remaining gaps identified in the v1 milestone audit so the MVP is complete.
Output: Six modified files with surgical fixes — no new files, no migrations, no new packages.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-audit-gap-closure/09-RESEARCH.md
@src/lib/admin-actions.ts
@src/app/(auth)/sign-in/page.tsx
@src/components/auth/SignInForm.tsx
@src/components/auth/GoogleSignInButton.tsx
@src/app/(main)/catalog/[slug]/page.tsx
@src/app/api/download/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Zod schema NaN handling and sign-in redirect flow</name>
  <files>
    src/lib/admin-actions.ts
    src/app/(auth)/sign-in/page.tsx
    src/components/auth/SignInForm.tsx
    src/components/auth/GoogleSignInButton.tsx
  </files>
  <action>
**Part A — Fix bookUpdateSchema NaN-to-null coercion (ADM-03, ADM-04):**

In `src/lib/admin-actions.ts`, replace the three numeric field definitions in `bookUpdateSchema` with `z.preprocess` wrappers that convert NaN to null before Zod type-checking runs.

IMPORTANT: Do NOT use `z.number().transform()` — Zod 4 rejects NaN at the type-check stage BEFORE any `.transform()` runs. Per locked decision [07-02], do NOT use `z.coerce.number()` either (breaks @hookform/resolvers type inference). Use `z.preprocess` which runs BEFORE type checking.

Replace these three lines:
```typescript
pageCount: z.number().int().positive().optional().nullable(),
publishYear: z.number().int().positive().optional().nullable(),
price: z.number().nonnegative().optional().nullable(),
```

With:
```typescript
pageCount: z.preprocess(
  (v) => (typeof v === "number" && Number.isNaN(v) ? null : v),
  z.number().int().positive().optional().nullable(),
),
publishYear: z.preprocess(
  (v) => (typeof v === "number" && Number.isNaN(v) ? null : v),
  z.number().int().positive().optional().nullable(),
),
price: z.preprocess(
  (v) => (typeof v === "number" && Number.isNaN(v) ? null : v),
  z.number().nonnegative().optional().nullable(),
),
```

No other changes to admin-actions.ts. The form already has `{ valueAsNumber: true }` on these fields.

**Part B — Sign-in redirect consumption:**

1. In `src/app/(auth)/sign-in/page.tsx`:
   - Add `searchParams` to the page props (Next.js 16 Promise pattern: `searchParams: Promise<{ redirect?: string }>`)
   - Make the function `async`
   - Read and validate the redirect param: accept only paths starting with `/` that do NOT start with `//` (prevents open redirect). Default to `"/dashboard"`.
   - Pass `redirectTo` as a prop to both `<SignInForm>` and `<GoogleSignInButton>`
   - Preserve the existing "Don't have an account? Sign up" link — also pass the redirect through to it: `href={redirectTo !== "/dashboard" ? \`/sign-up?redirect=${encodeURIComponent(redirectTo)}\` : "/sign-up"}`... Actually, skip the sign-up link redirect pass-through — keep it simple, just `/sign-up`.

2. In `src/components/auth/SignInForm.tsx`:
   - Add `redirectTo` prop with default `"/dashboard"`: `{ redirectTo = "/dashboard" }: { redirectTo?: string }`
   - Change line 61 from `router.push("/dashboard")` to `router.push(redirectTo)`

3. In `src/components/auth/GoogleSignInButton.tsx`:
   - Add `redirectTo` prop with default `"/dashboard"`: `{ redirectTo = "/dashboard" }: { redirectTo?: string }`
   - Change `callbackURL: "/dashboard"` to `callbackURL: redirectTo`
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across the four modified files. Then run `node -e "const { z } = require('zod'); const s = z.preprocess(v => (typeof v === 'number' && Number.isNaN(v) ? null : v), z.number().int().positive().optional().nullable()); console.log(JSON.stringify(s.safeParse(NaN))); console.log(JSON.stringify(s.safeParse(42))); console.log(JSON.stringify(s.safeParse(null))); console.log(JSON.stringify(s.safeParse(undefined)));"` — expect: NaN→{success:true,data:null}, 42→{success:true,data:42}, null→{success:true,data:null}, undefined→{success:true,data:undefined}.
  </verify>
  <done>
All three numeric fields (pageCount, publishYear, price) in bookUpdateSchema use z.preprocess to convert NaN to null. SignInForm reads redirectTo prop and navigates there after login. GoogleSignInButton reads redirectTo prop and uses it as callbackURL. Sign-in page reads searchParams.redirect, validates it, and passes to both components. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable open access anonymous download (UI gate and API gate)</name>
  <files>
    src/app/(main)/catalog/[slug]/page.tsx
    src/app/api/download/route.ts
  </files>
  <action>
**Part A — Remove session requirement from download button visibility:**

In `src/app/(main)/catalog/[slug]/page.tsx`, find line 125:
```tsx
{((book.isOpenAccess && session) || purchased) &&
```

Change to:
```tsx
{(book.isOpenAccess || purchased) &&
```

This single change makes download buttons visible for open access books regardless of whether the user has a session.

**Part B — Restructure download API to allow anonymous open-access downloads:**

In `src/app/api/download/route.ts`, restructure the GET handler:

1. **Add a `getClientIp` helper** at the top of the file (after the `checkRateLimit` function):
```typescript
function getClientIp(request: Request): string {
  const forwarded = request.headers.get("x-forwarded-for");
  if (forwarded) return forwarded.split(",")[0].trim();
  return "unknown";
}
```

2. **Reorder the GET handler** to: parse params → fetch book → conditional auth → conditional entitlement → rate limit → artifact check → presigned URL → conditional audit log.

Specifically:
- Move param parsing (sections b from current code) to come FIRST (before auth)
- Move book fetch (section d from current code) to come SECOND
- Move auth check to come THIRD, but make it conditional: only return 401 if `!book.isOpenAccess && !session`
- Entitlement check stays the same (already conditional on `!book.isOpenAccess`)
- Rate limiting: use `session.user.id` when session exists, otherwise use `anon:${getClientIp(request)}` as the key
- Audit log: only create Download record when session exists (Download.userId is non-nullable, no migration)
- Everything else (artifact check, presigned URL generation) stays the same

The full restructured order:
```
a. Parse and validate params (bookSlug, format)
b. Fetch book (need isOpenAccess to decide auth)
c. Auth check — only required for non-open-access books
d. Entitlement check — only for paid books
e. Rate limiting — userId for auth, IP for anonymous
f. Artifact check (unchanged)
g. Generate presigned URL (unchanged)
h. Audit log — skip for anonymous (no userId available)
i. Return presigned URL (unchanged)
```
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the download route compiles and the catalog page compiles. Check that the condition `(book.isOpenAccess || purchased)` is present in catalog/[slug]/page.tsx and the condition `!book.isOpenAccess && !session` is present in api/download/route.ts.
  </verify>
  <done>
Open access books show download buttons to anonymous users on the catalog detail page. The download API allows anonymous GET requests for open access books, rate-limits them by IP, skips audit logging for anonymous downloads, and still requires authentication + purchase for paid books. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx next build` completes without build errors (if feasible — may fail due to DB being offline, which is a known blocker from Phase 1)
3. Verify in admin-actions.ts: all three numeric fields use `z.preprocess` with NaN→null conversion
4. Verify in sign-in/page.tsx: `searchParams` is read, validated, and passed as `redirectTo` prop
5. Verify in SignInForm.tsx: `router.push(redirectTo)` replaces `router.push("/dashboard")`
6. Verify in GoogleSignInButton.tsx: `callbackURL: redirectTo` replaces `callbackURL: "/dashboard"`
7. Verify in catalog/[slug]/page.tsx: download condition is `(book.isOpenAccess || purchased)` (no `&& session`)
8. Verify in api/download/route.ts: auth check is `!book.isOpenAccess && !session`, rate limit uses IP for anon, audit log skipped for anon
</verification>

<success_criteria>
- Admin can save numeric fields (pageCount, publishYear, price) from empty/null to a value and back to empty without validation errors
- Sign-in page reads ?redirect= and sends user to that path after successful login
- Open access books show download buttons to all visitors (no session required)
- Download API serves open access book files to anonymous users with IP-based rate limiting
- Paid book downloads still require authentication and a valid purchase record
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-audit-gap-closure/09-01-SUMMARY.md`
</output>
