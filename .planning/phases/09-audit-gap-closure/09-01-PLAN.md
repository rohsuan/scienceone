---
phase: 09-audit-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/admin-actions.ts
  - src/app/(auth)/sign-in/page.tsx
  - src/components/auth/SignInForm.tsx
  - src/components/auth/GoogleSignInButton.tsx
  - src/app/(main)/catalog/[slug]/page.tsx
  - src/app/api/download/route.ts
autonomous: true
requirements:
  - ADM-03
  - ADM-04

must_haves:
  truths:
    - "Admin can edit pageCount from null to a numeric value and save without validation error"
    - "Admin can edit price from null to a numeric value and save without validation error"
    - "Admin can clear pageCount/price/publishYear back to empty and save (NaN normalised to null)"
    - "User signing in from /sign-in?redirect=/catalog/some-slug is returned to /catalog/some-slug after login"
    - "Google sign-in from /sign-in?redirect=/catalog/some-slug redirects back to /catalog/some-slug"
    - "Anonymous user can see download buttons on open access book detail page"
    - "Anonymous user can download PDF/EPUB of open access book without 401"
    - "Paid book still requires authentication and purchase for download"
  artifacts:
    - path: "src/lib/admin-actions.ts"
      provides: "NaN-to-null Zod transforms on pageCount, publishYear, price"
      contains: "Number.isNaN"
    - path: "src/app/(auth)/sign-in/page.tsx"
      provides: "searchParams.redirect reading and safe redirect validation"
      contains: "redirectTo"
    - path: "src/components/auth/SignInForm.tsx"
      provides: "redirectTo prop consumption instead of hardcoded /dashboard"
      contains: "redirectTo"
    - path: "src/components/auth/GoogleSignInButton.tsx"
      provides: "redirectTo prop consumption in callbackURL"
      contains: "redirectTo"
    - path: "src/app/(main)/catalog/[slug]/page.tsx"
      provides: "Open access download buttons visible without session"
      contains: "(book.isOpenAccess || purchased)"
    - path: "src/app/api/download/route.ts"
      provides: "Conditional auth — anonymous allowed for open access books"
      contains: "getClientIp"
  key_links:
    - from: "src/app/(auth)/sign-in/page.tsx"
      to: "src/components/auth/SignInForm.tsx"
      via: "redirectTo prop"
      pattern: "redirectTo={redirectTo}"
    - from: "src/app/(auth)/sign-in/page.tsx"
      to: "src/components/auth/GoogleSignInButton.tsx"
      via: "redirectTo prop"
      pattern: "redirectTo={redirectTo}"
    - from: "src/app/(main)/catalog/[slug]/page.tsx"
      to: "src/app/api/download/route.ts"
      via: "DownloadButton fetch to /api/download"
      pattern: "book.isOpenAccess || purchased"
---

<objective>
Fix four v1 audit gaps: (1) admin form NaN-to-null coercion for numeric fields, (2) sign-in redirect consumption from query params, (3) open access download UI gate, (4) open access download API gate.

Purpose: Close all remaining v1 audit gaps so admin metadata editing, sign-in redirects, and anonymous open access downloads work correctly.
Output: Six files modified with targeted fixes; no new files, packages, or migrations.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-audit-gap-closure/09-RESEARCH.md
@src/lib/admin-actions.ts
@src/app/(auth)/sign-in/page.tsx
@src/components/auth/SignInForm.tsx
@src/components/auth/GoogleSignInButton.tsx
@src/app/(main)/catalog/[slug]/page.tsx
@src/app/api/download/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix admin form NaN-to-null coercion and sign-in redirect</name>
  <files>
    src/lib/admin-actions.ts
    src/app/(auth)/sign-in/page.tsx
    src/components/auth/SignInForm.tsx
    src/components/auth/GoogleSignInButton.tsx
  </files>
  <action>
**Gap 1: NaN-to-null Zod transform (ADM-03/ADM-04)**

In `src/lib/admin-actions.ts`, update the `bookUpdateSchema` to add `.transform(v => Number.isNaN(v) ? null : v)` to three numeric fields. The transform must be placed AFTER the type validators but BEFORE `.optional().nullable()`:

```typescript
pageCount: z.number().int().positive().transform(v => Number.isNaN(v) ? null : v).optional().nullable(),
publishYear: z.number().int().positive().transform(v => Number.isNaN(v) ? null : v).optional().nullable(),
price: z.number().nonnegative().transform(v => Number.isNaN(v) ? null : v).optional().nullable(),
```

Do NOT use `z.coerce.number()` — this is banned per locked decision `[07-02]` (breaks `@hookform/resolvers` type inference in Zod v4).

No other files need changes for this gap — `BookEditForm.tsx` already has `{ valueAsNumber: true }` on all three fields.

**Gap 2: Sign-in redirect consumption**

In `src/app/(auth)/sign-in/page.tsx`:
1. Add `searchParams` to the page component props (type: `Promise<{ redirect?: string }>` — Next.js 16 pattern)
2. Await searchParams and extract `redirect`
3. Validate the redirect: must start with `/` and must NOT start with `//` (prevents open redirect). Default to `/dashboard` if absent or invalid.
4. Pass `redirectTo` as prop to both `<SignInForm>` and `<GoogleSignInButton>`

```typescript
interface SignInPageProps {
  searchParams: Promise<{ redirect?: string }>;
}

function getSafeRedirect(redirect: string | undefined): string {
  if (!redirect) return "/dashboard";
  if (redirect.startsWith("/") && !redirect.startsWith("//")) return redirect;
  return "/dashboard";
}

export default async function SignInPage({ searchParams }: SignInPageProps) {
  const { redirect } = await searchParams;
  const redirectTo = getSafeRedirect(redirect);
  // ... pass redirectTo to SignInForm and GoogleSignInButton
}
```

In `src/components/auth/SignInForm.tsx`:
1. Add `interface SignInFormProps { redirectTo?: string; }`
2. Accept `{ redirectTo = "/dashboard" }: SignInFormProps` as component param
3. Change line 61 from `router.push("/dashboard")` to `router.push(redirectTo)`

In `src/components/auth/GoogleSignInButton.tsx`:
1. Add `interface GoogleSignInButtonProps { redirectTo?: string; }`
2. Accept `{ redirectTo = "/dashboard" }: GoogleSignInButtonProps` as component param
3. Change `callbackURL: "/dashboard"` to `callbackURL: redirectTo`

Also update the sign-up link in sign-in page to preserve the redirect parameter: if `redirectTo` is not `/dashboard`, append `?redirect=...` to the sign-up link href so the redirect survives a sign-up → verify → sign-in round trip.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no type errors
2. Run `npx next build 2>&1 | tail -20` — build succeeds
3. Grep for hardcoded `"/dashboard"` in SignInForm.tsx and GoogleSignInButton.tsx — should only appear as default prop value, not in router.push or callbackURL
4. Grep for `Number.isNaN` in admin-actions.ts — should appear 3 times (pageCount, publishYear, price)
  </verify>
  <done>
- bookUpdateSchema accepts NaN for pageCount, publishYear, price and transforms them to null
- SignInForm uses redirectTo prop (default: /dashboard) instead of hardcoded path
- GoogleSignInButton uses redirectTo prop in callbackURL
- Sign-in page reads searchParams.redirect, validates for open redirect, passes to both auth components
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix open access anonymous download (UI gate + API gate)</name>
  <files>
    src/app/(main)/catalog/[slug]/page.tsx
    src/app/api/download/route.ts
  </files>
  <action>
**Gap 3: Open access download UI gate**

In `src/app/(main)/catalog/[slug]/page.tsx`, find line 125 with the download button visibility condition:

```tsx
{((book.isOpenAccess && session) || purchased) &&
```

Change to remove the session requirement for open access:

```tsx
{(book.isOpenAccess || purchased) &&
```

This is a single boolean condition change. The `DownloadButton` component is session-agnostic (uses `fetch()` which auto-sends cookies). No other changes needed in this file.

**Gap 4: Open access download API gate**

In `src/app/api/download/route.ts`, restructure the route handler to allow anonymous access for open access books. The changes are:

1. **Add `getClientIp` helper** above the GET function:
```typescript
function getClientIp(request: Request): string {
  const forwarded = request.headers.get("x-forwarded-for");
  if (forwarded) return forwarded.split(",")[0].trim();
  return "unknown";
}
```

2. **Reorder the GET function** — move param validation and book fetch BEFORE the auth check:
   - Parse and validate `bookSlug` and `format` params (currently step b → now step a)
   - Fetch book from DB (currently step d → now step b)
   - Then do auth check conditionally (currently step a → now step c)

3. **Make auth conditional on `isOpenAccess`:**
```typescript
const session = await auth.api.getSession({ headers: await headers() });
if (!book.isOpenAccess && !session) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

4. **Entitlement check** — only for non-open-access books. Use `session!.user.id` (TypeScript non-null assertion is safe because we checked `!session` returns 401 above):
```typescript
if (!book.isOpenAccess) {
  const purchase = await prisma.purchase.findUnique({
    where: { userId_bookId: { userId: session!.user.id, bookId: book.id } },
    select: { id: true },
  });
  if (!purchase) {
    return NextResponse.json({ error: "Purchase required" }, { status: 403 });
  }
}
```

5. **Rate limiting** — use userId for authenticated, IP for anonymous:
```typescript
const rateLimitKey = session
  ? `${session.user.id}:${bookSlug}:${format}`
  : `anon:${getClientIp(request)}:${bookSlug}:${format}`;
```

6. **Audit log** — skip for anonymous (Download model `userId` is non-nullable, no migration):
```typescript
if (session) {
  void prisma.download.create({
    data: { userId: session.user.id, bookId: book.id, format },
  });
}
```

7. The presigned URL generation (steps f-g in original) and final return remain unchanged.

**Important:** Do NOT make `userId` nullable in the Download model. That would require a Prisma migration, which is out of scope for a gap closure phase.
  </action>
  <verify>
1. Run `npx tsc --noEmit` — no type errors
2. Run `npx next build 2>&1 | tail -20` — build succeeds
3. Grep catalog detail page for the old condition `book.isOpenAccess && session` — should NOT appear
4. Grep download route for `getClientIp` — should appear
5. Verify download route no longer has unconditional `if (!session)` early return at the top of the function
  </verify>
  <done>
- Open access book detail page shows download buttons regardless of session state
- Download API allows anonymous GET for open access books (no 401)
- Paid book downloads still require authentication and purchase
- Anonymous downloads rate-limited by IP address
- Audit log skipped for anonymous downloads (no schema migration needed)
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all four gaps are closed:

1. **ADM-03/ADM-04 NaN fix:** Grep `admin-actions.ts` for `Number.isNaN` — 3 occurrences (pageCount, publishYear, price)
2. **Sign-in redirect:** Grep `SignInForm.tsx` for `redirectTo` — appears in props and router.push. Grep `GoogleSignInButton.tsx` for `redirectTo` — appears in props and callbackURL.
3. **Open access UI gate:** Grep catalog detail page for download condition — `(book.isOpenAccess || purchased)` (no `&& session`)
4. **Open access API gate:** Download route has `if (!book.isOpenAccess && !session)` pattern (not unconditional `if (!session)`)
5. Full build succeeds: `npx next build`
</verification>

<success_criteria>
- `npx tsc --noEmit` passes with zero errors
- `npx next build` succeeds
- All three numeric schema fields have NaN-to-null transforms
- Sign-in page reads redirect searchParam and passes to auth components
- Both auth components use redirectTo prop instead of hardcoded /dashboard
- Catalog detail page shows download buttons for open access books without session
- Download API allows anonymous requests for open access books
- Download API still requires auth for paid books
- Anonymous rate limiting uses IP address
- No Prisma migration changes
</success_criteria>

<output>
After completion, create `.planning/phases/09-audit-gap-closure/09-01-SUMMARY.md`
</output>
