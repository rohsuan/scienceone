---
phase: 10-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/seed.ts
  - src/lib/sanitize-html.ts
  - src/app/(main)/blog/[slug]/page.tsx
  - src/app/(main)/resources/[slug]/page.tsx
  - src/app/(main)/simulations/[slug]/page.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Running prisma migrate deploy succeeds and all new tables (subjects, resources, resource_prices, resource_purchases, resource_subjects, simulations, blog_posts, blog_post_subjects) exist in the database"
    - "The subjects table contains exactly four rows: Physics, Mathematics, Chemistry, Computer Science"
    - "A shared sanitizeHtml utility exists that strips script tags, event handlers, iframes, and other XSS vectors while preserving safe formatting tags"
    - "All four dangerouslySetInnerHTML call sites for user-generated content (blog content, resource content, simulation teacherGuide, simulation parameterDocs) pass HTML through sanitizeHtml before rendering"
  artifacts:
    - path: "src/lib/sanitize-html.ts"
      provides: "Shared sanitizeHtml utility function"
      exports: ["sanitizeHtml"]
    - path: "prisma/seed.ts"
      provides: "Subject taxonomy seed data (Physics, Mathematics, Chemistry, Computer Science)"
      contains: "Physics"
  key_links:
    - from: "src/app/(main)/blog/[slug]/page.tsx"
      to: "src/lib/sanitize-html.ts"
      via: "import sanitizeHtml and call before dangerouslySetInnerHTML"
      pattern: "sanitizeHtml\\(.*content"
    - from: "src/app/(main)/resources/[slug]/page.tsx"
      to: "src/lib/sanitize-html.ts"
      via: "import sanitizeHtml and call before dangerouslySetInnerHTML"
      pattern: "sanitizeHtml\\(.*content"
    - from: "src/app/(main)/simulations/[slug]/page.tsx"
      to: "src/lib/sanitize-html.ts"
      via: "import sanitizeHtml and call before dangerouslySetInnerHTML for content, teacherGuide, parameterDocs"
      pattern: "sanitizeHtml\\("
---

<objective>
Verify the v1.1 database migration, seed the Subject taxonomy with four subjects, and create a shared sanitizeHtml utility applied at all dangerouslySetInnerHTML call sites rendering user-generated content.

Purpose: Unblock Phases 11-14 by ensuring the database schema is correct, subjects are seeded for tagging, and no unsanitized HTML can reach the browser from blog posts, resources, or simulations.
Output: Working migration + seeded subjects + shared sanitizeHtml utility wired into all public content rendering paths.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@prisma/seed.ts
@src/lib/admin-actions.ts (existing sanitize-html usage pattern at line 140-154)
@src/app/(main)/blog/[slug]/page.tsx
@src/app/(main)/resources/[slug]/page.tsx
@src/app/(main)/simulations/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify migration, update seed with four subjects, and run seed</name>
  <files>prisma/seed.ts</files>
  <action>
1. Run `npx prisma migrate deploy` to apply any pending migrations. Verify it succeeds with zero errors. Then verify all v1.1 tables exist by running a quick Prisma query or inspecting the generated client.

2. Update `prisma/seed.ts` to replace the current subject seed data (Mechanics, Electromagnetism, Waves, Thermodynamics, Modern Physics, Mathematics) with exactly four subjects per the user decision:
   - Physics (slug: "physics")
   - Mathematics (slug: "mathematics")
   - Chemistry (slug: "chemistry")
   - Computer Science (slug: "computer-science")

   Keep the existing upsert pattern (`prisma.subject.upsert` with `where: { slug }`) so re-running is idempotent. Remove the six old entries. Do NOT delete old subjects from the database — just stop seeding them (they'll be unused).

3. Run `npx prisma db seed` and confirm the four subjects are created without errors.

Do NOT touch any other seed data (categories, users, books, chapters).
  </action>
  <verify>
Run `npx prisma db seed` — output should show "Subjects seeded: Physics, Mathematics, Chemistry, Computer Science" (or similar). No errors.
  </verify>
  <done>The migration is applied, all v1.1 tables exist, and exactly four subjects (Physics, Mathematics, Chemistry, Computer Science) are seeded in the database.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared sanitizeHtml utility and wire into all four dangerouslySetInnerHTML call sites</name>
  <files>
    src/lib/sanitize-html.ts
    src/app/(main)/blog/[slug]/page.tsx
    src/app/(main)/resources/[slug]/page.tsx
    src/app/(main)/simulations/[slug]/page.tsx
  </files>
  <action>
1. Create `src/lib/sanitize-html.ts` exporting a `sanitizeHtml(html: string): string` function. Use the `sanitize-html` npm package (already installed).

   Allowed tags (per user decision — safe formatting only):
   - All `sanitize-html` defaults (h1-h6, p, b, strong, i, em, a, ul, ol, li, br, hr, etc.)
   - Plus: `pre`, `code`, `blockquote`, `table`, `thead`, `tbody`, `tr`, `th`, `td`, `img`, `figure`, `figcaption`
   - Plus KaTeX/MathML tags already used in admin-actions.ts: `span`, `math`, `semantics`, `mrow`, `mi`, `mo`, `mn`, `msup`, `msub`, `mfrac`, `mover`, `munder`, `msqrt`, `mroot`, `mtable`, `mtr`, `mtd`, `annotation`, `mspace`, `mtext`, `menclose`, `mpadded`

   Allowed attributes:
   - All `sanitize-html` defaults
   - `*`: `["class", "style", "aria-hidden", "role"]` plus `data-*` pattern
   - `a`: add `target`, `rel` to defaults
   - `img`: `src`, `alt`, `width`, `height`, `loading`
   - MathML attributes from admin-actions.ts: `math.xmlns`, `annotation.encoding`, `mo.mathvariant/stretchy/fence/separator`, `mi.mathvariant`
   - `code`: `class` (for language-* syntax highlight classes)

   Explicitly strip: `script`, `iframe`, `object`, `embed`, `form`, `input`, `textarea`, `select`, `button`, all `on*` event handlers.

   The function should handle null/undefined gracefully — return empty string for falsy input.

2. Wire the utility into the four public content rendering call sites:

   **`src/app/(main)/blog/[slug]/page.tsx` (line ~145):**
   - Import `{ sanitizeHtml }` from `@/lib/sanitize-html`
   - Change `dangerouslySetInnerHTML={{ __html: post.content }}` to `dangerouslySetInnerHTML={{ __html: sanitizeHtml(post.content) }}`
   - Do NOT touch the JSON-LD `dangerouslySetInnerHTML` at line ~70 — that uses `JSON.stringify().replace()` which is safe (not user content)

   **`src/app/(main)/resources/[slug]/page.tsx` (line ~129):**
   - Import `{ sanitizeHtml }` from `@/lib/sanitize-html`
   - Change `dangerouslySetInnerHTML={{ __html: resource.content }}` to `dangerouslySetInnerHTML={{ __html: sanitizeHtml(resource.content) }}`

   **`src/app/(main)/simulations/[slug]/page.tsx` (3 call sites):**
   - Import `{ sanitizeHtml }` from `@/lib/sanitize-html`
   - Line ~88: Change `{{ __html: resource.content }}` to `{{ __html: sanitizeHtml(resource.content) }}`
   - Line ~100: Change `{{ __html: simulation.teacherGuide }}` to `{{ __html: sanitizeHtml(simulation.teacherGuide) }}`
   - Line ~113: Change `{{ __html: simulation.parameterDocs }}` to `{{ __html: sanitizeHtml(simulation.parameterDocs) }}`

3. Also refactor `src/lib/admin-actions.ts` to use the shared utility instead of inline sanitize-html config. Import `{ sanitizeHtml }` from `@/lib/sanitize-html` and replace the inline call at ~line 140-154 with `const clean = sanitizeHtml(validated.content)`. Remove the `import sanitizeHtml from "sanitize-html"` direct import since the wrapper handles it.

4. Run `npx next build` (or at minimum `npx tsc --noEmit`) to verify no TypeScript errors from the changes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors related to the changed files.
2. Grep for `dangerouslySetInnerHTML` in blog/[slug]/page.tsx, resources/[slug]/page.tsx, simulations/[slug]/page.tsx — every instance rendering database content must call `sanitizeHtml()`.
3. Grep for `from "sanitize-html"` in src/ — should only appear in `src/lib/sanitize-html.ts` (the shared utility), not in individual pages or admin-actions.
  </verify>
  <done>A shared sanitizeHtml utility exists at src/lib/sanitize-html.ts. All four dangerouslySetInnerHTML call sites for user content (blog content, resource content, simulation teacherGuide, simulation parameterDocs) pass HTML through sanitizeHtml before rendering. No direct sanitize-html imports remain outside the utility. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npx prisma migrate deploy` succeeds — all v1.1 tables exist
2. `npx prisma db seed` succeeds — four subjects seeded
3. `npx tsc --noEmit` passes — no TypeScript errors
4. `grep -rn 'dangerouslySetInnerHTML' src/app/(main)/blog/ src/app/(main)/resources/ src/app/(main)/simulations/` — every content-rendering instance uses `sanitizeHtml()`
5. `grep -rn 'from "sanitize-html"' src/` — only appears in `src/lib/sanitize-html.ts`
</verification>

<success_criteria>
- Database migration applied with all v1.1 tables present
- Four subjects seeded (Physics, Mathematics, Chemistry, Computer Science)
- Shared sanitizeHtml utility at src/lib/sanitize-html.ts
- All dangerouslySetInnerHTML sites for database content wrapped in sanitizeHtml()
- TypeScript compiles without errors
- No direct sanitize-html imports outside the shared utility
</success_criteria>

<output>
After completion, create `.planning/phases/10-infrastructure/10-01-SUMMARY.md`
</output>
