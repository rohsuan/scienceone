---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - 01-02
  - 01-03
files_modified:
  - src/app/(main)/dashboard/page.tsx
  - src/components/dashboard/WelcomeSection.tsx
  - src/components/dashboard/EmptyLibrary.tsx
  - src/components/dashboard/EmptyRecentlyRead.tsx
  - proxy.ts
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02

must_haves:
  truths:
    - "Logged-in user sees a dashboard with their name, empty 'My Library' section, and empty 'Recently Read' section"
    - "User can log out from the dashboard (and from any page via the header)"
    - "Unauthenticated user visiting /dashboard is redirected to /sign-in"
    - "User session persists across browser refresh and tab close/reopen"
    - "The full auth flow works end-to-end: sign-up -> verify email -> sign-in -> dashboard -> sign-out"
  artifacts:
    - path: "src/app/(main)/dashboard/page.tsx"
      provides: "Protected dashboard page with server-side session check"
      contains: "auth.api.getSession"
    - path: "src/components/dashboard/WelcomeSection.tsx"
      provides: "Welcome greeting with user name"
      contains: "Welcome"
    - path: "src/components/dashboard/EmptyLibrary.tsx"
      provides: "Empty state for My Library section"
      contains: "Library"
    - path: "src/components/dashboard/EmptyRecentlyRead.tsx"
      provides: "Empty state for Recently Read section"
      contains: "Recently"
    - path: "proxy.ts"
      provides: "Next.js 16 proxy for route protection"
      contains: "getSessionCookie"
  key_links:
    - from: "src/app/(main)/dashboard/page.tsx"
      to: "src/lib/auth.ts"
      via: "auth.api.getSession for server-side session check"
      pattern: "auth\\.api\\.getSession"
    - from: "proxy.ts"
      to: "better-auth/cookies"
      via: "getSessionCookie for proxy-level protection"
      pattern: "getSessionCookie"
    - from: "src/components/layout/Header.tsx"
      to: "src/lib/auth-client.ts"
      via: "signOut() call in header dropdown"
      pattern: "signOut"
---

<objective>
Build the protected dashboard shell with welcome message, empty state sections, route protection (proxy + server-side), and logout — completing the full auth flow that proves AUTH-01 and AUTH-02 work end-to-end.

Purpose: This is the culmination of Phase 1 — the dashboard proves authentication works, the proxy protects routes, sessions persist, and the user sees a real product shell. The empty states are designed to be filled in by later phases (My Library from Phase 5, Recently Read from Phase 4).

Output: Protected /dashboard page with welcome greeting, empty My Library and Recently Read sections, proxy.ts for route protection, logout wired in header, and a human-verified full auth flow.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build dashboard page, empty states, proxy, and logout</name>
  <files>
    src/app/(main)/dashboard/page.tsx
    src/components/dashboard/WelcomeSection.tsx
    src/components/dashboard/EmptyLibrary.tsx
    src/components/dashboard/EmptyRecentlyRead.tsx
    proxy.ts
  </files>
  <action>
    1. Create `proxy.ts` at the PROJECT ROOT (not inside src/ — Next.js 16 requires this):
       ```typescript
       import { NextRequest, NextResponse } from "next/server";
       import { getSessionCookie } from "better-auth/cookies";

       export function proxy(request: NextRequest) {
         const sessionCookie = getSessionCookie(request);

         if (!sessionCookie) {
           return NextResponse.redirect(new URL("/sign-in", request.url));
         }
         return NextResponse.next();
       }

       export const config = {
         matcher: ["/dashboard/:path*"],
       };
       ```
       NOTE: This is `proxy.ts` with `export function proxy` — NOT `middleware.ts` with `export function middleware`. Next.js 16 renamed this. Edge runtime is NOT supported in proxy.

    2. Create `src/components/dashboard/WelcomeSection.tsx`:
       - Props: `userName` (string)
       - Heading (serif): "Welcome back, {userName}" (or "Welcome, {userName}" for first visit)
       - Subtext: "Here's your reading activity" in muted color
       - Current date formatted nicely (e.g., "Tuesday, February 18, 2026")
       - Clean, spacious layout with generous padding

    3. Create `src/components/dashboard/EmptyLibrary.tsx`:
       - Section heading (serif): "My Library"
       - Empty state: Centered illustration area (use a simple book icon — inline SVG), message "Your library is empty", description "Books you purchase will appear here", CTA button "Browse Catalog" (links to /catalog, primary variant)
       - Uses shadcn Card with subtle border, generous padding
       - Designed to be replaced with actual book grid when Phase 5 ships

    4. Create `src/components/dashboard/EmptyRecentlyRead.tsx`:
       - Section heading (serif): "Recently Read"
       - Empty state: Centered illustration area (use a simple reading/bookmark icon — inline SVG), message "Nothing read yet", description "Your reading history will appear here as you explore our collection"
       - Uses shadcn Card with subtle border, generous padding
       - Designed to be replaced with reading history when Phase 4 ships

    5. Create `src/app/(main)/dashboard/page.tsx`:
       - Server Component — performs server-side session check (defense in depth, CVE-2025-29927):
         ```typescript
         import { auth } from "@/lib/auth";
         import { headers } from "next/headers";
         import { redirect } from "next/navigation";

         export default async function DashboardPage() {
           const session = await auth.api.getSession({
             headers: await headers(),
           });
           if (!session) redirect("/sign-in");
           // render dashboard with session.user.name
         }
         ```
       - Render WelcomeSection with user's name
       - Two-column grid on desktop (single column on mobile):
         - Left/full: EmptyLibrary
         - Right/full: EmptyRecentlyRead
       - Page metadata: title "Dashboard — ScienceOne"
       - The layout uses the (main) route group, so Header and Footer wrap this page automatically

    6. Ensure logout works in the Header:
       - The Header component (from Plan 02) should already have a sign-out option in the user dropdown when logged in
       - Verify that clicking "Sign out" calls `signOut()` from auth-client, which clears the session
       - After sign-out, user should be redirected to "/" (landing page)
       - If the Header's sign-out wiring is incomplete, fix it now: `await signOut({ fetchOptions: { onSuccess: () => router.push("/") } })`

    7. Verify route protection:
       - Visit `/dashboard` while NOT logged in — should redirect to `/sign-in`
       - Log in — should be able to access `/dashboard`
       - Refresh the page — session should persist (still on dashboard, not redirected)
       - Close tab, reopen `/dashboard` — session should persist
  </action>
  <verify>
    - Visit `/dashboard` without auth — redirected to `/sign-in`
    - Log in via `/sign-in` — redirected to `/dashboard`
    - Dashboard shows "Welcome back, {name}" with user's name
    - "My Library" empty state visible with "Browse Catalog" CTA
    - "Recently Read" empty state visible with placeholder message
    - Refresh page — still on dashboard (session persists)
    - Click sign out in header — redirected to landing page, session cleared
    - `npx tsc --noEmit` — no TypeScript errors
  </verify>
  <done>
    Protected dashboard with server-side session check, welcome greeting, empty My Library and Recently Read sections, proxy.ts route protection, and working logout. Route protection uses defense-in-depth (proxy + server-side check).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete auth flow end-to-end</name>
  <files>N/A — verification only, no files modified</files>
  <action>
    Human verifies the complete Phase 1 authentication flow end-to-end.

    What was built: Complete Phase 1 authentication flow — project scaffold, database schema with all tables, sign-up with email+password, email verification, sign-in, Google OAuth, session persistence, protected dashboard, and logout.

    Prerequisites: PostgreSQL must be running and .env configured with DATABASE_URL. RESEND_API_KEY optional (email verification will fail silently without it, but sign-up flow can still be tested). GOOGLE_CLIENT_ID/SECRET optional (Google button will error without them).

    Start the dev server: `npm run dev`

    **Flow 1: Sign-up and Sign-in**
    1. Visit http://localhost:3000 — verify landing page with hero, features, header, footer
    2. Click "Get Started" in header or hero — should navigate to /sign-up
    3. Submit empty form — verify inline validation errors appear
    4. Fill in name, email, password — submit
    5. Should redirect to /verify-email page with instructions
    6. (If Resend configured: check email for verification link, click it)
    7. (If Resend NOT configured: manually verify the user in database: `UPDATE users SET "emailVerified" = true WHERE email = 'your@email.com'` via psql or Prisma Studio)
    8. Navigate to /sign-in, enter credentials — should redirect to /dashboard
    9. Dashboard shows "Welcome back, {your name}"
    10. Verify "My Library" and "Recently Read" empty states appear

    **Flow 2: Session Persistence**
    11. Refresh the page (Cmd+R) — still on dashboard with session intact
    12. Close the tab entirely, open a new tab, visit http://localhost:3000/dashboard — still logged in

    **Flow 3: Logout**
    13. Click user avatar/menu in header — click "Sign out"
    14. Should redirect to landing page
    15. Visit http://localhost:3000/dashboard — should redirect to /sign-in (no longer authenticated)

    **Flow 4: Visual Check**
    16. Verify academic aesthetic: serif headings (Lora), sans-serif body (Inter), navy/indigo accents, white backgrounds, generous whitespace
    17. Check mobile responsiveness: resize to 375px width — layout should adapt gracefully

    **Flow 5: Google OAuth (optional — only if GOOGLE_CLIENT_ID configured)**
    18. Click "Continue with Google" on sign-in page — should redirect to Google consent screen

    Resume signal: Type "approved" if the auth flow works end-to-end, or describe any issues found.
  </action>
  <verify>Human confirms all 5 flows pass. Type "approved" to continue or describe issues.</verify>
  <done>All auth flows verified by human: sign-up, sign-in, session persistence, logout, and visual aesthetic confirmed.</done>
</task>

</tasks>

<verification>
1. Sign-up -> verify email -> sign-in -> dashboard flow works end-to-end
2. Session persists across refresh and tab close/reopen
3. Logout clears session and redirects to landing page
4. Route protection: /dashboard redirects to /sign-in when not authenticated
5. Academic aesthetic visible across all pages
6. All TypeScript compiles: `npx tsc --noEmit`
7. Database has all tables: `npx prisma studio` shows User, Session, Book, Chapter, etc.
</verification>

<success_criteria>
- AUTH-01 satisfied: User can create an account with email and password
- AUTH-02 satisfied: User can log in and maintain a session across browser refresh
- User can log out from any page (via header)
- Protected routes redirect unauthenticated users
- Dashboard shell feels like a real product with empty states ready for future phases
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
