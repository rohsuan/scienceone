---
phase: 11-resource-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/ImageUploadField.tsx
  - src/components/admin/ResourceEditForm.tsx
  - src/components/admin/SubjectSelect.tsx
  - src/lib/resource-admin-actions.ts
  - .env.example
autonomous: true
requirements: [RES-01, RES-02]

must_haves:
  truths:
    - "ImageUploadField accepts a generic entityId + uploadType prop pair so both books and resources can use it correctly"
    - "Resource cover image uploads to R2 under images/resources/{id}/cover-{ts}.ext, not images/{id}/cover-{ts}.ext"
    - "Cover image stored as full public URL (NEXT_PUBLIC_R2_PUBLIC_URL + r2Key), not bare R2 key"
    - "SubjectSelect shows only the four fixed subjects as toggleable badges — no create-subject input or button"
    - "Admin can save a resource with subjects, type, level, description, and price without errors"
  artifacts:
    - path: "src/components/admin/ImageUploadField.tsx"
      provides: "Generic image upload supporting both bookId and resourceId via entityId + uploadType"
      contains: "uploadType"
    - path: "src/components/admin/ResourceEditForm.tsx"
      provides: "Resource edit form with correct ImageUploadField props"
      contains: "resource-cover"
    - path: "src/components/admin/SubjectSelect.tsx"
      provides: "Subject multi-select without create-subject UI"
    - path: ".env.example"
      provides: "NEXT_PUBLIC_R2_PUBLIC_URL env var documented"
      contains: "NEXT_PUBLIC_R2_PUBLIC_URL"
  key_links:
    - from: "src/components/admin/ResourceEditForm.tsx"
      to: "src/components/admin/ImageUploadField.tsx"
      via: "uploadType='resource-cover' prop"
      pattern: "uploadType.*resource-cover"
    - from: "src/components/admin/ImageUploadField.tsx"
      to: "/api/admin/upload-url"
      via: "fetch POST with type from uploadType prop"
      pattern: "type.*uploadType"
---

<objective>
Fix the resource cover image upload path, the R2 public URL storage issue, and remove the create-subject UI from SubjectSelect.

Purpose: The existing ResourceEditForm passes `bookId` and `type="cover"` to ImageUploadField, which causes cover images to upload under the wrong R2 key path. Additionally, bare R2 keys are stored instead of full public URLs, so images won't display. SubjectSelect has a create-subject UI that contradicts the Phase 10-01 decision to fix subjects at exactly four.

Output: ImageUploadField supports both books and resources via a generic prop, ResourceEditForm passes the correct upload type, cover images store full public URLs, and SubjectSelect is a clean multi-select without creation UI.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-resource-admin/11-RESEARCH.md
@src/components/admin/ImageUploadField.tsx
@src/components/admin/ResourceEditForm.tsx
@src/components/admin/BookEditForm.tsx
@src/components/admin/SubjectSelect.tsx
@src/lib/resource-admin-actions.ts
@src/app/api/admin/upload-url/route.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor ImageUploadField to support both books and resources, fix ResourceEditForm props, and store full public URL</name>
  <files>
    src/components/admin/ImageUploadField.tsx
    src/components/admin/ResourceEditForm.tsx
    src/components/admin/BookEditForm.tsx
    .env.example
  </files>
  <action>
    **1. Refactor ImageUploadField.tsx** to accept generic props instead of book-specific ones:

    Replace the interface:
    ```typescript
    interface ImageUploadFieldProps {
      label: string;
      currentUrl: string | null;
      onUpload: (url: string) => void;  // changed: receives full public URL, not r2Key
      entityId: string;      // was: bookId
      uploadType: "cover" | "author" | "resource-cover" | "blog-cover" | "blog-author";  // was: type: "cover" | "author"
    }
    ```

    Update the fetch body in `handleFileChange` to determine the correct prop name:
    ```typescript
    const isResource = uploadType === "resource-cover";
    const isBlog = uploadType === "blog-cover" || uploadType === "blog-author";
    const idField = isResource ? "resourceId" : isBlog ? "resourceId" : "bookId";
    // For blog uploads, the API also uses resourceId as the generic entity ID field
    // Actually, check the upload-url route: it reads `bookId` and `resourceId` from body
    // So for books: send bookId; for resources/blog: send resourceId
    body: JSON.stringify({
      [idField]: entityId,
      fileName: file.name,
      type: uploadType,
    }),
    ```

    After the upload succeeds (after XHR resolves), construct the full public URL:
    ```typescript
    const publicBaseUrl = process.env.NEXT_PUBLIC_R2_PUBLIC_URL;
    const fullUrl = publicBaseUrl ? `${publicBaseUrl}/${r2Key}` : r2Key;
    onUpload(fullUrl);
    ```

    This way if NEXT_PUBLIC_R2_PUBLIC_URL is set, images get full URLs. If not set (dev without public R2 bucket), it falls back to the bare key (which matches current behavior — images won't display but nothing breaks worse).

    **2. Update ResourceEditForm.tsx** (Content tab, ~line 206-214):

    Change the ImageUploadField call from:
    ```tsx
    <ImageUploadField
      label="Cover Image"
      currentUrl={field.value ?? null}
      bookId={resource.id}
      type="cover"
      onUpload={(r2Key) => setValue("coverImage", r2Key, { shouldDirty: true })}
    />
    ```
    to:
    ```tsx
    <ImageUploadField
      label="Cover Image"
      currentUrl={field.value ?? null}
      entityId={resource.id}
      uploadType="resource-cover"
      onUpload={(url) => setValue("coverImage", url, { shouldDirty: true })}
    />
    ```

    **3. Update BookEditForm.tsx** to use the new prop names:

    Find the two ImageUploadField usages (cover image ~line 190, author image ~line 240) and update:
    - `bookId={book.id}` → `entityId={book.id}`
    - `type="cover"` → `uploadType="cover"`
    - `type="author"` → `uploadType="author"`
    - `onUpload={(r2Key) => ...}` → `onUpload={(url) => ...}` (variable rename for clarity; logic unchanged since both old and new receive a string)

    **4. Add NEXT_PUBLIC_R2_PUBLIC_URL to .env.example**:

    Add after the R2_BUCKET_NAME line:
    ```
    NEXT_PUBLIC_R2_PUBLIC_URL=https://your-bucket.r2.dev
    ```

    Do NOT modify `.env` or `.env.local` — those are user secrets.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero errors. Verify that:
    1. ImageUploadField no longer has `bookId` or `type` in its interface — replaced by `entityId` and `uploadType`
    2. ResourceEditForm passes `uploadType="resource-cover"` and `entityId={resource.id}`
    3. BookEditForm passes `uploadType="cover"` / `uploadType="author"` and `entityId={book.id}`
    4. .env.example contains NEXT_PUBLIC_R2_PUBLIC_URL
  </verify>
  <done>
    ImageUploadField accepts entityId + uploadType (generic), ResourceEditForm sends type="resource-cover" so the API generates the correct R2 key path (images/resources/{id}/...), BookEditForm still works with the renamed props, and the uploaded URL includes the public base URL when NEXT_PUBLIC_R2_PUBLIC_URL is set.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove create-subject UI from SubjectSelect and clean up duplicate revalidatePath</name>
  <files>
    src/components/admin/SubjectSelect.tsx
    src/lib/resource-admin-actions.ts
  </files>
  <action>
    **1. Simplify SubjectSelect.tsx:**

    Remove all create-subject functionality. The component should be a clean multi-select showing the four fixed subjects as toggleable items.

    Remove:
    - The `newSubjectName` state
    - The `isCreating` state
    - The `createError` state
    - The `handleCreateSubject` function
    - The `import { createSubject } from "@/lib/resource-admin-actions"` import
    - The entire "create subject" `<div className="flex gap-2">` block containing the Input and "Add" Button
    - The `{createError && ...}` error display
    - The `subjects` local state (`useState<Subject[]>(initialSubjects)`) — just use `initialSubjects` directly renamed to `subjects` in the destructured props (no need for local state since subjects don't change)

    Keep:
    - The `toggleSubject` function
    - The selected badges display (top section with × badges)
    - The scrollable list of all subjects with highlight on selected
    - The `SubjectSelectProps` interface (unchanged)
    - The "No subjects yet" empty state text — but change it to "No subjects available." since the admin can't create new ones

    The resulting component should be approximately 50-60 lines.

    **2. Remove duplicate revalidatePath in resource-admin-actions.ts:**

    In the `updateResource` function, there is no literal duplicate (the research mentioned one, but current code at lines 107-108 has `revalidatePath("/admin/resources")` and `revalidatePath("/admin/resources/${resourceId}")` which are different paths). If there IS a duplicate, remove it. If not, skip this sub-task.

    **3. Remove the `createSubject` export from resource-admin-actions.ts:**

    Since SubjectSelect no longer calls `createSubject`, remove the `createSubject` function from `resource-admin-actions.ts` to eliminate dead code. This keeps the module clean — subjects are seeded, not created at runtime.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero errors. Verify that:
    1. SubjectSelect.tsx has no Input, no "Add" Button, no `createSubject` import, no `newSubjectName` state
    2. `createSubject` function is removed from resource-admin-actions.ts
    3. SubjectSelect still renders the scrollable subject list and badge-based selection
  </verify>
  <done>
    SubjectSelect is a clean multi-select with no creation UI (honoring Phase 10-01 decision of fixed subjects). The dead `createSubject` server action is removed. No TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. ImageUploadField interface uses `entityId` + `uploadType` (not `bookId` + `type`)
3. ResourceEditForm passes `uploadType="resource-cover"` to ImageUploadField
4. BookEditForm passes `uploadType="cover"` and `uploadType="author"` to ImageUploadField
5. SubjectSelect has no create-subject UI (no Input, no "Add" button, no createSubject import)
6. `createSubject` function removed from resource-admin-actions.ts
7. .env.example contains `NEXT_PUBLIC_R2_PUBLIC_URL`
</verification>

<success_criteria>
- Resource cover images will upload to the correct R2 path (`images/resources/{id}/cover-{ts}.ext`)
- Cover image URL stored in form includes the public R2 base URL when configured
- SubjectSelect only shows the four fixed subjects with no creation capability
- All TypeScript compilation passes cleanly
- BookEditForm continues to work with the refactored ImageUploadField props
</success_criteria>

<output>
After completion, create `.planning/phases/11-resource-admin/11-01-SUMMARY.md`
</output>
