---
phase: 07-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - proxy.ts
  - src/app/(admin)/layout.tsx
  - src/app/(admin)/admin/page.tsx
  - src/lib/admin-queries.ts
  - src/lib/admin-actions.ts
  - src/components/admin/BookTable.tsx
  - src/components/admin/BookTableColumns.tsx
  - src/components/admin/AdminSidebar.tsx
autonomous: true
requirements: [ADM-06, ADM-04]

must_haves:
  truths:
    - "Admin user can navigate to /admin and see a data table of all books (published and unpublished)"
    - "Book table shows columns: title, status (Draft/Published), access model (Open/Paid), formats (PDF/EPUB badges), updated date, and action links"
    - "Admin can sort the table by title and updated date"
    - "Admin can toggle a book between published and unpublished from the table row actions"
    - "Admin can create a new book with title, slug, and author name; new books start as drafts"
    - "Non-admin users are redirected away from /admin routes"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "IngestJob model for pipeline status tracking"
      contains: "model IngestJob"
    - path: "src/app/(admin)/layout.tsx"
      provides: "Admin layout with auth guard and sidebar"
      min_lines: 15
    - path: "src/app/(admin)/admin/page.tsx"
      provides: "Book list page with data table"
      min_lines: 15
    - path: "src/lib/admin-queries.ts"
      provides: "Admin-specific Prisma queries (no isPublished filter)"
      exports: ["getAllBooksAdmin"]
    - path: "src/components/admin/BookTable.tsx"
      provides: "TanStack Table client component"
      min_lines: 30
  key_links:
    - from: "src/app/(admin)/admin/page.tsx"
      to: "src/lib/admin-queries.ts"
      via: "getAllBooksAdmin() server component fetch"
      pattern: "getAllBooksAdmin"
    - from: "src/components/admin/BookTable.tsx"
      to: "src/components/admin/BookTableColumns.tsx"
      via: "columns import"
      pattern: "import.*columns.*BookTableColumns"
    - from: "proxy.ts"
      to: "/admin/:path*"
      via: "matcher config"
      pattern: "admin.*path"
---

<objective>
Set up the admin dashboard foundation and book list data table.

Purpose: Establish the admin route group with auth protection, install all dependencies needed for the admin dashboard phase, add the IngestJob model to the schema, and build the book list data table with publish/unpublish toggle and create-book flow. This plan delivers the primary admin surface — the book management table.

Output: Working /admin page with sortable book data table, create book dialog, publish toggle, and admin-only route protection.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-dashboard/07-RESEARCH.md
@prisma/schema.prisma
@proxy.ts
@src/lib/auth.ts
@src/lib/r2.ts
@src/app/(auth)/layout.tsx
@src/app/(main)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add IngestJob model, create admin layout and route protection</name>
  <files>
    prisma/schema.prisma
    proxy.ts
    src/app/(admin)/layout.tsx
    src/components/admin/AdminSidebar.tsx
  </files>
  <action>
    **1. Install packages:**
    ```bash
    npm install @tanstack/react-table react-dropzone
    npx shadcn@canary add table dialog alert-dialog textarea select switch badge progress tabs skeleton separator
    ```
    Note: react-hook-form, @hookform/resolvers, and zod are already installed. shadcn canary CLI is required for Tailwind v4.

    **2. Add IngestJob model to prisma/schema.prisma:**
    Add after the Download model:
    ```prisma
    model IngestJob {
      id        String   @id @default(cuid())
      bookId    String
      book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
      r2Key     String
      status    String   @default("pending")   // pending | processing | success | error
      progress  String?                         // JSON: { step: string, pct: number }
      error     String?  @db.Text
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt

      @@map("ingest_jobs")
    }
    ```
    Add `ingestJobs IngestJob[]` relation to the Book model.

    Run migration with `--create-only` (DB offline per existing blocker):
    ```bash
    npx prisma migrate dev --name add_ingest_job --create-only
    npx prisma generate
    ```

    **3. Extend proxy.ts:**
    Add `/admin/:path*` to the matcher array alongside the existing `/dashboard/:path*`. The proxy only checks cookie presence — role check happens in layout.

    **4. Create (admin) route group layout at src/app/(admin)/layout.tsx:**
    - Server component that checks `session.user.role === "admin"` via `auth.api.getSession({ headers: await headers() })`
    - If not admin, redirect to "/"
    - Renders a flex layout: `<AdminSidebar />` on the left + `<main className="flex-1 p-6">{children}</main>` on the right
    - Follow the same pattern as (auth)/layout.tsx for isolation — no Header/Footer from (main) layout

    **5. Create AdminSidebar at src/components/admin/AdminSidebar.tsx:**
    - Server component (no client interactivity needed)
    - Compact left sidebar (w-64, border-r, p-4)
    - Links: "Books" → /admin (active state), "Create Book" → triggers dialog or navigates
    - ScienceOne heading at top with "Admin" badge
    - Link to "Back to Site" at bottom (→ /)
  </action>
  <verify>
    - `npx prisma generate` completes without error
    - `npx tsc --noEmit` passes (TypeScript compiles)
    - proxy.ts matcher includes both "/dashboard/:path*" and "/admin/:path*"
    - (admin)/layout.tsx imports auth and checks role === "admin"
  </verify>
  <done>
    IngestJob model exists in schema with migration. Admin layout renders with sidebar and redirects non-admin users. proxy.ts protects /admin routes. All dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build book data table with create book dialog and publish toggle</name>
  <files>
    src/app/(admin)/admin/page.tsx
    src/lib/admin-queries.ts
    src/lib/admin-actions.ts
    src/components/admin/BookTable.tsx
    src/components/admin/BookTableColumns.tsx
  </files>
  <action>
    **1. Create src/lib/admin-queries.ts:**
    ```typescript
    export async function getAllBooksAdmin() {
      return prisma.book.findMany({
        orderBy: { updatedAt: "desc" },
        include: {
          categories: { include: { category: true } },
          pricing: true,
          _count: { select: { chapters: true } },
        },
      });
    }
    export type BookAdminRow = Awaited<ReturnType<typeof getAllBooksAdmin>>[number];
    ```
    No `isPublished` filter — admin sees all books (locked decision: data table for book list).

    **2. Create src/lib/admin-actions.ts:**
    - `"use server"` directive
    - Auth guard in every action: `const session = await auth.api.getSession({ headers: await headers() }); if (!session || session.user.role !== "admin") redirect("/");`
    - `togglePublish(bookId: string, publish: boolean)`: Updates `isPublished`, revalidates `/admin` and `/catalog`
    - `createBook(data: { title: string; slug: string; authorName: string })`: Creates book record with `isPublished: false` (draft), revalidates `/admin`, returns the new book ID
    - `deleteBook(bookId: string)`: Deletes book record, revalidates `/admin` and `/catalog`

    **3. Create src/components/admin/BookTableColumns.tsx:**
    Column definitions using `ColumnDef<BookAdminRow>[]`:
    - **Title**: sortable header with ArrowUpDown icon, cell links to `/admin/books/${row.original.id}`
    - **Status**: Badge — "Published" (default variant) or "Draft" (secondary variant), based on `isPublished`
    - **Access**: "Open" or "Paid" based on `isOpenAccess`
    - **Formats**: Badge for PDF (if pdfKey), Badge for EPUB (if epubKey) — use outline variant
    - **Chapters**: chapter count from `_count.chapters`
    - **Updated**: formatted date from `updatedAt`
    - **Actions**: DropdownMenu with "Edit" (→ /admin/books/[id]), "Toggle Publish" (calls togglePublish server action), "Delete" (with alert-dialog confirmation)

    **4. Create src/components/admin/BookTable.tsx:**
    - `"use client"` component
    - Uses `useReactTable` with `getCoreRowModel`, `getSortedRowModel`
    - State: `SortingState`
    - Renders using shadcn Table/TableHeader/TableBody/TableRow/TableCell primitives
    - Empty state: "No books yet. Create your first book to get started."

    **5. Create src/app/(admin)/admin/page.tsx:**
    - Server component
    - Defense-in-depth: check admin role again (same pattern as layout)
    - Calls `getAllBooksAdmin()` and passes data to `<BookTable />`
    - Page heading "Books" with "Create Book" button that opens a Dialog
    - The Dialog contains a simple form: title (Input), slug (Input, auto-generated from title), author name (Input), and a Create button
    - On create, calls `createBook` server action, closes dialog, optionally navigates to the new book's edit page
    - Use `useTransition` for the create action to prevent double-submit (same pattern as Phase 5 checkout)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` succeeds (or at minimum `npx next build` does not error on the admin routes)
    - BookTableColumns defines at least 6 columns (title, status, access, formats, updated, actions)
    - admin/page.tsx imports getAllBooksAdmin and passes data to BookTable
  </verify>
  <done>
    /admin page renders a sortable data table of all books. Founder can create a new book via dialog. Founder can toggle publish/unpublish and delete books from row actions. Table shows title, status, access model, formats, chapter count, and updated date.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin as an admin user — should see book data table with all books (including unpublished)
2. Navigate to /admin as a non-admin user — should redirect to /
3. Visit /admin without being logged in — should redirect to /sign-in (via proxy.ts)
4. Create a new book via the dialog — book appears in the table as "Draft"
5. Toggle publish on a book — status badge updates
6. Table columns are sortable by title and updated date
7. Delete a book via actions dropdown — confirmation dialog appears, book removed after confirmation
</verification>

<success_criteria>
- Admin data table shows all books with correct column data
- Create book produces a new draft book
- Publish toggle works and revalidates both admin and public catalog
- Non-admin access is blocked at both proxy and layout level
- IngestJob model exists in schema for use by later plans
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-dashboard/07-01-SUMMARY.md`
</output>
