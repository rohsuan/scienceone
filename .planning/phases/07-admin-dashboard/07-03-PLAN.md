---
phase: 07-admin-dashboard
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/app/(admin)/admin/books/[bookId]/ingest/page.tsx
  - src/components/admin/IngestUploader.tsx
  - src/components/admin/IngestStatus.tsx
  - src/components/admin/useIngestStatus.ts
  - src/app/api/admin/ingest/upload-url/route.ts
  - src/app/api/admin/ingest-start/route.ts
  - src/app/api/admin/ingest/[jobId]/route.ts
  - scripts/ingest.ts
  - scripts/lib/db-write.ts
  - src/app/(admin)/admin/books/[bookId]/preview/page.tsx
  - src/app/(admin)/admin/books/[bookId]/preview/[chapterSlug]/page.tsx
  - src/lib/admin-queries.ts
autonomous: true
requirements: [ADM-05, ADM-06]

must_haves:
  truths:
    - "Founder can upload a manuscript file from the browser and see it upload to R2 with progress"
    - "After upload, founder can trigger the ingest pipeline and see status updates (processing, success, error)"
    - "Ingest pipeline spawns as a detached process and updates IngestJob status in the database"
    - "Founder can re-ingest a book with a new manuscript (confirmation dialog before replacing)"
    - "Founder can preview chapters of any book (including unpublished) from the admin dashboard"
    - "Error details from the ingest health report are visible in the UI when ingest fails"
  artifacts:
    - path: "src/app/(admin)/admin/books/[bookId]/ingest/page.tsx"
      provides: "Ingest management page with upload and status"
      min_lines: 15
    - path: "src/components/admin/IngestUploader.tsx"
      provides: "Drag-and-drop file upload with R2 presigned URL + progress"
      min_lines: 40
    - path: "src/app/api/admin/ingest-start/route.ts"
      provides: "API route that spawns ingest pipeline as detached child process"
      exports: ["POST"]
    - path: "scripts/ingest.ts"
      provides: "Extended ingest CLI with --r2-key and --job-id flags"
      min_lines: 100
    - path: "src/app/(admin)/admin/books/[bookId]/preview/[chapterSlug]/page.tsx"
      provides: "Admin preview of chapter content without isPublished filter"
      min_lines: 15
  key_links:
    - from: "src/components/admin/IngestUploader.tsx"
      to: "src/app/api/admin/ingest/upload-url/route.ts"
      via: "POST fetch for presigned upload URL"
      pattern: "ingest/upload-url"
    - from: "src/components/admin/IngestUploader.tsx"
      to: "src/app/api/admin/ingest-start/route.ts"
      via: "POST fetch to trigger pipeline after R2 upload"
      pattern: "ingest-start"
    - from: "src/components/admin/useIngestStatus.ts"
      to: "src/app/api/admin/ingest/[jobId]/route.ts"
      via: "2-second polling interval fetch"
      pattern: "ingest.*jobId"
    - from: "src/app/api/admin/ingest-start/route.ts"
      to: "scripts/ingest.ts"
      via: "child_process.spawn with --r2-key and --job-id flags"
      pattern: "spawn.*ingest"
---

<objective>
Build the manuscript upload, ingest pipeline integration, status polling, and admin preview functionality.

Purpose: Enable the founder to upload manuscripts from the browser, trigger the ingest pipeline, monitor its progress, view errors, and preview the ingested content — all without touching the command line. This completes the browser-based book management workflow.

Output: Working /admin/books/[bookId]/ingest page with drag-and-drop upload, pipeline status polling, and /admin/books/[bookId]/preview for chapter preview.
</objective>

<execution_context>
@/Users/roh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/roh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-admin-dashboard/07-RESEARCH.md
@.planning/phases/07-admin-dashboard/07-01-SUMMARY.md
@scripts/ingest.ts
@scripts/lib/db-write.ts
@scripts/lib/health-report.ts
@src/lib/r2.ts
@src/lib/admin-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ingest API routes, extend ingest script, and build upload + status components</name>
  <files>
    src/app/api/admin/ingest/upload-url/route.ts
    src/app/api/admin/ingest-start/route.ts
    src/app/api/admin/ingest/[jobId]/route.ts
    scripts/ingest.ts
    scripts/lib/db-write.ts
    src/components/admin/useIngestStatus.ts
    src/components/admin/IngestUploader.tsx
    src/components/admin/IngestStatus.tsx
  </files>
  <action>
    **1. Create src/app/api/admin/ingest/upload-url/route.ts:**
    - POST handler with admin role check
    - Accepts JSON: `{ bookId: string, fileName: string, contentType: string }`
    - Generates R2 key: `uploads/manuscripts/${bookId}/${Date.now()}-${fileName}`
    - Uses PutObjectCommand + getSignedUrl with createR2Client() — expiresIn: 3600
    - Returns `{ uploadUrl, r2Key }`

    **2. Create src/app/api/admin/ingest-start/route.ts:**
    - POST handler with admin role check
    - Accepts JSON: `{ bookId: string, r2Key: string }`
    - Creates IngestJob record with status "pending"
    - Spawns detached child process:
      ```typescript
      import { spawn } from "child_process";
      const proc = spawn(
        "npx",
        ["tsx", "scripts/ingest.ts", "--book-id", bookId, "--r2-key", r2Key, "--job-id", job.id],
        { detached: true, stdio: "ignore", cwd: process.cwd() }
      );
      proc.unref();
      ```
    - Updates IngestJob status to "processing"
    - Returns `{ jobId: job.id }`
    - IMPORTANT: The spawn uses `npx tsx` because the project uses tsx for TypeScript scripts (see existing scripts/ingest.ts shebang)

    **3. Create src/app/api/admin/ingest/[jobId]/route.ts:**
    - GET handler with admin role check
    - Reads IngestJob by ID from Prisma
    - Returns `{ status, progress, error, updatedAt }`
    - If job not found, return 404

    **4. Extend scripts/lib/db-write.ts:**
    Add function:
    ```typescript
    export async function updateIngestJob(
      jobId: string,
      status: string,
      progress?: string | null,
      error?: string | null,
    ): Promise<void> {
      await prisma.ingestJob.update({
        where: { id: jobId },
        data: { status, ...(progress !== undefined && { progress }), ...(error !== undefined && { error }) },
      });
    }
    ```

    **5. Extend scripts/ingest.ts:**
    Add two new optional flags: `--r2-key <key>` and `--job-id <id>`. When `--r2-key` is provided (instead of `--input`):
    - Make `--input` optional (currently requiredOption — change to option with conditional validation)
    - Download the manuscript from R2 to a temp file using `os.tmpdir()` + `crypto.randomUUID()` for the path
    - Use GetObjectCommand from @aws-sdk/client-s3 with createR2Client from scripts/lib/r2-upload.ts (which already has the R2 client creation logic — or import createR2Client from src/lib/r2.ts since scripts already import from src/lib/prisma via scripts/lib/db-write.ts)
    - Set `inputFile` to the temp path and continue the existing pipeline
    - Clean up temp file in a `finally` block
    - When `--job-id` is provided:
      - Import updateIngestJob from scripts/lib/db-write.ts
      - Wrap the entire `run()` function in try/catch
      - At each pipeline step completion, call `updateIngestJob(jobId, "processing", JSON.stringify({ step: stepName, pct }))`
      - Steps with progress percentages: html_convert (10%), math_render (25%), chapter_split (40%), health_report (50%), pdf_generate (70%), epub_generate (85%), r2_upload (95%), db_write (100%)
      - On success: `updateIngestJob(jobId, "success", JSON.stringify({ step: "complete", pct: 100 }))`
      - On error: `updateIngestJob(jobId, "error", null, errorMessage)` — include the health report JSON if it's a health report halt
      - CRITICAL: The try/catch must cover ALL error paths. If the process crashes without writing "error" status, the job is stuck forever (Pitfall 1 from research).

    **6. Create src/components/admin/useIngestStatus.ts:**
    - `"use client"` hook
    - Polls GET /api/admin/ingest/[jobId] every 2 seconds
    - Returns `{ status, progress, error }` where progress is parsed JSON `{ step: string, pct: number }`
    - Stops polling when status is "success" or "error"
    - Returns null status when jobId is null

    **7. Create src/components/admin/IngestStatus.tsx:**
    - `"use client"` component
    - Props: `{ jobId: string }`
    - Uses useIngestStatus hook
    - Displays: current step name, Progress bar with percentage, status badge
    - On success: green checkmark, "Ingest complete" message, link to preview
    - On error: red alert with error message/health report details displayed inline
    - While processing: animated spinner next to step name

    **8. Create src/components/admin/IngestUploader.tsx:**
    - `"use client"` component
    - Props: `{ bookId: string, hasExistingChapters: boolean }`
    - Uses react-dropzone for drag-and-drop area
    - Accept: `.tex, .docx, .md, .markdown` files (single file only)
    - Flow:
      1. User drops/selects file
      2. If `hasExistingChapters`, show AlertDialog: "Re-ingesting will replace all existing chapters and artifacts. Continue?"
      3. POST to /api/admin/ingest/upload-url to get presigned URL
      4. Upload via XHR with progress tracking (same pattern as ImageUploadField)
      5. POST to /api/admin/ingest-start with bookId and r2Key
      6. Show IngestStatus with returned jobId
    - States: idle → uploading (with progress bar) → processing (shows IngestStatus) → complete/error
    - Dropzone UI: dashed border, icon, "Drag manuscript here or click to browse" text
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - scripts/ingest.ts accepts --r2-key and --job-id flags alongside existing --input flag
    - All three API routes check admin role
    - IngestUploader renders react-dropzone area
    - useIngestStatus polls every 2 seconds and stops on terminal status
  </verify>
  <done>
    Full ingest flow works end-to-end: upload manuscript to R2, trigger pipeline, poll status, display progress. Ingest script updates job status at each step. Re-ingest has confirmation dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ingest page and admin preview route for unpublished book chapters</name>
  <files>
    src/app/(admin)/admin/books/[bookId]/ingest/page.tsx
    src/app/(admin)/admin/books/[bookId]/preview/page.tsx
    src/app/(admin)/admin/books/[bookId]/preview/[chapterSlug]/page.tsx
    src/lib/admin-queries.ts
  </files>
  <action>
    **1. Add admin preview queries to src/lib/admin-queries.ts:**
    ```typescript
    export async function getBookChaptersAdmin(bookId: string) {
      return prisma.book.findUnique({
        where: { id: bookId },
        select: {
          id: true,
          title: true,
          slug: true,
          chapters: {
            orderBy: { position: "asc" },
            select: { id: true, title: true, slug: true, position: true },
          },
        },
      });
    }

    export async function getChapterAdmin(bookId: string, chapterSlug: string) {
      return prisma.chapter.findFirst({
        where: { slug: chapterSlug, bookId },
        include: {
          book: { select: { id: true, title: true, slug: true } },
        },
      });
    }

    export async function getLatestIngestJob(bookId: string) {
      return prisma.ingestJob.findFirst({
        where: { bookId },
        orderBy: { createdAt: "desc" },
      });
    }
    ```

    **2. Create src/app/(admin)/admin/books/[bookId]/ingest/page.tsx:**
    - Server component with admin role check
    - Reads bookId from params
    - Calls getBookAdmin(bookId) for book data and getLatestIngestJob(bookId) for last ingest status
    - Heading: "Ingest — {book.title}" with breadcrumb back to book edit page
    - Renders IngestUploader component with `hasExistingChapters={book._count.chapters > 0}`
    - If a recent ingest job exists and is still processing, shows IngestStatus with that jobId on page load
    - Shows ingest history summary: last ingest date, status, chapter count

    **3. Create src/app/(admin)/admin/books/[bookId]/preview/page.tsx:**
    - Server component with admin role check
    - Calls getBookChaptersAdmin(bookId)
    - If book has no chapters, show message "No chapters available. Upload and ingest a manuscript first." with link to ingest page
    - If chapters exist, redirect to first chapter: `/admin/books/${bookId}/preview/${chapters[0].slug}`

    **4. Create src/app/(admin)/admin/books/[bookId]/preview/[chapterSlug]/page.tsx:**
    - Server component with admin role check
    - Calls getChapterAdmin(bookId, chapterSlug) — NO isPublished filter (this is the admin preview)
    - If chapter not found, redirect back to preview page
    - Renders chapter content via `dangerouslySetInnerHTML={{ __html: chapter.content }}` — same trusted content pattern as public reader (Phase 3/4 decision)
    - Wraps content in `prose prose-lg max-w-3xl mx-auto` for typography (same as reader)
    - Adds KaTeX overflow CSS handling (same as reader: `[&_.katex-display] { overflow-x: auto; }`)
    - Shows chapter title at top, book title with "Preview" badge
    - Chapter navigation: prev/next links to adjacent chapters within the same admin preview route
    - List of all chapters in a sidebar or dropdown for quick navigation
    - Banner at top: "Admin Preview — this book is not published" (warning style) if book is not published
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Ingest page loads with IngestUploader component
    - Preview page redirects to first chapter
    - Preview chapter page renders content with dangerouslySetInnerHTML
    - Preview queries have NO isPublished filter (admin can preview unpublished)
    - Non-admin access to preview/ingest routes redirected (layout guard)
  </verify>
  <done>
    Ingest page provides full upload and status management. Admin preview works for all books regardless of publish status. Chapter content renders with proper typography and KaTeX math display. Navigation between preview chapters works.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/books/[bookId]/ingest — see drag-and-drop upload area
2. Upload a manuscript file — see upload progress bar fill to 100%
3. After upload completes — ingest pipeline starts automatically, status shows step-by-step progress
4. On ingest success — "Ingest complete" shows with link to preview
5. Navigate to /admin/books/[bookId]/preview — redirects to first chapter
6. Preview renders chapter HTML with LaTeX math correctly displayed
7. Navigate between preview chapters — prev/next links work
8. For an unpublished book — preview still works (no isPublished filter)
9. Re-ingest on a book with chapters — confirmation dialog appears before proceeding
10. On ingest error — error details display inline with health report information
</verification>

<success_criteria>
- ADM-05: Admin can preview ingested content before publishing (admin preview route renders all chapters without isPublished filter)
- ADM-06: Upload + ingest pipeline fully browser-based (no CLI needed); status polling shows pipeline progress; error details visible
- Ingest script extended with --r2-key (downloads from R2) and --job-id (writes status to IngestJob)
- Re-ingest supported with confirmation dialog
</success_criteria>

<output>
After completion, create `.planning/phases/07-admin-dashboard/07-03-SUMMARY.md`
</output>
